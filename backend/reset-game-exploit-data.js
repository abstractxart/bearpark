require('dotenv').config({ path: '../.env' });
const { createClient } = require('@supabase/supabase-js');

// Initialize Supabase
const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_ANON_KEY
);

async function resetExploitedData() {
  console.log('ğŸ”§ Resetting exploited game data...');
  console.log('');

  try {
    // Step 1: Clear daily_game_plays table (where the exploit occurred)
    console.log('ğŸ“Š Clearing daily_game_plays table...');
    const { error: dailyError } = await supabase
      .from('daily_game_plays')
      .delete()
      .neq('wallet_address', ''); // Delete all records

    if (dailyError) {
      console.error('âŒ Error clearing daily_game_plays:', dailyError);
      process.exit(1);
    }
    console.log('âœ… Cleared daily_game_plays table');

    // Step 2: Clear honey_points table (contains exploited points)
    console.log('ğŸ“Š Clearing honey_points table...');
    const { error: pointsError } = await supabase
      .from('honey_points')
      .delete()
      .neq('wallet_address', ''); // Delete all records

    if (pointsError) {
      console.error('âŒ Error clearing honey_points:', pointsError);
      process.exit(1);
    }
    console.log('âœ… Cleared honey_points table');

    console.log('');
    console.log('âœ… Successfully reset all exploited data!');
    console.log('');
    console.log('ğŸ“ IMPORTANT NEXT STEPS:');
    console.log('1. Run the SQL function in Supabase SQL Editor:');
    console.log('   â†’ Open Supabase Dashboard');
    console.log('   â†’ Go to SQL Editor');
    console.log('   â†’ Copy contents of backend/supabase-honey-points-setup.sql');
    console.log('   â†’ Run the SQL (this creates the atomic_increment_game_play function)');
    console.log('');
    console.log('2. Restart the backend server:');
    console.log('   â†’ pm2 restart BEARpark-backend');
    console.log('');
    console.log('3. Test the fix by rapidly playing games to ensure counter stops at 5/5');
    console.log('');

  } catch (err) {
    console.error('âŒ Error:', err);
    process.exit(1);
  }
}

resetExploitedData();
