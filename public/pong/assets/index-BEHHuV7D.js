import{r as D,g as H}from"./phaser-0YPJO2g1.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function e(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(o){if(o.ep)return;o.ep=!0;const n=e(o);fetch(o.href,n)}})();var _=D();const g=H(_);class N{ws=null;serverUrl;messageHandlers=new Map;reconnectAttempts=0;maxReconnectAttempts=5;reconnectDelay=2e3;playerData=null;constructor(t){this.serverUrl=t}connect(){return new Promise((t,e)=>{console.log(`üîå Connecting to Pong server: ${this.serverUrl}`);try{this.ws=new WebSocket(this.serverUrl),this.ws.onopen=()=>{console.log("‚úÖ Connected to Pong server"),this.reconnectAttempts=0,t()},this.ws.onmessage=s=>{try{const o=JSON.parse(s.data);this.handleServerMessage(o)}catch(o){console.error("‚ùå Error parsing server message:",o)}},this.ws.onclose=()=>{console.log("üîå Disconnected from Pong server"),this.attemptReconnect()},this.ws.onerror=s=>{console.error("‚ùå WebSocket error:",s),e(s)}}catch(s){console.error("‚ùå Failed to create WebSocket:",s),e(s)}})}attemptReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){console.log("‚ùå Max reconnect attempts reached"),this.emit("connection_failed",null);return}this.reconnectAttempts++,console.log(`üîÑ Reconnecting... (attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts})`),setTimeout(()=>{this.connect().catch(()=>{})},this.reconnectDelay*this.reconnectAttempts)}handleServerMessage(t){switch(console.log("üì® Received:",t.type,t),t.type){case"queue_joined":this.emit("queue_joined",t.position);break;case"match_found":this.emit("match_found",{opponent:t.opponent,yourSide:t.yourSide});break;case"countdown":this.emit("countdown",t.count);break;case"game_state":this.emit("game_state",t.state);break;case"game_over":this.emit("game_over",{winner:t.winner,finalScore:t.finalScore});break;case"opponent_disconnected":this.emit("opponent_disconnected",null);break;case"rematch_requested":this.emit("rematch_requested",null);break;case"rematch_accepted":this.emit("rematch_accepted",null);break;case"error":this.emit("error",t.message);break;case"opponent_bet_set":this.emit("opponent_bet_set",t);break;case"opponent_ready":this.emit("opponent_ready",null);break;case"final_bet_amount":this.emit("final_bet_amount",t);break;case"betting_timeout":this.emit("betting_timeout",null);break;case"powerups_refreshed":this.emit("powerups_refreshed",null);break;default:console.log("‚ö†Ô∏è Unknown message type:",t.type)}}on(t,e){this.messageHandlers.set(t,e)}off(t){this.messageHandlers.delete(t)}emit(t,e){const s=this.messageHandlers.get(t);s&&s(e)}send(t){this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify(t)):console.error("‚ùå Cannot send message - WebSocket not connected")}joinQueue(t){console.log("üéØ Joining matchmaking queue..."),this.playerData=t,this.send({type:"join_queue",data:t})}getPlayerData(){return this.playerData}movePaddle(t){this.send({type:"paddle_move",y:t,timestamp:Date.now()})}ready(){this.send({type:"ready"})}requestRematch(){this.send({type:"rematch"})}leave(){this.send({type:"leave"})}disconnect(){this.ws&&(this.ws.close(),this.ws=null)}isConnected(){return this.ws!==null&&this.ws.readyState===WebSocket.OPEN}}const I="https://www.bearpark.xyz/api",O="bear-pong";class E{static getWalletAddress(){return localStorage.getItem("xaman_wallet_address")}static getDisplayName(){return localStorage.getItem("display_name")||"Anonymous"}static getAvatarUrl(){return localStorage.getItem("avatar_url")}static getCurrentUserDisplayName(){const t=localStorage.getItem("display_name");if(t&&t.trim()!=="")return t;const e=localStorage.getItem("twitter_username");if(e&&e.trim()!=="")return e;const s=this.getWalletAddress();return s?this.formatWalletAddress(s):"Anonymous"}static isAuthenticated(){return!!this.getWalletAddress()}static async submitWin(t={}){const e=this.getWalletAddress();if(!e)return console.log("‚ÑπÔ∏è Win not submitted - user not authenticated"),{success:!1,error:"Not authenticated",message:"Connect your wallet at bearpark.xyz to save stats!"};let s=0,o=0;try{const n=await this.getMyStats();if(n)s=n.wins||n.score||0,o=n.losses||0,console.log(`üìä [SUBMIT WIN] Current database stats: ${s}W ${o}L`);else{const i=this.getLocalStats();s=i.wins,o=i.losses,console.log(`üìä [SUBMIT WIN] No database stats - using localStorage: ${s}W ${o}L`)}}catch(n){console.error("‚ùå Error fetching database stats, using localStorage:",n);const i=this.getLocalStats();s=i.wins,o=i.losses}s++,this.saveLocalStats({wins:s,losses:o,totalGames:s+o,winRate:s/(s+o)});try{const n=s+o,i=n>0?s/n:0,a={wallet_address:e,game_id:O,score:s,wins:s,losses:o,win_rate:i,metadata:{...t,wins:s,losses:o,total_games:n,win_rate:i,timestamp:new Date().toISOString(),display_name:this.getDisplayName(),result:"win"}};console.log("üì§ Submitting win to BEAR Park API...");const l=await(await fetch(`${I}/leaderboard`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).json();if(l.success){console.log("‚úÖ Win submitted to BEAR Park"),console.log("üîç [WIN VERIFY] Waiting 1 second, then verifying database update..."),await new Promise(d=>setTimeout(d,1e3));const c=await this.getMyStats();if(c){const d=c.wins||c.score||0,h=c.losses||0;console.log(`üîç [WIN VERIFY] Database shows: ${d}W ${h}L`),console.log(`üîç [WIN VERIFY] Expected: ${s}W ${o}L`),d===s&&h===o?console.log("‚úÖ [WIN VERIFY] Database update confirmed!"):(console.error("‚ùå [WIN VERIFY] Database does NOT match! Syncing localStorage from database..."),this.saveLocalStats({wins:d,losses:h,totalGames:d+h,winRate:d/(d+h)}))}}return l}catch(n){return console.error("‚ùå Error submitting win to BEAR Park:",n),{success:!1,error:n instanceof Error?n.message:"Unknown error"}}}static async submitLoss(t={}){const e=this.getWalletAddress();if(!e)return console.log("‚ÑπÔ∏è Loss not submitted - user not authenticated"),{success:!1,error:"Not authenticated",message:"Connect your wallet at bearpark.xyz to save stats!"};let s=0,o=0;try{const n=await this.getMyStats();if(n)s=n.wins||n.score||0,o=n.losses||0,console.log(`üìä [SUBMIT LOSS] Current database stats: ${s}W ${o}L`);else{const i=this.getLocalStats();s=i.wins,o=i.losses,console.log(`üìä [SUBMIT LOSS] No database stats - using localStorage: ${s}W ${o}L`)}}catch(n){console.error("‚ùå Error fetching database stats, using localStorage:",n);const i=this.getLocalStats();s=i.wins,o=i.losses}o++,this.saveLocalStats({wins:s,losses:o,totalGames:s+o,winRate:s/(s+o)});try{const n=s+o,i=n>0?s/n:0,a={wallet_address:e,game_id:O,score:s,wins:s,losses:o,win_rate:i,metadata:{...t,wins:s,losses:o,total_games:n,win_rate:i,timestamp:new Date().toISOString(),display_name:this.getDisplayName(),result:"loss"}};console.log("üì§ Submitting loss to BEAR Park API...");const l=await(await fetch(`${I}/leaderboard`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).json();if(l.success){console.log("‚úÖ Loss submitted to BEAR Park"),console.log("üîç [LOSS VERIFY] Waiting 1 second, then verifying database update..."),await new Promise(d=>setTimeout(d,1e3));const c=await this.getMyStats();if(c){const d=c.wins||c.score||0,h=c.losses||0;console.log(`üîç [LOSS VERIFY] Database shows: ${d}W ${h}L`),console.log(`üîç [LOSS VERIFY] Expected: ${s}W ${o}L`),d===s&&h===o?console.log("‚úÖ [LOSS VERIFY] Database update confirmed!"):(console.error("‚ùå [LOSS VERIFY] Database does NOT match! Syncing localStorage from database..."),this.saveLocalStats({wins:d,losses:h,totalGames:d+h,winRate:d/(d+h)}))}}return l}catch(n){return console.error("‚ùå Error submitting loss to BEAR Park:",n),{success:!1,error:n instanceof Error?n.message:"Unknown error"}}}static getLocalStats(){const t=parseInt(localStorage.getItem("pongWins")||"0"),e=parseInt(localStorage.getItem("pongLosses")||"0"),s=t+e,o=s>0?t/s:0;return{wins:t,losses:e,totalGames:s,winRate:o}}static saveLocalStats(t){localStorage.setItem("pongWins",t.wins.toString()),localStorage.setItem("pongLosses",t.losses.toString())}static async getLeaderboard(t=10){try{const e=`${I}/leaderboard/${O}?limit=${t}`;return console.log("üîç Fetching Pong leaderboard from:",e),(await(await fetch(e)).json()).leaderboard||[]}catch(e){return console.error("‚ùå Error fetching Pong leaderboard:",e),[]}}static async getMyStats(){const t=this.getWalletAddress();if(!t)return null;try{return(await(await fetch(`${I}/leaderboard/${O}/${t}`)).json()).entry||null}catch(e){return console.error("‚ùå Error fetching user stats from BEAR Park:",e),null}}static formatWalletAddress(t){return!t||t.length<8?t:`${t.substring(0,4)}...${t.substring(t.length-4)}`}static formatDisplayName(t){return t.display_name?t.display_name:t.twitter_username?t.twitter_username:t.wallet_address?this.formatWalletAddress(t.wallet_address):"Anonymous"}static async getHoneyBalance(){const t=this.getWalletAddress();if(console.log("üîç [HONEY DEBUG] Starting balance fetch..."),console.log("üîç [HONEY DEBUG] Wallet address from localStorage:",t),console.log("üîç [HONEY DEBUG] localStorage keys:",Object.keys(localStorage)),!t)return console.log("‚ö†Ô∏è [HONEY DEBUG] No wallet connected - balance is 0"),0;try{const e=`${I}/profile/${t}`;console.log("üîç [HONEY DEBUG] Fetching from URL:",e);const s=await fetch(e);console.log("üîç [HONEY DEBUG] Response status:",s.status),console.log("üîç [HONEY DEBUG] Response ok:",s.ok);const o=await s.json();if(console.log("üîç [HONEY DEBUG] Full API response:",JSON.stringify(o,null,2)),o.success&&o.profile){const n=o.profile.honey??0;return console.log(`‚úÖ [HONEY DEBUG] TOTAL HONEY balance: ${n}`),n}return console.log("‚ö†Ô∏è [HONEY DEBUG] Response structure invalid:"),console.log("  - data.success:",o.success),console.log("  - data.profile exists:",!!o.profile),0}catch(e){return console.error("‚ùå [HONEY DEBUG] Error fetching HONEY balance:",e),e instanceof Error&&(console.error("‚ùå [HONEY DEBUG] Error message:",e.message),console.error("‚ùå [HONEY DEBUG] Error stack:",e.stack)),0}}static async getUpdatedBalance(){const t=this.getWalletAddress();if(!t)return null;try{const s=await(await fetch(`${I}/profile/${t}`)).json();return s.success&&s.profile?{total:s.profile.honey||0,raiding:s.profile.honey_raiding||0,games:s.profile.honey_games||0}:null}catch(e){return console.error("‚ùå Error fetching updated balance:",e),null}}static async processBettingTransaction(t,e){const s=this.getWalletAddress();if(console.log(`üî• [BETTING DEBUG] Starting transaction - didWin: ${t}, betAmount: ${e}, wallet: ${s}`),!s)return console.log("‚ö†Ô∏è [BETTING] No wallet connected - skipping bet transaction"),!1;if(e===0)return console.log("üí∞ [BETTING] Bet amount is 0 - no transaction needed"),!0;try{console.log("üîí [BETTING SECURE] Calling secure betting endpoint"),console.log("   - Server will fetch current points from database"),console.log("   - Server will calculate new points"),console.log("   - Client NEVER calculates or sends point values");const o=await fetch(`${I}/pong/betting`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({wallet_address:s,did_win:t,bet_amount:e})});console.log(`üî• [BETTING DEBUG] Response status: ${o.status}`);const n=await o.json();return console.log("üî• [BETTING DEBUG] Response data:",n),n.success?(console.log(`‚úÖ [BETTING] ${n.message}`),console.log(`üí∞ New balance: Total=${n.new_total}, Games=${n.new_games_points}, Raiding=${n.new_raiding_points}`),console.log(`üìä Change: ${n.change} HONEY`),!0):(console.error("‚ùå [BETTING] Failed to update balance:",n),!1)}catch(o){return console.error("‚ùå [BETTING] Error processing bet transaction:",o),!1}}}class L{scene;hitSound=null;whooshSound=null;comboSounds=new Map;scoreSound=null;perfectSound=null;bgMusic=null;masterVolume=.3;musicVolume=.2;sfxVolume=.3;isMuted=!1;volumeBeforeMute={master:.3,music:.2,sfx:.3};constructor(t){this.scene=t,localStorage.getItem("bearPongMuted")==="true"?(this.isMuted=!0,this.masterVolume=0,this.musicVolume=0,this.sfxVolume=0):(this.masterVolume=.3,this.musicVolume=.2,this.sfxVolume=.3)}preload(){this.scene.load.audio("hit","https://files.catbox.moe/blmu4h.mp3"),this.scene.load.audio("whoosh","https://files.catbox.moe/e3i5uj.mp3"),this.scene.load.audio("combo2","https://files.catbox.moe/6ho7x5.mp3"),this.scene.load.audio("combo3","https://files.catbox.moe/19lxs0.mp3"),this.scene.load.audio("combo4","https://files.catbox.moe/k9t4e4.mp3"),this.scene.load.audio("combo5","https://files.catbox.moe/aclr7s.mp3"),this.scene.load.audio("score","https://files.catbox.moe/aebxdd.mp3"),this.scene.load.audio("perfect","https://files.catbox.moe/tpt32f.mp3"),this.scene.load.audio("bgMusic","https://files.catbox.moe/g4jylc.mp3"),console.log("üîä Loading audio files from catbox.moe...")}create(){this.hitSound=this.scene.sound.add("hit",{volume:this.masterVolume*this.sfxVolume}),this.whooshSound=this.scene.sound.add("whoosh",{volume:this.masterVolume*this.sfxVolume*.5,loop:!1}),this.comboSounds.set(2,this.scene.sound.add("combo2",{volume:this.masterVolume*this.sfxVolume})),this.comboSounds.set(3,this.scene.sound.add("combo3",{volume:this.masterVolume*this.sfxVolume})),this.comboSounds.set(4,this.scene.sound.add("combo4",{volume:this.masterVolume*this.sfxVolume})),this.comboSounds.set(5,this.scene.sound.add("combo5",{volume:this.masterVolume*this.sfxVolume})),this.scoreSound=this.scene.sound.add("score",{volume:this.masterVolume*this.sfxVolume}),this.perfectSound=this.scene.sound.add("perfect",{volume:this.masterVolume*this.sfxVolume*1.2}),this.bgMusic=this.scene.sound.add("bgMusic",{volume:this.masterVolume*this.musicVolume,loop:!0}),console.log("üîä Audio system initialized - All sounds loaded!")}playHitSound(t,e){if(!this.hitSound)return;const s=1+Math.abs(t)*.3,o=.3+e/35*.3;this.hitSound.play({volume:this.masterVolume*this.sfxVolume*o,rate:s}),console.log(`üîä Hit sound: pitch=${s.toFixed(2)}, volume=${o.toFixed(2)}`)}playWhooshSound(t){if(!this.whooshSound)return;const e=.8+t/35*.4,s=.15+t/35*.25;this.whooshSound.play({volume:this.masterVolume*this.sfxVolume*s*.3,rate:e}),console.log(`üí® Whoosh sound: pitch=${e.toFixed(2)}, speed=${t.toFixed(1)}`)}playComboSound(t){const e=this.comboSounds.get(Math.min(t,5));e&&(e.play({volume:this.masterVolume}),console.log(`üéµ Combo sound: ${t} HIT COMBO!`))}playScoreSound(){this.scoreSound&&(this.scoreSound.play({volume:this.masterVolume}),console.log("üéØ Score sound"))}playPerfectHitSound(){this.perfectSound&&(this.perfectSound.play({volume:this.masterVolume*1.2}),console.log("‚≠ê PERFECT HIT sound!"))}playBackgroundMusic(){this.bgMusic&&(this.bgMusic.isPlaying||this.bgMusic.play())}stopBackgroundMusic(){this.bgMusic&&this.bgMusic.stop()}setMasterVolume(t){this.masterVolume=Phaser.Math.Clamp(t,0,1),this.updateAllVolumes(),console.log(`üîä Master volume set to ${(this.masterVolume*100).toFixed(0)}%`)}setMusicVolume(t){this.musicVolume=Phaser.Math.Clamp(t,0,1),this.bgMusic&&this.bgMusic.setVolume(this.masterVolume*this.musicVolume),console.log(`üéµ Music volume set to ${(this.musicVolume*100).toFixed(0)}%`)}setSFXVolume(t){this.sfxVolume=Phaser.Math.Clamp(t,0,1),this.updateAllVolumes(),console.log(`üîä SFX volume set to ${(this.sfxVolume*100).toFixed(0)}%`)}updateAllVolumes(){this.hitSound&&this.hitSound.setVolume(this.masterVolume*this.sfxVolume),this.whooshSound&&this.whooshSound.setVolume(this.masterVolume*this.sfxVolume*.5),this.scoreSound&&this.scoreSound.setVolume(this.masterVolume*this.sfxVolume),this.perfectSound&&this.perfectSound.setVolume(this.masterVolume*this.sfxVolume*1.2),this.comboSounds.forEach(t=>{t.setVolume(this.masterVolume*this.sfxVolume)}),this.bgMusic&&this.bgMusic.setVolume(this.masterVolume*this.musicVolume)}getVolumes(){return{master:this.masterVolume,music:this.musicVolume,sfx:this.sfxVolume}}mute(){this.isMuted||(this.volumeBeforeMute={master:this.masterVolume,music:this.musicVolume,sfx:this.sfxVolume},this.masterVolume=0,this.musicVolume=0,this.sfxVolume=0,this.isMuted=!0,localStorage.setItem("bearPongMuted","true"),this.updateAllVolumes(),console.log("üîá Audio muted"))}unmute(){this.isMuted&&(this.masterVolume=this.volumeBeforeMute.master,this.musicVolume=this.volumeBeforeMute.music,this.sfxVolume=this.volumeBeforeMute.sfx,this.isMuted=!1,localStorage.setItem("bearPongMuted","false"),this.updateAllVolumes(),console.log("üîä Audio unmuted"))}toggleMute(){this.isMuted?this.unmute():this.mute()}isMutedState(){return this.isMuted}}class Y extends g.Scene{pongClient=null;statusText=null;queuePositionText=null;loadingDots="";loadingTimer=null;statsText=null;audioManager=null;muteButton=null;muteIcon=null;constructor(){super({key:"PongLobbyScene"})}preload(){this.load.image("lobby-bg","https://files.catbox.moe/qnp7wc.png"),this.load.image("bear-logo","bear-logo.png"),this.audioManager||(this.audioManager=new L(this)),this.audioManager.preload()}create(){const{width:t,height:e}=this.cameras.main;this.audioManager=this.game.registry.get("globalAudioManager"),this.audioManager?console.log("üéµ Using existing global audio manager - music continues"):(this.audioManager=new L(this),this.audioManager.create(),this.audioManager.playBackgroundMusic(),this.game.registry.set("globalAudioManager",this.audioManager),console.log("üéµ Created new audio manager - music started"));const s=this.add.image(t/2,e/2,"lobby-bg");s.setDisplaySize(t,e),s.setAlpha(.9),this.tweens.add({targets:s,scale:{from:1,to:1.05},alpha:{from:.9,to:1},duration:3e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.tweens.add({targets:s,tint:{from:16777215,to:16755336},duration:2500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});const o=this.add.graphics();o.fillStyle(0,.35),o.fillRect(0,0,t,e),o.setBlendMode(g.BlendModes.MULTIPLY),this.createFloatingParticles(t,e);const n=e*.44-120,i=this.add.image(t/2,n,"bear-logo");i.setScale(.385),i.setOrigin(.5),this.tweens.add({targets:i,y:n+10,duration:2e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});const a=this.add.graphics();a.fillStyle(16756224,.25),a.fillCircle(t/2,n,90),a.setBlendMode(g.BlendModes.ADD),a.setDepth(-1),this.tweens.add({targets:a,alpha:{from:.15,to:.35},scale:{from:1,to:1.2},duration:1500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.displayPlayerStats(),this.createMatchmakingSection(),this.createMuteButton();const r=this.add.container(100,e-60),l=this.add.graphics(),c=200,d=50;l.fillStyle(14238017,1),l.fillRoundedRect(-c/2,-d/2,c,d,25),l.lineStyle(3,16733525,1),l.strokeRoundedRect(-c/2,-d/2,c,d,25);const h=this.add.text(0,0,"RETURN",{fontSize:"20px",color:"#ffffff",fontStyle:"bold",fontFamily:"Luckiest Guy"});h.setOrigin(.5),r.add([l,h]),r.setSize(c,d),r.setInteractive({useHandCursor:!0}),r.on("pointerdown",()=>{this.cancelMatchmaking()}),r.on("pointerover",()=>{this.tweens.add({targets:r,scale:1.1,duration:150,ease:"Back.easeOut"}),l.clear(),l.fillStyle(16733525,1),l.fillRoundedRect(-c/2,-d/2,c,d,25),l.lineStyle(3,16742263,1),l.strokeRoundedRect(-c/2,-d/2,c,d,25)}),r.on("pointerout",()=>{this.tweens.add({targets:r,scale:1,duration:150,ease:"Back.easeIn"}),l.clear(),l.fillStyle(14238017,1),l.fillRoundedRect(-c/2,-d/2,c,d,25),l.lineStyle(3,16733525,1),l.strokeRoundedRect(-c/2,-d/2,c,d,25)}),this.tweens.add({targets:r,alpha:{from:.9,to:1},duration:1500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.input.keyboard?.on("keydown-ESC",()=>{this.cancelMatchmaking()}),this.connectToServer()}createTriColorRing(t,e,s,o,n){const i=[6819033,16756224,503304],a=3,r=Math.PI*2/a;for(let l=0;l<a;l++){const c=l*r-Math.PI/2,d=(l+1)*r-Math.PI/2;t.lineStyle(n,i[l]),t.beginPath(),t.arc(e,s,o,c,d,!1),t.strokePath()}}createBorderedSection(t,e,s,o){const n=this.add.graphics();n.fillStyle(0,.7),n.fillRoundedRect(t-s/2,e-o/2,s,o,15);const i=[6819033,16756224,503304],a=4,r=2;for(let l=0;l<3;l++)n.lineStyle(a,i[l]),n.strokeRoundedRect(t-s/2-r*l,e-o/2-r*l,s+r*l*2,o+r*l*2,15);return n}createMuteButton(){this.muteButton=this.add.container(60,60);const t=this.add.circle(0,0,30,6819033);t.setInteractive({useHandCursor:!0}),this.muteButton.add(t);const e=this.add.graphics();this.createTriColorRing(e,0,0,30,4),this.muteButton.add(e),this.muteIcon=this.add.graphics();const s=this.audioManager?.isMutedState()||!1;this.updateMuteIcon(s),this.muteButton.add(this.muteIcon),t.on("pointerdown",()=>{this.toggleMute()}),t.on("pointerover",()=>{this.muteButton?.setScale(1.1)}),t.on("pointerout",()=>{this.muteButton?.setScale(1)})}updateMuteIcon(t){this.muteIcon&&(this.muteIcon.clear(),this.muteIcon.fillStyle(16692481),this.muteIcon.fillRect(-12,-6,6,12),this.muteIcon.beginPath(),this.muteIcon.moveTo(-6,-6),this.muteIcon.lineTo(0,-10),this.muteIcon.lineTo(0,10),this.muteIcon.lineTo(-6,6),this.muteIcon.closePath(),this.muteIcon.fillPath(),t?(this.muteIcon.lineStyle(3,16711680),this.muteIcon.beginPath(),this.muteIcon.moveTo(4,-10),this.muteIcon.lineTo(14,0),this.muteIcon.moveTo(14,-10),this.muteIcon.lineTo(4,0),this.muteIcon.strokePath()):(this.muteIcon.lineStyle(2,16692481),this.muteIcon.beginPath(),this.muteIcon.arc(0,0,8,-Math.PI/4,Math.PI/4),this.muteIcon.strokePath(),this.muteIcon.beginPath(),this.muteIcon.arc(0,0,12,-Math.PI/4,Math.PI/4),this.muteIcon.strokePath()))}toggleMute(){if(this.audioManager){this.audioManager.toggleMute();const t=this.audioManager.isMutedState();this.updateMuteIcon(t)}}createMatchmakingSection(){const{width:t,height:e}=this.cameras.main,s=t/2+200,o=e-180,a=this.createBorderedSection(s,o,350,240);this.tweens.add({targets:a,alpha:{from:.9,to:1},duration:1800,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});const r=this.add.container(s,o);this.statusText=this.add.text(0,-80,`Searching for
opponent`,{fontSize:"26px",color:"#ffae00",fontFamily:"Luckiest Guy",stroke:"#000000",strokeThickness:4,align:"center"}),this.statusText.setOrigin(.5),r.add(this.statusText),this.tweens.add({targets:this.statusText,scale:{from:1,to:1.08},duration:1200,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.queuePositionText=this.add.text(0,-10,"",{fontSize:"22px",color:"#50fa7b",fontFamily:"Luckiest Guy",stroke:"#000000",strokeThickness:2}),this.queuePositionText.setOrigin(.5),r.add(this.queuePositionText);const l=this.add.text(0,25,`Waiting for another
player to join...`,{fontSize:"16px",color:"#cccccc",align:"center",fontFamily:"Luckiest Guy",lineSpacing:4});l.setOrigin(.5),r.add(l);const c=this.add.graphics();c.lineStyle(5,16756224,1),c.arc(0,75,25,0,Math.PI*1.5,!1),c.strokePath(),r.add(c);const d=this.add.graphics();d.lineStyle(4,6819033,.7),d.arc(0,75,35,Math.PI,Math.PI*2.5,!1),d.strokePath(),r.add(d);const h=this.add.graphics();h.lineStyle(3,5307003,.5),h.arc(0,75,45,Math.PI*.5,Math.PI*2,!1),h.strokePath(),r.add(h),this.tweens.add({targets:c,angle:360,duration:1200,repeat:-1,ease:"Linear"}),this.tweens.add({targets:d,angle:-360,duration:1800,repeat:-1,ease:"Linear"}),this.tweens.add({targets:h,angle:360,duration:2400,repeat:-1,ease:"Linear"}),this.loadingTimer=this.time.addEvent({delay:500,callback:()=>{this.loadingDots=this.loadingDots.length>=3?"":this.loadingDots+".",this.statusText&&this.statusText.setText(`Searching for
opponent${this.loadingDots}`)},loop:!0})}displayPlayerStats(){const t=E.getLocalStats(),e=E.getCurrentUserDisplayName(),{width:s,height:o}=this.cameras.main,n=s/2-200,i=o-180,l=this.createBorderedSection(n,i,350,240);this.tweens.add({targets:l,alpha:{from:.95,to:1},duration:2e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});const c=this.add.container(n,i),d=this.add.text(0,-70,`üêª ${e}`,{fontSize:"28px",color:"#ffae00",fontFamily:"Luckiest Guy",fontStyle:"bold",stroke:"#000000",strokeThickness:3});d.setOrigin(.5),c.add(d),this.tweens.add({targets:d,scale:{from:1,to:1.05},duration:1500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});const h=this.add.text(0,-35,"STATS",{fontSize:"22px",color:"#ffffff",fontFamily:"Luckiest Guy",stroke:"#000000",strokeThickness:3});h.setOrigin(.5),c.add(h),this.statsText=this.add.text(0,25,`Wins: ${t.wins}
Losses: ${t.losses}
Win Rate: ${(t.winRate*100).toFixed(1)}%`,{fontSize:"20px",color:"#50fa7b",fontFamily:"Luckiest Guy",stroke:"#000000",strokeThickness:2,align:"center",lineSpacing:10}),this.statsText.setOrigin(.5),c.add(this.statsText)}async fetchPlayerAvatar(t){try{const s=await(await fetch(`/api/profile/${t}`)).json();if(s.success&&s.profile&&s.profile.avatar_nft)try{const o=JSON.parse(s.profile.avatar_nft),n=o.imageUrl||o.fallbackImageUrl||null,i=o.isAnimated||!1;return{url:n,isAnimated:i}}catch{return{url:`https://nft.xrpl-labs.com/${s.profile.avatar_nft}`,isAnimated:!1}}return{url:null,isAnimated:!1}}catch(e){return console.error("Failed to fetch avatar:",e),{url:null,isAnimated:!1}}}async connectToServer(){const t="wss://bear-pong-production.up.railway.app";this.pongClient=new N(t);try{await this.pongClient.connect(),this.setupEventHandlers();const e=E.getWalletAddress()||"guest_"+Date.now(),{url:s,isAnimated:o}=await this.fetchPlayerAvatar(e);console.log("üñºÔ∏è Fetched avatar from API:",s,"isAnimated:",o);let n=s,i=o;n||(n=localStorage.getItem("avatar_url"),i=localStorage.getItem("avatar_is_animated")==="true",console.log("üì¶ Fallback to localStorage avatar:",n,"isAnimated:",i)),n&&(localStorage.setItem("avatar_url",n),localStorage.setItem("avatar_is_animated",i?"true":"false"),console.log("üíæ Saved avatar to localStorage"));const a={wallet:e,displayName:E.getCurrentUserDisplayName(),avatarUrl:n||void 0,avatarIsAnimated:i||void 0};this.pongClient.joinQueue(a)}catch(e){console.error("Failed to connect to server:",e),this.showConnectionError()}}setupEventHandlers(){this.pongClient&&(this.pongClient.on("queue_joined",t=>{this.queuePositionText&&this.queuePositionText.setText(`Queue position: ${t}`)}),this.pongClient.on("match_found",t=>{console.log("Match found!",t),console.log("üéÆ Opponent data:",t.opponent),console.log("üñºÔ∏è Opponent avatar URL:",t.opponent?.avatarUrl),this.statusText&&this.statusText.setText("Match Found!"),this.loadingTimer&&(this.loadingTimer.destroy(),this.loadingTimer=null),this.time.delayedCall(1e3,()=>{this.startGame(t.opponent,t.yourSide)})}),this.pongClient.on("connection_failed",()=>{this.showConnectionError()}),this.pongClient.on("error",t=>{console.error("Server error:",t),this.showError(t)}))}startGame(t,e){this.scene.start("PongBettingLobbyScene",{pongClient:this.pongClient,opponent:t,yourSide:e}),this.scene.stop()}cancelMatchmaking(){this.audioManager&&(this.audioManager.stopBackgroundMusic(),console.log("üîá Stopped music - canceling matchmaking")),this.pongClient&&(this.pongClient.leave(),this.pongClient.disconnect()),this.loadingTimer&&this.loadingTimer.destroy(),this.add.text(this.cameras.main.width/2,this.cameras.main.height/2,"Matchmaking Cancelled",{fontSize:"36px",color:"#ffffff",fontFamily:"Luckiest Guy"}).setOrigin(.5),this.time.delayedCall(2e3,()=>{window.location.href="/"})}showConnectionError(){this.statusText&&(this.statusText.setText("Failed to connect to server"),this.statusText.setColor("#ff6b6b")),this.queuePositionText&&this.queuePositionText.setText("Please try again later"),this.loadingTimer&&(this.loadingTimer.destroy(),this.loadingTimer=null)}showError(t){this.queuePositionText&&(this.queuePositionText.setText(`Error: ${t}`),this.queuePositionText.setColor("#ff6b6b"))}createFloatingParticles(t,e){for(let s=0;s<30;s++){const o=g.Math.Between(0,t),n=g.Math.Between(0,e),i=this.add.graphics(),a=g.Math.RND.pick([16756224,5307003,6819033,16692481]);i.fillStyle(a,.5),i.fillCircle(0,0,g.Math.Between(3,7)),i.setPosition(o,n),i.setBlendMode(g.BlendModes.ADD),this.tweens.add({targets:i,y:n-g.Math.Between(150,300),alpha:{from:.5,to:0},duration:g.Math.Between(4e3,7e3),repeat:-1,delay:g.Math.Between(0,3e3),onRepeat:()=>{i.y=e+10,i.x=g.Math.Between(0,t),i.alpha=.5}}),this.tweens.add({targets:i,x:`+=${g.Math.Between(-40,40)}`,duration:g.Math.Between(1500,2500),yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}}shutdown(){this.pongClient&&(this.pongClient.off("queue_joined"),this.pongClient.off("match_found"),this.pongClient.off("connection_failed"),this.pongClient.off("error"),console.log("‚úÖ [LOBBY] Removed all network listeners from lobby"))}}class $ extends g.Scene{pongClient=null;opponent=null;yourSide="left";myBetAmount=0;opponentBetAmount=0;finalBetAmount=0;myHoneyBalance=0;isReady=!1;opponentIsReady=!1;countdown=30;countdownText=null;timerEvent=null;readyButton=null;statusText=null;opponentBetText=null;yourBetText=null;betSelectorContainer=null;myAvatarUrl=null;opponentAvatarUrl=null;myAvatarIsAnimated=!1;opponentAvatarIsAnimated=!1;myStats=null;opponentStats=null;canvasClickHandler=null;instanceId=Math.random().toString(36).substring(7);constructor(){super({key:"PongBettingLobbyScene"}),console.log(`üÜï [BETTING LOBBY] Constructor called - Instance ID: ${this.instanceId}`)}init(t){console.log("üöÄüöÄüöÄ [BETTING LOBBY] INIT CALLED - New betting lobby instance created!"),console.log("üöÄ [BETTING LOBBY] Scene key:",this.scene.key),console.log("üöÄ [BETTING LOBBY] Scene active:",this.scene.isActive()),this.pongClient=t.pongClient,this.opponent=t.opponent,this.yourSide=t.yourSide,this.myBetAmount=0,this.opponentBetAmount=0,this.finalBetAmount=0,this.isReady=!1,this.opponentIsReady=!1,this.countdown=30,this.myAvatarUrl=E.getAvatarUrl(),this.myAvatarIsAnimated=localStorage.getItem("avatar_is_animated")==="true",this.opponentAvatarUrl=this.opponent?.avatarUrl||null,this.opponentAvatarIsAnimated=this.opponent?.avatarIsAnimated||!1,console.log("üñºÔ∏è [BETTING LOBBY] My avatar:",this.myAvatarUrl,"isAnimated:",this.myAvatarIsAnimated),console.log("üñºÔ∏è [BETTING LOBBY] Opponent avatar:",this.opponentAvatarUrl,"isAnimated:",this.opponentAvatarIsAnimated)}async create(){const{width:t,height:e}=this.cameras.main;await this.preloadAvatars(),this.myHoneyBalance=await E.getHoneyBalance(),console.log(`üí∞ [BETTING] Your HONEY balance: ${this.myHoneyBalance}`);const s=await E.getMyStats(),o=E.getLocalStats();let n=0,i=0,a=0;s?(n=s.wins||s.score||0,i=s.losses||0,a=s.win_rate||0,console.log(`üìä [BETTING] Your stats from DATABASE: ${n}W ${i}L (${(a*100).toFixed(0)}%)`)):o.totalGames>0?(n=o.wins,i=o.losses,a=o.winRate,console.log(`üìä [BETTING] Your stats from LOCALSTORAGE: ${n}W ${i}L (${(a*100).toFixed(0)}%)`)):console.log("üìä [BETTING] No stats found - showing DEFAULT: 0W 0L (0%)"),this.myStats={wins:n,losses:i,winRate:a};let r=0,l=0,c=0;const d=this.opponent?.wallet||this.opponent?.walletAddress;if(console.log("üîç [BETTING] Opponent data:",this.opponent),console.log("üîç [BETTING] Opponent wallet:",d),d)try{const S=`https://www.bearpark.xyz/api/leaderboard/bear-pong/${d}`;console.log("üì° [BETTING] Fetching opponent stats from:",S);const T=await(await fetch(S)).json();console.log("üì° [BETTING] Opponent stats API response:",T),T.success&&T.entry?(r=T.entry.wins||T.entry.score||0,l=T.entry.losses||0,c=T.entry.win_rate||0,console.log(`‚úÖ [BETTING] Opponent stats from DATABASE: ${r}W ${l}L (${(c*100).toFixed(0)}%)`)):(console.log("‚ö†Ô∏è [BETTING] Opponent has no stats in database - showing DEFAULT: 0W 0L (0%)"),console.log("‚ö†Ô∏è [BETTING] Response:",JSON.stringify(T)))}catch(S){console.error("‚ùå [BETTING] Error fetching opponent stats:",S),console.log("üìä [BETTING] Using DEFAULT opponent stats: 0W 0L (0%)")}else console.log("‚ö†Ô∏è [BETTING] No opponent wallet available!");this.opponentStats={wins:r,losses:l,winRate:c};const h=this.add.image(t/2,e/2,"lobby-bg");h.setDisplaySize(t,e),h.setAlpha(.85),this.tweens.add({targets:h,scale:{from:1,to:1.05},alpha:{from:.85,to:.95},duration:3e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.tweens.add({targets:h,tint:{from:16777215,to:16755200},duration:2e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});const p=this.add.graphics();p.fillStyle(0,.4),p.fillRect(0,0,t,e),p.setBlendMode(g.BlendModes.MULTIPLY),this.createFloatingParticles(t,e);const u=this.add.text(t/2,60,"PLACE YOUR BETS!",{fontSize:"56px",color:"#ffae00",fontStyle:"bold",fontFamily:"Luckiest Guy"});u.setOrigin(.5),u.setStroke("#000000",6),this.tweens.add({targets:u,scale:{from:1,to:1.15},duration:600,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});const m=this.add.graphics();m.fillStyle(16756224,.3),m.fillCircle(t/2,60,150),m.setBlendMode(g.BlendModes.ADD),m.setDepth(-1),this.tweens.add({targets:m,alpha:{from:.2,to:.5},scale:{from:1,to:1.3},duration:800,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});const w=this.add.text(t/2,130,`Your Balance: ${this.myHoneyBalance} HONEY`,{fontSize:"28px",color:"#50fa7b",fontFamily:"Luckiest Guy"});w.setOrigin(.5),w.setStroke("#000000",4),this.countdownText=this.add.text(t/2,180,`Time: ${this.countdown}s`,{fontSize:"32px",color:"#ffae00",fontFamily:"Luckiest Guy",fontStyle:"bold"}),this.countdownText.setOrigin(.5),this.countdownText.setStroke("#000000",5),this.countdownText.setDepth(1e3),this.startCountdown(),this.displayPlayers(t/2,250),this.createBetSelector(t/2,410),this.statusText=this.add.text(t/2,530,"Select your bet and click READY",{fontSize:"24px",color:"#888888",fontFamily:"Luckiest Guy"}),this.statusText.setOrigin(.5),this.createReadyButton(t/2,610),this.setupNetworkListeners(),this.setupCanvasClickHandler(t,e)}async preloadAvatars(){return new Promise(t=>{const e=[];if(this.myAvatarUrl&&e.push(this.myAvatarUrl),this.opponentAvatarUrl&&e.push(this.opponentAvatarUrl),e.length===0){console.log("üñºÔ∏è No avatars to preload"),t();return}console.log(`üñºÔ∏è Preloading ${e.length} avatar(s)...`),e.forEach(s=>{const o=`avatar_${s.replace(/[^a-zA-Z0-9]/g,"_")}`;this.textures.exists(o)||this.load.image(o,s)}),this.load.once("complete",()=>{console.log("‚úÖ Avatars preloaded successfully"),t()}),this.load.start()})}displayPlayers(t,e){const s=this.add.container(t,e);this.createProfilePicture(s,-320,-30,this.myAvatarUrl,this.myAvatarIsAnimated,503304,t,e);const o=this.add.text(-200,-30,"YOU",{fontSize:"24px",color:"#07ae08",fontFamily:"Luckiest Guy"});o.setOrigin(.5),s.add(o);const n=this.add.text(-200,10,E.getCurrentUserDisplayName(),{fontSize:"20px",color:"#ffffff",fontFamily:"Luckiest Guy"});n.setOrigin(.5),s.add(n);const i=(this.myStats.winRate*100).toFixed(0),a=this.add.text(-200,32,`${this.myStats.wins}W ${this.myStats.losses}L (${i}%)`,{fontSize:"16px",color:this.myStats.winRate>=.7?"#50fa7b":this.myStats.winRate>=.5?"#ffae00":"#ff4500",fontFamily:"Luckiest Guy",fontStyle:"bold"});a.setOrigin(.5),s.add(a),this.yourBetText=this.add.text(-200,55,`Bet: ${this.myBetAmount} HONEY`,{fontSize:"18px",color:"#ffae00",fontFamily:"Luckiest Guy"}),this.yourBetText.setOrigin(.5),s.add(this.yourBetText);const r=this.add.text(0,-10,"VS",{fontSize:"48px",color:"#ffae00",fontFamily:"Luckiest Guy"});r.setOrigin(.5),r.setStroke("#000000",4),s.add(r),this.createProfilePicture(s,320,-30,this.opponentAvatarUrl,this.opponentAvatarIsAnimated,16729344,t,e);const l=this.add.text(200,-30,"OPPONENT",{fontSize:"24px",color:"#ff4500",fontFamily:"Luckiest Guy"});l.setOrigin(.5),s.add(l);const c=this.add.text(200,10,this.opponent?.displayName||"Opponent",{fontSize:"20px",color:"#ffffff",fontFamily:"Luckiest Guy"});c.setOrigin(.5),s.add(c);const d=(this.opponentStats.winRate*100).toFixed(0),h=this.add.text(200,32,`${this.opponentStats.wins}W ${this.opponentStats.losses}L (${d}%)`,{fontSize:"16px",color:this.opponentStats.winRate>=.7?"#50fa7b":this.opponentStats.winRate>=.5?"#ffae00":"#ff4500",fontFamily:"Luckiest Guy",fontStyle:"bold"});h.setOrigin(.5),s.add(h),this.opponentBetText=this.add.text(200,55,this.opponentBetAmount>0?`Bet: ${this.opponentBetAmount} HONEY`:"Selecting...",{fontSize:"22px",color:this.opponentBetAmount>0?"#50fa7b":"#888888",fontFamily:"Luckiest Guy",fontStyle:this.opponentBetAmount>0?"bold":"normal"}),this.opponentBetText.setOrigin(.5),this.opponentBetAmount>0&&this.opponentBetText.setStroke("#000000",3),s.add(this.opponentBetText)}createProfilePicture(t,e,s,o,n,i,a,r){if(o){const c=`avatar_${o.replace(/[^a-zA-Z0-9]/g,"_")}`;console.log(`üîç Looking for texture: ${c}`),console.log(`üîç Texture exists: ${this.textures.exists(c)}`),this.textures.exists(c)?(console.log(`üñºÔ∏è Displaying preloaded avatar: ${c}, isAnimated: ${n}`),this.displayAvatarImage(t,e,s,50,o,c,n,i,a,r)):(console.error(`‚ùå Avatar texture not found: ${c}`),this.createPlaceholder(t,e,s,50,i))}else console.log("üñºÔ∏è No avatar URL - showing placeholder"),this.createPlaceholder(t,e,s,50,i)}createPlaceholder(t,e,s,o,n){const i=this.add.circle(e,s,o,3355443);t.add(i);const a=this.add.text(e,s,"üêª",{fontSize:"48px",color:"#ffae00"});a.setOrigin(.5),t.add(a);const r=this.add.graphics();r.lineStyle(4,n,1),r.strokeCircle(e,s,o+2),t.add(r)}displayAvatarImage(t,e,s,o,n,i,a,r,l,c){try{const d=this.add.circle(e,s,o,3355443);t.add(d);const h=l+e,p=c+s;if(a){console.log(`üé¨ Displaying ANIMATED avatar at (${h}, ${p})`);const m=this.game.canvas.getBoundingClientRect(),w=m.width/this.cameras.main.width,S=h*w,y=p*w,T=o*w;console.log("üìê Canvas rect:",m),console.log(`üìê Game size: ${this.cameras.main.width}x${this.cameras.main.height}`),console.log(`üìê Scale factor: ${w}`),console.log(`üìê World position: (${h}, ${p})`),console.log(`üìê Scaled position: (${S}, ${y})`),console.log(`üìê Radius: ${o} -> ${T}`),console.log(`üìê Final left: ${m.left+S-T}px`),console.log(`üìê Final top: ${m.top+y-T}px`);const b=document.createElement("div");b.style.position="fixed",b.style.width=`${T*2}px`,b.style.height=`${T*2}px`,b.style.left=`${m.left+S-T}px`,b.style.top=`${m.top+y-T}px`,b.style.borderRadius="50%",b.style.overflow="hidden",b.style.pointerEvents="none",b.style.zIndex="10000",b.style.border=`4px solid ${this.colorToHex(r)}`;const A=document.createElement("img");A.src=n,A.style.width="100%",A.style.height="100%",A.style.objectFit="cover",A.style.display="block",b.appendChild(A),document.body.appendChild(b),this.events.once("shutdown",()=>{b.remove()}),console.log(`‚úÖ Animated avatar displayed as DOM element at (${h}, ${p})`)}else{const u=this.add.sprite(e,s,i),m=o*2/Math.min(u.width,u.height);u.setScale(m);const w=this.make.graphics({x:0,y:0,add:!1});w.fillStyle(16777215),w.fillCircle(h,p,o);const S=w.createGeometryMask();u.setMask(S),t.add(u),console.log(`‚úÖ Static avatar displayed with CIRCULAR mask at (${e}, ${s}), world: (${h}, ${p})`);const y=this.add.graphics();y.lineStyle(4,r,1),y.strokeCircle(e,s,o+2),y.setDepth(11),t.add(y)}}catch(d){console.error("‚ùå Error displaying avatar:",d),this.createPlaceholder(t,e,s,o,r)}}colorToHex(t){return"#"+t.toString(16).padStart(6,"0")}createBetSelector(t,e){this.betSelectorContainer&&this.betSelectorContainer.destroy();const s=this.add.container(t,e);this.betSelectorContainer=s;const o=this.add.text(0,-50,"SELECT BET AMOUNT:",{fontSize:"28px",color:"#ffffff",fontFamily:"Luckiest Guy"});o.setOrigin(.5),s.add(o);const i=[0,10,20,50,100,200,500,1e3].filter(d=>d<=this.myHoneyBalance);i.length===0&&i.push(0);const a=100,r=50,l=120,c=-((i.length-1)*l)/2;i.forEach((d,h)=>{const p=c+h*l,u=this.add.graphics(),m=d===this.myBetAmount;u.fillStyle(m?503304:3355443,1),u.fillRoundedRect(p-a/2,-r/2,a,r,8),m&&(u.lineStyle(3,16756224,1),u.strokeRoundedRect(p-a/2,-r/2,a,r,8));const w=this.add.text(p,0,`${d}`,{fontSize:"24px",color:"#ffffff",fontFamily:"Luckiest Guy"});w.setOrigin(.5);const S=this.add.container(0,0);S.add([u,w]),S.setInteractive(new g.Geom.Rectangle(p-a/2,-r/2,a,r),g.Geom.Rectangle.Contains),S.on("pointerdown",()=>{this.isReady||this.selectBet(d)}),S.on("pointerover",()=>{this.isReady||(u.clear(),u.fillStyle(5592405,1),u.fillRoundedRect(p-a/2,-r/2,a,r,8))}),S.on("pointerout",()=>{if(!this.isReady){u.clear();const y=d===this.myBetAmount;u.fillStyle(y?503304:3355443,1),u.fillRoundedRect(p-a/2,-r/2,a,r,8),y&&(u.lineStyle(3,16756224,1),u.strokeRoundedRect(p-a/2,-r/2,a,r,8))}}),s.add(S)})}selectBet(t){this.isReady||(this.myBetAmount=t,console.log(`üí∞ [BETTING] Selected bet amount: ${t}`),this.pongClient&&this.pongClient.send({type:"set_bet",amount:t}),this.updateMinimumBet(),this.updateBetDisplays(),this.createBetSelector(this.cameras.main.width/2,410),this.flashScreen(503304))}updateMinimumBet(){let t;this.myBetAmount===0||this.opponentBetAmount===0?t=0:t=Math.min(this.myBetAmount,this.opponentBetAmount),console.log(`üí∞ [BETTING] Minimum bet: ${t} (You: ${this.myBetAmount}, Opponent: ${this.opponentBetAmount})`),localStorage.setItem("bearPongCurrentBet",t.toString())}updateBetDisplays(){if(this.yourBetText&&this.yourBetText.setText(`Bet: ${this.myBetAmount} HONEY`),this.opponentBetText){const t=this.opponentBetAmount>0?`Bet: ${this.opponentBetAmount} HONEY`:"Selecting...",e=this.opponentBetAmount>0?"#50fa7b":"#888888";this.opponentBetText.setText(t),this.opponentBetText.setColor(e),this.opponentBetText.setFontStyle(this.opponentBetAmount>0?"bold":"normal"),this.opponentBetAmount>0?this.opponentBetText.setStroke("#000000",3):this.opponentBetText.setStroke("",0)}console.log(`üìä [BETTING] Updated displays - You: ${this.myBetAmount}, Opponent: ${this.opponentBetAmount}`)}refreshUI(){this.children.each(n=>{n!==this.countdownText&&n.destroy()});const{width:t,height:e}=this.cameras.main;this.add.rectangle(0,0,t,e,1710618,1).setOrigin(0);const s=this.add.text(t/2,60,"PLACE YOUR BETS!",{fontSize:"56px",color:"#ffae00",fontStyle:"bold",fontFamily:"Luckiest Guy"});s.setOrigin(.5),s.setStroke("#000000",6);const o=this.add.text(t/2,130,`Your Balance: ${this.myHoneyBalance} HONEY`,{fontSize:"28px",color:"#50fa7b",fontFamily:"Luckiest Guy"});o.setOrigin(.5),o.setStroke("#000000",4),this.displayPlayers(t/2,250),this.createBetSelector(t/2,410),this.statusText=this.add.text(t/2,530,"Select your bet and click READY",{fontSize:"24px",color:"#888888",fontFamily:"Luckiest Guy"}),this.statusText.setOrigin(.5),this.createReadyButton(t/2,610)}createReadyButton(t,e){const n=this.add.graphics();n.fillStyle(this.isReady?6710886:503304,1),n.fillRoundedRect(t-300/2,e-60/2,300,60,12);const i=this.add.text(t,e,this.isReady?"WAITING...":"READY!",{fontSize:"32px",color:"#ffffff",fontStyle:"bold",fontFamily:"Luckiest Guy"});i.setOrigin(.5),this.readyButton=this.add.container(0,0),this.readyButton.add([n,i]),this.isReady||(this.readyButton.setInteractive(new g.Geom.Rectangle(t-300/2,e-60/2,300,60),g.Geom.Rectangle.Contains),this.readyButton.on("pointerdown",()=>{this.readyUp()}),this.readyButton.on("pointerover",()=>{n.clear(),n.fillStyle(643082,1),n.fillRoundedRect(t-300/2,e-60/2,300,60,12)}),this.readyButton.on("pointerout",()=>{n.clear(),n.fillStyle(503304,1),n.fillRoundedRect(t-300/2,e-60/2,300,60,12)}))}readyUp(){this.isReady||(this.isReady=!0,console.log("‚úÖ [BETTING] You are ready!"),this.statusText&&(this.statusText.setText(this.opponentIsReady?"Both players ready! Starting...":"Waiting for opponent..."),this.statusText.setColor("#07ae08")),this.pongClient&&this.pongClient.send({type:"ready_to_start"}),this.readyButton&&this.readyButton.destroy(),this.createReadyButton(this.cameras.main.width/2,580))}startCountdown(){this.timerEvent=this.time.addEvent({delay:1e3,callback:()=>{this.countdown--,this.countdownText&&(this.countdownText.setText(`Time: ${this.countdown}s`),this.countdown<=10&&(this.countdownText.setColor("#ff4500"),this.countdownText.setFontSize(36)),this.countdownText.setDepth(1e3)),this.countdown<=0&&this.handleTimeout()},loop:!0})}handleTimeout(){console.log(`‚è∞ [BETTING LOBBY ${this.instanceId}] handleTimeout() called!`),console.log("‚è∞ [BETTING] Countdown expired!"),console.log(`‚è∞ isReady: ${this.isReady}, opponentIsReady: ${this.opponentIsReady}`),this.timerEvent&&this.timerEvent.destroy(),!this.isReady&&!this.opponentIsReady?(console.log(`‚ùå [BETTING LOBBY ${this.instanceId}] No one ready - returning to menu`),this.returnToMenu()):(this.isReady||this.opponentIsReady)&&(console.log(`‚úÖ [BETTING LOBBY ${this.instanceId}] At least one player ready - starting game`),this.startGame())}setupNetworkListeners(){this.pongClient&&(console.log(`üì° [BETTING LOBBY ${this.instanceId}] Setting up network listeners...`),this.pongClient.on("opponent_bet_set",t=>{console.log(`üì° [BETTING LOBBY ${this.instanceId}] opponent_bet_set event received`),this.opponentBetAmount=t.amount,console.log(`üí∞ [BETTING] Opponent set bet: ${t.amount}`),this.flashScreen(5307003),this.updateMinimumBet(),this.updateBetDisplays(),this.statusText&&(this.statusText.setText(`Opponent bet ${t.amount} HONEY!`),this.statusText.setColor("#50fa7b"),this.time.delayedCall(2e3,()=>{this.statusText&&!this.isReady&&(this.statusText.setText("Select your bet and click READY"),this.statusText.setColor("#888888"))}))}),this.pongClient.on("opponent_ready",()=>{console.log(`üì° [BETTING LOBBY ${this.instanceId}] opponent_ready event received`),this.opponentIsReady=!0,console.log("‚úÖ [BETTING] Opponent is ready!"),this.flashScreen(503304),this.statusText&&this.statusText.setText(this.isReady?"Both players ready! Starting...":"Opponent is ready!"),this.isReady&&this.opponentIsReady&&(this.flashScreen(16756224),this.cameras.main.shake(200,.003),this.time.delayedCall(1500,()=>{this.startGame()}))}),this.pongClient.on("final_bet_amount",t=>{console.log(`üì° [BETTING LOBBY ${this.instanceId}] final_bet_amount event received`),this.finalBetAmount=t.amount,console.log(`üí∞ [BETTING] Final bet amount set by server: ${t.amount}`),localStorage.setItem("bearPongCurrentBet",this.finalBetAmount.toString())}),this.pongClient.on("betting_timeout",()=>{console.log(`üì° [BETTING LOBBY ${this.instanceId}] betting_timeout event received`),console.log("‚è∞ [BETTING] Server sent timeout signal"),this.handleTimeout()}),this.pongClient.on("countdown",t=>{console.log(`üì° [BETTING LOBBY ${this.instanceId}] countdown event received`),console.log(`üéÆ [BETTING] Game starting countdown: ${t.count}`),this.startGame()}),this.pongClient.on("opponent_disconnected",()=>{console.log(`üì° [BETTING LOBBY ${this.instanceId}] opponent_disconnected event received`),console.log("‚ùå [BETTING] Opponent disconnected"),this.returnToMenu()}))}startGame(){console.log(`üéÆ [BETTING LOBBY ${this.instanceId}] startGame() called!`),console.log("üéÆ [BETTING] Transitioning to game scene..."),console.log(`üí∞ [BETTING] Passing betAmount to game scene: ${this.finalBetAmount}`),this.timerEvent&&this.timerEvent.destroy(),this.canvasClickHandler?(console.log(`üßπ [BETTING LOBBY ${this.instanceId}] Manually removing canvas click handler before scene stop`),this.game.canvas.removeEventListener("pointerdown",this.canvasClickHandler),this.canvasClickHandler=null,console.log(`‚úÖ [BETTING LOBBY ${this.instanceId}] Canvas click handler removed!`)):console.log(`‚ö†Ô∏è [BETTING LOBBY ${this.instanceId}] No canvas click handler to remove in startGame()`),this.pongClient&&(this.pongClient.off("opponent_disconnected"),console.log(`‚úÖ [BETTING LOBBY ${this.instanceId}] Removed opponent_disconnected listener from betting lobby`)),this.scene.start("PongGameScene",{pongClient:this.pongClient,opponent:this.opponent,yourSide:this.yourSide,betAmount:this.finalBetAmount}),console.log(`üõë [BETTING LOBBY ${this.instanceId}] Stopping betting lobby scene`),this.scene.stop()}returnToMenu(){console.error("üö®üö®üö® [BETTING LOBBY] returnToMenu() CALLED!!!"),console.error("üö® Instance ID:",this.instanceId),console.error("üö® Scene active:",this.scene.isActive()),console.error("üö® Stack trace:",new Error().stack),this.timerEvent&&this.timerEvent.destroy(),this.pongClient&&this.pongClient.disconnect(),console.error("üö® REDIRECTING TO BEARPARK IN 30 SECONDS..."),console.error("üö® YOU HAVE 30 SECONDS TO READ THE LOGS ABOVE!"),setTimeout(()=>{window.location.href="/"},3e4)}createFloatingParticles(t,e){for(let s=0;s<20;s++){const o=g.Math.Between(0,t),n=g.Math.Between(0,e),i=this.add.graphics(),a=g.Math.RND.pick([16756224,5307003,6819033]);i.fillStyle(a,.4),i.fillCircle(0,0,g.Math.Between(4,8)),i.setPosition(o,n),i.setBlendMode(g.BlendModes.ADD),this.tweens.add({targets:i,y:n-g.Math.Between(100,200),alpha:{from:.4,to:0},duration:g.Math.Between(3e3,5e3),repeat:-1,delay:g.Math.Between(0,2e3),onRepeat:()=>{i.y=e+10,i.x=g.Math.Between(0,t),i.alpha=.4}}),this.tweens.add({targets:i,x:`+=${g.Math.Between(-30,30)}`,duration:g.Math.Between(1e3,2e3),yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}}flashScreen(t=16756224){const e=this.add.rectangle(0,0,this.cameras.main.width,this.cameras.main.height,t,.6);e.setOrigin(0),e.setDepth(5e3),this.tweens.add({targets:e,alpha:0,duration:300,ease:"Power2",onComplete:()=>{e.destroy()}})}setupCanvasClickHandler(t,e){this.time.delayedCall(100,()=>{this.canvasClickHandler=s=>{const o=this.game.canvas.getBoundingClientRect(),n=1280/o.width,i=720/o.height,a=(s.clientX-o.left)*n,r=(s.clientY-o.top)*i;console.log(`üñ±Ô∏è [BETTING] Canvas click at (${a}, ${r})`);const l=t/2,c=610,d=300,h=60;if(a>=l-d/2&&a<=l+d/2&&r>=c-h/2&&r<=c+h/2){console.log("üñ±Ô∏è [BETTING] READY button clicked"),this.isReady||this.readyUp();return}if(!this.isReady){const y=[0,10,20,50,100,200,500,1e3].filter(b=>b<=this.myHoneyBalance);y.length===0&&y.push(0);const T=-((y.length-1)*120)/2;y.forEach((b,A)=>{const P=t/2+T+A*120;if(a>=P-100/2&&a<=P+100/2&&r>=410-50/2&&r<=410+50/2){console.log(`üñ±Ô∏è [BETTING] Bet button clicked: ${b}`),this.selectBet(b);return}})}},this.game.canvas.addEventListener("pointerdown",this.canvasClickHandler),console.log("‚úÖ [BETTING] Canvas click handler installed")})}shutdown(){console.log(`üõëüõëüõë [BETTING LOBBY ${this.instanceId}] SHUTDOWN CALLED!`),console.log("üõë Scene active:",this.scene.isActive()),this.timerEvent&&(this.timerEvent.destroy(),console.log(`üõë [BETTING LOBBY ${this.instanceId}] Timer destroyed`)),this.canvasClickHandler&&(this.game.canvas.removeEventListener("pointerdown",this.canvasClickHandler),this.canvasClickHandler=null,console.log(`‚úÖ [BETTING LOBBY ${this.instanceId}] Removed canvas click handler`)),this.pongClient&&(console.log(`üõë [BETTING LOBBY ${this.instanceId}] Removing ALL network listeners...`),this.pongClient.off("opponent_bet_set"),console.log("  ‚úÖ Removed opponent_bet_set"),this.pongClient.off("opponent_ready"),console.log("  ‚úÖ Removed opponent_ready"),this.pongClient.off("final_bet_amount"),console.log("  ‚úÖ Removed final_bet_amount"),this.pongClient.off("betting_timeout"),console.log("  ‚úÖ Removed betting_timeout"),this.pongClient.off("countdown"),console.log("  ‚úÖ Removed countdown"),this.pongClient.off("opponent_disconnected"),console.log("  ‚úÖ Removed opponent_disconnected"),console.log(`‚úÖ [BETTING LOBBY ${this.instanceId}] ALL network listeners removed!`)),console.log(`üõë [BETTING LOBBY ${this.instanceId}] SHUTDOWN COMPLETE!`)}}const f={CANVAS_WIDTH:1280,CANVAS_HEIGHT:720,PADDLE_WIDTH:20,PADDLE_HEIGHT:120,BALL_SIZE:20,PADDLE_MAX_VELOCITY:45,PADDLE_SNAP_FACTOR:.3,INITIAL_BALL_SPEED:8,MAX_BALL_SPEED:35,WINNING_SCORE:3};class C extends g.GameObjects.Container{paddleRect;glowOuter;glowMid;borderYellow;borderGreen;borderPurple;ghostY=0;visualY=0;lastVisualY=0;keyboardVelocity=0;keyboardAcceleration=0;lastPointerY=0;lastTrailTime=0;color;isLocalPlayer=!1;isUsingPointer=!1;pointerDeadzone=.5;hitCombo=0;isCharged=!1;chargeTween=null;constructor(t,e,s,o=16777215){super(t,e,s),this.color=o,this.ghostY=s,this.visualY=s,this.lastVisualY=s,this.glowOuter=t.add.rectangle(0,0,f.PADDLE_WIDTH+20,f.PADDLE_HEIGHT+20,16777215,.15),this.add(this.glowOuter),this.glowMid=t.add.rectangle(0,0,f.PADDLE_WIDTH+12,f.PADDLE_HEIGHT+12,16777215,.3),this.add(this.glowMid),this.borderYellow=t.add.rectangle(0,0,f.PADDLE_WIDTH+8,f.PADDLE_HEIGHT+8,16692481,.9),this.add(this.borderYellow),this.borderGreen=t.add.rectangle(0,0,f.PADDLE_WIDTH+5,f.PADDLE_HEIGHT+5,503304,.9),this.add(this.borderGreen),this.borderPurple=t.add.rectangle(0,0,f.PADDLE_WIDTH+2,f.PADDLE_HEIGHT+2,6819033,.9),this.add(this.borderPurple),this.paddleRect=t.add.rectangle(0,0,f.PADDLE_WIDTH,f.PADDLE_HEIGHT,o),this.add(this.paddleRect),t.add.existing(this),this.setDepth(10)}updateKeyboardInput(t,e){(t||e)&&(this.isUsingPointer=!1),t?(this.keyboardVelocity>=0&&(this.keyboardVelocity=-8),this.keyboardAcceleration=-.25):e?(this.keyboardVelocity<=0&&(this.keyboardVelocity=8),this.keyboardAcceleration=.25):(this.keyboardVelocity=0,this.keyboardAcceleration=0),this.ghostY+=this.keyboardVelocity,this.keyboardVelocity+=this.keyboardAcceleration,this.keyboardVelocity=g.Math.Clamp(this.keyboardVelocity,-45,f.PADDLE_MAX_VELOCITY),this.ghostY=g.Math.Clamp(this.ghostY,f.PADDLE_HEIGHT/2,f.CANVAS_HEIGHT-f.PADDLE_HEIGHT/2)}updatePointerInput(t,e){if(!e){this.isUsingPointer=!1;return}Math.abs(t-this.lastPointerY)<this.pointerDeadzone&&this.lastPointerY!==0||(this.isUsingPointer=!0,this.lastPointerY=t,this.keyboardVelocity=0,this.keyboardAcceleration=0,this.ghostY=t,this.ghostY=g.Math.Clamp(this.ghostY,f.PADDLE_HEIGHT/2,f.CANVAS_HEIGHT-f.PADDLE_HEIGHT/2))}update(){if(this.isUsingPointer)this.visualY=this.ghostY;else{const t=f.PADDLE_SNAP_FACTOR;this.visualY+=(this.ghostY-this.visualY)*t}this.setY(this.visualY),this.isUsingPointer?(this.paddleRect.setScale(1,1),this.borderPurple.setScale(1,1),this.borderGreen.setScale(1,1),this.borderYellow.setScale(1,1),this.glowOuter.setAlpha(.15),this.glowMid.setAlpha(.3)):(this.updateSquashStretch(),this.updateGlowFromSpeed(),this.updateMotionBlur()),this.isLocalPlayer&&this.handleWallBounce(),this.lastVisualY=this.visualY}updatePosition(t){this.ghostY=t}updateSquashStretch(){const t=this.visualY-this.lastVisualY,e=g.Math.Clamp(Math.abs(t)/10,0,.15);Math.abs(t)>1?(this.paddleRect.setScale(1-e*.5,1+e),this.borderPurple.setScale(1-e*.5,1+e),this.borderGreen.setScale(1-e*.5,1+e),this.borderYellow.setScale(1-e*.5,1+e)):(this.paddleRect.setScale(1,1),this.borderPurple.setScale(1,1),this.borderGreen.setScale(1,1),this.borderYellow.setScale(1,1))}updateGlowFromSpeed(){const t=Math.abs(this.keyboardVelocity),e=g.Math.Clamp(t/35,.15,.6);this.glowOuter.setAlpha(e),this.glowMid.setAlpha(e*1.5)}updateMotionBlur(){const t=this.scene.time.now,e=Math.abs(this.visualY-this.lastVisualY);if(e>3&&t-this.lastTrailTime>30){const s=g.Math.Clamp(e/20,0,.4),o=this.scene.add.rectangle(this.x,this.lastVisualY,f.PADDLE_WIDTH,f.PADDLE_HEIGHT,this.color,s);this.scene.tweens.add({targets:o,alpha:0,duration:100,ease:"Power2",onComplete:()=>o.destroy()}),this.lastTrailTime=t}}handleWallBounce(){const t=f.PADDLE_HEIGHT/2,e=f.CANVAS_HEIGHT-f.PADDLE_HEIGHT/2;(this.ghostY<=t||this.ghostY>=e)&&(this.ghostY=g.Math.Clamp(this.ghostY,t,e),this.keyboardVelocity*=-.3,this.scene.cameras.main.shake(50,.002),this.flashPaddle(16711680,50))}flashPaddle(t,e){const s=this.paddleRect.fillColor;this.paddleRect.setFillStyle(t),this.scene.time.delayedCall(e,()=>{this.paddleRect.setFillStyle(s)})}getTop(){return this.y-f.PADDLE_HEIGHT/2}getBottom(){return this.y+f.PADDLE_HEIGHT/2}getGhostY(){return this.ghostY}setLocalPlayer(t){this.isLocalPlayer=t}onHit(){this.hitCombo++,this.isCharged=!0,this.chargeTween&&this.chargeTween.stop();const e=.5+Math.min(this.hitCombo/5,1)*.4;this.glowOuter.setAlpha(e),this.glowMid.setAlpha(e+.2);const s=Math.min(this.hitCombo,5),o=100;for(let n=0;n<s;n++)this.scene.time.delayedCall(n*o,()=>{this.scene.tweens.add({targets:[this.glowOuter,this.glowMid],scale:1.15,duration:o/2,ease:"Quad.easeOut",yoyo:!0})});this.chargeTween=this.scene.tweens.add({targets:[this.glowOuter,this.glowMid],alpha:.15,duration:500,delay:s*o,ease:"Power2",onComplete:()=>{this.isCharged=!1,this.chargeTween=null}}),this.scene.tweens.add({targets:[this.paddleRect,this.borderPurple,this.borderGreen,this.borderYellow],scaleY:.9,duration:30,ease:"Quad.easeOut",yoyo:!0})}resetCharge(){this.hitCombo=0,this.isCharged=!1,this.chargeTween&&(this.chargeTween.stop(),this.chargeTween=null),this.glowOuter.setAlpha(.15),this.glowMid.setAlpha(.3),this.glowOuter.setScale(1),this.glowMid.setScale(1)}getComboCount(){return this.hitCombo}}class W extends g.GameObjects.Container{ballCore;glowOuter;glowMid;glowInner;currentSpeed=f.INITIAL_BALL_SPEED;lastX=0;lastY=0;lastVelocityX=0;pulseTime=0;lastTrailTime=0;COLOR_STOPS=[{speed:6,color:16777215},{speed:8,color:16775388},{speed:10,color:16692481},{speed:11,color:16753920},{speed:13,color:16747520},{speed:15,color:16729344}];constructor(t,e,s){super(t,e,s),this.lastX=e,this.lastY=s,this.glowInner=t.add.arc(0,0,f.BALL_SIZE/2+3,0,360,!1,16777215,0),this.add(this.glowInner),this.glowOuter=t.add.arc(0,0,f.BALL_SIZE/2+12,0,360,!1,16777215,.15),this.add(this.glowOuter),this.glowMid=t.add.arc(0,0,f.BALL_SIZE/2+6,0,360,!1,16777215,.3),this.add(this.glowMid),this.ballCore=t.add.arc(0,0,f.BALL_SIZE/2,0,360,!1,16777215),this.add(this.ballCore),t.add.existing(this),this.setDepth(15)}updatePosition(t,e,s,o){this.setPosition(t,e),s!==void 0&&o!==void 0&&(this.currentSpeed=Math.sqrt(s*s+o*o),this.lastVelocityX!==0&&Math.sign(s)!==Math.sign(this.lastVelocityX)&&this.playBounceEffect(),this.lastVelocityX=s),this.updateVisualEvolution(),this.autoTrail(),this.lastX=t,this.lastY=e}updateVisualEvolution(){const t=this.currentSpeed,e=this.interpolateColor(t);this.ballCore.setFillStyle(e),this.glowOuter.setFillStyle(e),this.glowMid.setFillStyle(e);const s=this.getGlowIntensity(t),o=this.getPulseValue(t);if(this.glowOuter.setAlpha(s.outer+o*.1),this.glowMid.setAlpha(s.mid+o*.15),t>=13){this.glowInner.setAlpha(.7+o*.3);const n=Math.min((t-13)/2,1);this.glowOuter.setScale(1+n*.3),this.glowMid.setScale(1+n*.2)}else this.glowInner.setAlpha(0),this.glowOuter.setScale(1),this.glowMid.setScale(1);this.pulseTime+=.016}interpolateColor(t){t=Math.max(6,Math.min(15,t));let e=this.COLOR_STOPS[0],s=this.COLOR_STOPS[this.COLOR_STOPS.length-1];for(let u=0;u<this.COLOR_STOPS.length-1;u++)if(t>=this.COLOR_STOPS[u].speed&&t<=this.COLOR_STOPS[u+1].speed){e=this.COLOR_STOPS[u],s=this.COLOR_STOPS[u+1];break}const o=(t-e.speed)/(s.speed-e.speed),n=e.color>>16&255,i=e.color>>8&255,a=e.color&255,r=s.color>>16&255,l=s.color>>8&255,c=s.color&255,d=Math.round(n+(r-n)*o),h=Math.round(i+(l-i)*o),p=Math.round(a+(c-a)*o);return d<<16|h<<8|p}getGlowIntensity(t){return t<8?{outer:.15,mid:.3}:t<11?{outer:.25,mid:.45}:t<13?{outer:.5,mid:.65}:{outer:.7,mid:.85}}getPulseValue(t){const e=this.map(t,8,35,.5,3),s=this.map(t,8,35,.1,.4);return Math.sin(this.pulseTime*e*Math.PI*2)*s}autoTrail(){const t=this.scene.time.now,e=this.currentSpeed;let s=100;e>=13?s=50:e>=11?s=60:e>=8&&(s=80),t-this.lastTrailTime>s&&(this.addTrailEffect(),this.lastTrailTime=t)}addTrailEffect(){const t=this.currentSpeed,e=this.interpolateColor(t),s=this.map(t,8,35,f.BALL_SIZE/2+4,f.BALL_SIZE/2+10),o=this.map(t,8,35,.15,.4),n=this.map(t,8,35,200,120),i=this.scene.add.arc(this.x,this.y,s,0,360,!1,e,o);this.scene.tweens.add({targets:i,alpha:0,duration:n,ease:"Power2",onComplete:()=>{i.destroy()}})}playBounceEffect(){const t=this.interpolateColor(this.currentSpeed),e=this.currentSpeed/f.MAX_BALL_SPEED;this.scene.tweens.add({targets:this,scaleX:.6,scaleY:1.4,duration:50,ease:"Quad.easeOut",yoyo:!0,onComplete:()=>{this.scene.tweens.add({targets:this,scaleX:1.3,scaleY:.7,duration:60,ease:"Quad.easeOut",yoyo:!0})}}),this.scene.time.addEvent({delay:16,callback:()=>{this.scene.time.addEvent({delay:16,callback:()=>{}})}});const s=this.map(e,0,1,.3,.8);this.scene.tweens.add({targets:this.ballCore,alpha:s,duration:30,ease:"Quad.easeOut",yoyo:!0});const o=this.scene.add.arc(this.x,this.y,f.BALL_SIZE/2+5,0,360,!1,16777215,.9);this.scene.tweens.add({targets:o,alpha:0,duration:100,ease:"Power2",onComplete:()=>o.destroy()});const n=this.scene.add.arc(this.x,this.y,f.BALL_SIZE/2,0,360,!1,t,.8),i=this.map(e,0,1,2,4),a=this.map(e,0,1,250,150);this.scene.tweens.add({targets:n,scale:i,alpha:0,duration:a,ease:"Quad.easeOut",onComplete:()=>n.destroy()}),this.createParticleExplosion(t,e);const r=this.map(e,0,1,.002,.012),l=this.map(e,0,1,80,120);this.scene.cameras.main.shake(l,r)}createParticleExplosion(t,e){const s=[16692481,6819033,503304,t],o=Math.round(this.map(e,0,1,10,20));for(let n=0;n<o;n++){const i=g.Utils.Array.GetRandom(s),a=Math.PI*2*n/o+g.Math.FloatBetween(-.3,.3),r=this.map(e,0,1,50,200),l=Math.cos(a)*r,c=Math.sin(a)*r,d=this.map(e,0,1,3,8),h=this.scene.add.arc(this.x,this.y,d,0,360,!1,i,1);this.scene.tweens.add({targets:h,x:h.x+l,y:h.y+c,alpha:0,scale:0,duration:this.map(e,0,1,400,300),ease:"Power2",onComplete:()=>h.destroy()})}}map(t,e,s,o,n){return o+(n-o)*((t-e)/(s-e))}getCurrentSpeed(){return this.currentSpeed}}class k extends g.GameObjects.Container{bannerBackground=null;constructor(t,e,s){const o=e==="left"?f.CANVAS_WIDTH/4:f.CANVAS_WIDTH*3/4;super(t,o,80),t.add.existing(this);const i=300,a=60;this.bannerBackground=t.add.rectangle(0,0,i,a,0,.3),this.add(this.bannerBackground);const r=t.add.text(0,0,s,{fontSize:"24px",color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3});r.setOrigin(.5),this.add(r),this.setAlpha(.85)}show(){this.setAlpha(0),this.scene.tweens.add({targets:this,alpha:.85,duration:500,ease:"Power2"})}hide(){this.scene.tweens.add({targets:this,alpha:0,duration:300,ease:"Power2"})}}var x=(v=>(v.TIME_FREEZE="time_freeze",v.PADDLE_DASH="paddle_dash",v.POWER_HIT="power_hit",v))(x||{});const G={time_freeze:{type:"time_freeze",name:"TIME FREEZE",icon:"‚è∞",description:"Slow-mo for 3 seconds",cooldown:1/0},paddle_dash:{type:"paddle_dash",name:"PADDLE DASH",icon:"üöÄ",description:"Teleport to ball",cooldown:1/0},power_hit:{type:"power_hit",name:"POWER HIT",icon:"üí™",description:"Next hit is MEGA",cooldown:1/0}};class F extends g.Scene{pongClient=null;opponent=null;yourSide="left";betAmount=0;leftPaddle=null;rightPaddle=null;ball=null;leftBanner=null;rightBanner=null;countdownText=null;centerLine=null;background=null;audioManager=null;cursors=null;wasd=null;isMouseDown=!1;boundMouseDown=null;boundMouseMove=null;boundMouseUp=null;lastBallVelocityX=0;lastScore1=0;lastScore2=0;powerHitActive=!1;powerHitGlow=null;powerHitGlow2=null;powerHitParticles=null;powerHitBorder=null;gameStartTime=0;constructor(){super({key:"PongGameScene"})}init(t){this.pongClient=t.pongClient,this.opponent=t.opponent,this.yourSide=t.yourSide,this.betAmount=t.betAmount||0,console.log(`üí∞ [GAME SCENE] Received betAmount: ${this.betAmount}`)}preload(){this.load.image("background","https://files.catbox.moe/qnp7wc.png"),this.audioManager||(this.audioManager=new L(this)),this.audioManager.preload()}create(){const{width:t,height:e}=this.cameras.main;this.attemptFullscreen(),this.audioManager=this.game.registry.get("globalAudioManager"),this.audioManager?console.log("üéµ Using global audio manager - music continues playing"):(this.audioManager=new L(this),this.audioManager.create(),this.audioManager.playBackgroundMusic(),this.game.registry.set("globalAudioManager",this.audioManager),console.log("üéµ Created fallback audio manager in game scene")),this.background=this.add.image(0,0,"background").setOrigin(0),this.background.setDisplaySize(t,e);const s=8;this.add.rectangle(0,0,t,s,16692481).setOrigin(0),this.add.rectangle(0,e-s,t,s,16692481).setOrigin(0),this.drawCenterLine();const o=50+f.PADDLE_WIDTH/2,n=t-50-f.PADDLE_WIDTH/2;this.yourSide==="left"?(this.leftPaddle=new C(this,o,e/2,6819033),this.leftPaddle.setLocalPlayer(!0),this.rightPaddle=new C(this,n,e/2,503304),this.rightPaddle.setLocalPlayer(!1)):(this.leftPaddle=new C(this,o,e/2,6819033),this.leftPaddle.setLocalPlayer(!1),this.rightPaddle=new C(this,n,e/2,503304),this.rightPaddle.setLocalPlayer(!0)),this.ball=new W(this,t/2,e/2),this.createPlayerBanners(),this.countdownText=this.add.text(t/2,e/2,"",{fontSize:"180px",color:"#FFD700",fontFamily:'"Luckiest Guy", cursive',stroke:"#000000",strokeThickness:12,shadow:{offsetX:6,offsetY:6,color:"#000000",blur:10,fill:!0}}),this.countdownText.setOrigin(.5),this.countdownText.setDepth(1e3),this.setupInput(),this.setupServerHandlers(),this.scene.launch("PongUIScene",{opponent:this.opponent,yourSide:this.yourSide})}drawCenterLine(){this.centerLine=this.add.graphics(),this.centerLine.lineStyle(2,4473924);const t=20,e=15,s=this.cameras.main.width/2;for(let o=0;o<this.cameras.main.height;o+=t+e)this.centerLine.lineBetween(s,o,s,o+t)}attemptFullscreen(){try{if(window.isIOS){console.log("üì± iOS detected - skipping fullscreen (use viewport instead)");return}if(typeof window.enterFullscreen=="function")window.enterFullscreen(),console.log("üì± Game scene triggering fullscreen mode");else{const t=document.documentElement;t.requestFullscreen?t.requestFullscreen().catch(e=>{console.log("Fullscreen request failed:",e)}):t.webkitRequestFullscreen&&t.webkitRequestFullscreen()}}catch(t){console.log("Could not enter fullscreen:",t)}}createPlayerBanners(){this.yourSide==="left"?(this.leftBanner=new k(this,"left",E.getCurrentUserDisplayName()),this.rightBanner=new k(this,"right",this.opponent?.displayName||"Opponent")):(this.leftBanner=new k(this,"left",this.opponent?.displayName||"Opponent"),this.rightBanner=new k(this,"right",E.getCurrentUserDisplayName())),this.leftBanner?.show(),this.rightBanner?.show()}setupInput(){this.cursors=this.input.keyboard?.createCursorKeys()||null,this.wasd=this.input.keyboard?.addKeys({up:g.Input.Keyboard.KeyCodes.W,down:g.Input.Keyboard.KeyCodes.S}),this.boundMouseDown=t=>{this.isMouseDown=!0;const e=this.yourSide==="left"?this.leftPaddle:this.rightPaddle,s=this.game.canvas,o=s.getBoundingClientRect(),n=s.height/o.height;let i;t instanceof MouseEvent?i=t.clientY:i=t.touches[0]?.clientY||0;const a=(i-o.top)*n;e?.updatePointerInput(a,!0),t.stopPropagation()},this.boundMouseMove=t=>{if(this.isMouseDown){const e=this.yourSide==="left"?this.leftPaddle:this.rightPaddle,s=this.game.canvas,o=s.getBoundingClientRect(),n=s.height/o.height;let i;t instanceof MouseEvent?i=t.clientY:i=t.touches[0]?.clientY||0;const a=(i-o.top)*n;e?.updatePointerInput(a,!0),t.stopPropagation()}},this.boundMouseUp=t=>{this.isMouseDown=!1,(this.yourSide==="left"?this.leftPaddle:this.rightPaddle)?.updatePointerInput(0,!1),t&&t.stopPropagation()},window.addEventListener("mousedown",this.boundMouseDown,!0),window.addEventListener("mousemove",this.boundMouseMove,!0),window.addEventListener("mouseup",this.boundMouseUp,!0),window.addEventListener("touchstart",this.boundMouseDown,!0),window.addEventListener("touchmove",this.boundMouseMove,{passive:!1,capture:!0}),window.addEventListener("touchend",this.boundMouseUp,!0)}setupServerHandlers(){this.pongClient&&(this.pongClient.on("countdown",t=>{this.countdownText||(this.countdownText=this.add.text(this.scale.width/2,this.scale.height/2,"",{fontSize:"180px",color:"#FFD700",fontFamily:'"Luckiest Guy", cursive',stroke:"#000000",strokeThickness:12}).setOrigin(.5),this.countdownText.setDepth(1e3)),t>0?(this.countdownText.setText(t.toString()),this.countdownText.setColor("#FFD700"),this.countdownText.setVisible(!0),this.countdownText.setAlpha(1),this.tweens.add({targets:this.countdownText,scale:{from:3,to:1.2},alpha:{from:0,to:1},duration:400,ease:"Back.easeOut",onComplete:()=>{this.tweens.add({targets:this.countdownText,scale:{from:1.2,to:1},duration:600,ease:"Sine.easeInOut"})}})):(this.countdownText.setText("GO!"),this.countdownText.setColor("#00FF00"),this.countdownText.setVisible(!0),this.countdownText.setAlpha(1),this.gameStartTime||(this.gameStartTime=Date.now()),this.tweens.add({targets:this.countdownText,scale:{from:2.7,to:1},alpha:{from:0,to:1},duration:300,ease:"Back.easeOut",onComplete:()=>{this.tweens.add({targets:this.countdownText,alpha:0,scale:1.35,duration:500,delay:200,ease:"Power2",onComplete:()=>{this.countdownText?.destroy(),this.countdownText=null}})}}))}),this.pongClient.on("game_state",t=>{const e=this.scene.get("PongUIScene");e&&e.updateScore&&e.updateScore(t.score1,t.score2);const s=Math.sqrt(t.ballVelocityX*t.ballVelocityX+t.ballVelocityY*t.ballVelocityY);e&&e.updateSpeedMeter&&e.updateSpeedMeter(s),this.ball&&this.ball.updatePosition(t.ballX,t.ballY,t.ballVelocityX,t.ballVelocityY),this.yourSide==="left"?this.rightPaddle&&this.rightPaddle.updatePosition(t.paddle2Y):this.leftPaddle&&this.leftPaddle.updatePosition(t.paddle1Y)}),this.pongClient.on("powerups_refreshed",()=>{console.log("üîÑ Power-ups refreshed message received!");const t=this.scene.get("PongUIScene");t&&t.refreshPowerups&&t.refreshPowerups()}),this.pongClient.on("game_over",t=>{console.log("üèÜ Game over event received:",t);const e=t.betAmount??this.betAmount;console.log(`üí∞ [GAME SCENE] Using betAmount for game over: ${e} (server: ${t.betAmount}, scene: ${this.betAmount})`),this.handleGameOver(t.winner,t.finalScore,e)}))}update(){if(this.handlePaddleInput(),this.leftPaddle?.update(),this.rightPaddle?.update(),this.powerHitActive){const t=this.yourSide==="left"?this.leftPaddle:this.rightPaddle;t&&(this.powerHitGlow&&this.powerHitGlow.setPosition(t.x,t.y),this.powerHitGlow2&&this.powerHitGlow2.setPosition(t.x,t.y),this.powerHitParticles&&this.powerHitParticles.setPosition(t.x,t.y))}}shutdown(){this.boundMouseDown&&(window.removeEventListener("mousedown",this.boundMouseDown,!0),window.removeEventListener("touchstart",this.boundMouseDown,!0)),this.boundMouseMove&&(window.removeEventListener("mousemove",this.boundMouseMove,!0),window.removeEventListener("touchmove",this.boundMouseMove,{passive:!1,capture:!0})),this.boundMouseUp&&(window.removeEventListener("mouseup",this.boundMouseUp,!0),window.removeEventListener("touchend",this.boundMouseUp,!0))}handlePaddleInput(){if(!this.pongClient)return;const t=this.yourSide==="left"?this.leftPaddle:this.rightPaddle;if(!t)return;const e=!!(this.cursors?.up.isDown||this.wasd?.up.isDown),s=!!(this.cursors?.down.isDown||this.wasd?.down.isDown);t.updateKeyboardInput(e,s),this.pongClient.movePaddle(t.getGhostY())}handleGameOver(t,e,s=0){console.log("Game over!",t,e,"Bet amount:",s);const o=t===this.yourSide;this.scene.stop("PongUIScene"),this.scene.start("PongGameOverScene",{didWin:o,yourScore:this.yourSide==="left"?e.left:e.right,opponentScore:this.yourSide==="left"?e.right:e.left,opponent:this.opponent,pongClient:this.pongClient,gameStartTime:this.gameStartTime,betAmount:s}),this.scene.stop()}handleOpponentDisconnect(){console.log("Opponent disconnected"),this.add.text(this.cameras.main.width/2,this.cameras.main.height/2,`Opponent Disconnected

You Win by Default!`,{fontSize:"32px",color:"#ffffff",align:"center"}).setOrigin(.5),this.time.delayedCall(3e3,()=>{this.yourSide==="left"?this.leftPaddle?.getTop():this.rightPaddle?.getTop();const e=parseInt(localStorage.getItem("bearPongCurrentBet")||"0");this.handleGameOver(this.yourSide,{left:this.yourSide==="left"?f.WINNING_SCORE:0,right:this.yourSide==="right"?f.WINNING_SCORE:0},e)})}activateUltimate(t){console.log(`üöÄ Activating ultimate ability: ${t}`),this.pongClient?(this.pongClient.send({type:"use_ultimate",abilityType:t}),console.log("‚úÖ Sent use_ultimate message to server")):console.error("‚ùå No pongClient available to send ultimate!")}activateTimeFreeze(){console.log("üöÄ TIME FREEZE ACTIVATED - ULTRA SLOW-MO!");const{width:t,height:e}=this.cameras.main,s=this.add.rectangle(0,0,t,e,52479,.5);s.setOrigin(0),s.setDepth(1e3),s.setBlendMode(g.BlendModes.MULTIPLY),this.tweens.add({targets:s,alpha:{from:.4,to:.6},duration:800,yoyo:!0,repeat:-1});const o=this.add.graphics();o.lineStyle(15,65535,1),o.strokeRect(0,0,t,e),o.setDepth(1001),this.tweens.add({targets:o,alpha:{from:.5,to:1},duration:500,yoyo:!0,repeat:-1});const n=this.add.text(t/2,e/2-100,"‚è∞ SLOW-MO ‚è∞",{fontSize:"96px",color:"#00ffff",fontFamily:"Luckiest Guy",fontStyle:"bold",stroke:"#0044aa",strokeThickness:8});n.setOrigin(.5),n.setDepth(1002),n.setAlpha(0),this.tweens.add({targets:n,alpha:1,scale:{from:.5,to:1.2},duration:400,ease:"Back.easeOut"}),this.tweens.add({targets:n,scale:{from:1.2,to:1.4},duration:1e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});const i=this.add.graphics();i.fillStyle(0,0),i.fillRect(0,0,t,e);const a=this.add.circle(t/2,e/2,Math.max(t,e)*.7,0,0);a.setBlendMode(g.BlendModes.MULTIPLY),a.setDepth(999),this.tweens.add({targets:a,alpha:.5,duration:300});const r=this.add.particles(t/2,0,"background",{x:{min:0,max:t},y:{min:-50,max:0},speedY:{min:30,max:80},speedX:{min:-20,max:20},scale:{start:.15,end:0},alpha:{start:.8,end:0},tint:65535,blendMode:g.BlendModes.ADD,lifespan:3e3,frequency:50,quantity:2});r.setDepth(1003);const l=this.add.rectangle(0,0,t,e,16711680,.08);l.setOrigin(0),l.setDepth(1004),l.setBlendMode(g.BlendModes.ADD);const c=this.add.rectangle(3,0,t,e,255,.08);c.setOrigin(0),c.setDepth(1004),c.setBlendMode(g.BlendModes.ADD),this.cameras.main.shake(300,.003,!0),this.time.delayedCall(4e3,()=>{this.tweens.add({targets:[s,o,n,a,l,c],alpha:0,duration:500,onComplete:()=>{s.destroy(),o.destroy(),n.destroy(),a.destroy(),l.destroy(),c.destroy()}}),r.stop(),this.time.delayedCall(3e3,()=>r.destroy()),console.log("‚è∞ TIME FREEZE ended")})}activatePaddleDash(){console.log("üöÄ PADDLE DASH ACTIVATED!");const t=this.yourSide==="left"?this.leftPaddle:this.rightPaddle;if(!t||!this.ball)return;const e=this.ball.y;this.createDashParticles(t.y),this.tweens.add({targets:t,y:e,duration:100,ease:"Power2",onComplete:()=>{this.createDashParticles(e)}});const s=this.add.rectangle(0,0,this.cameras.main.width,this.cameras.main.height,16777215,.5);s.setOrigin(0),this.tweens.add({targets:s,alpha:0,duration:200,onComplete:()=>s.destroy()})}createDashParticles(t){const e=this.yourSide==="left"?50+f.PADDLE_WIDTH/2:this.cameras.main.width-50-f.PADDLE_WIDTH/2;for(let s=0;s<20;s++){const o=Math.PI*2*s/20,n=Math.cos(o)*200,i=Math.sin(o)*200,a=this.add.arc(e,t,5,0,360,!1,16692481,1);this.tweens.add({targets:a,x:a.x+n,y:a.y+i,alpha:0,scale:0,duration:400,ease:"Power2",onComplete:()=>a.destroy()})}}activatePowerHit(){console.log("üöÄ POWER HIT ACTIVATED!"),this.powerHitActive=!0;const t=this.yourSide==="left"?this.leftPaddle:this.rightPaddle;if(!t)return;this.powerHitGlow&&(this.tweens.killTweensOf(this.powerHitGlow),this.powerHitGlow.destroy()),this.powerHitGlow2&&(this.tweens.killTweensOf(this.powerHitGlow2),this.powerHitGlow2.destroy()),this.powerHitParticles&&this.powerHitParticles.stop(),this.powerHitBorder&&(this.tweens.killTweensOf(this.powerHitBorder),this.powerHitBorder.destroy()),this.powerHitGlow=this.add.rectangle(t.x,t.y,f.PADDLE_WIDTH+60,f.PADDLE_HEIGHT+60,16711680,.8),this.powerHitGlow.setDepth(100),this.powerHitGlow.setBlendMode(g.BlendModes.ADD),this.powerHitGlow2=this.add.rectangle(t.x,t.y,f.PADDLE_WIDTH+100,f.PADDLE_HEIGHT+100,16755200,.5),this.powerHitGlow2.setDepth(99),this.powerHitGlow2.setBlendMode(g.BlendModes.ADD),this.tweens.add({targets:this.powerHitGlow,alpha:{from:.8,to:1},scale:{from:1,to:1.4},duration:250,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.tweens.add({targets:this.powerHitGlow2,alpha:{from:.3,to:.7},scale:{from:1,to:1.6},duration:400,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});const{width:e,height:s}=this.cameras.main;this.powerHitBorder=this.add.graphics(),this.powerHitBorder.lineStyle(12,16711680,1),this.powerHitBorder.strokeRect(0,0,e,s),this.powerHitBorder.setDepth(1e3),this.tweens.add({targets:this.powerHitBorder,alpha:{from:.4,to:1},duration:300,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.cameras.main.shake(200,.002,!0);const o=this.add.particles(t.x,t.y,"background",{speed:{min:50,max:150},scale:{start:.3,end:0},alpha:{start:1,end:0},tint:[16711680,16729088,16755200],blendMode:g.BlendModes.ADD,lifespan:500,frequency:30,quantity:3,emitZone:{type:"edge",source:new g.Geom.Rectangle(-10,-60,20,120),quantity:24}});o.setDepth(101),this.powerHitParticles=o,console.log("üí• POWER HIT VISUAL EFFECTS ACTIVATED - SUPER INTENSE MODE!")}playUltimateVisualEffects(t,e){switch(t){case x.TIME_FREEZE:this.activateTimeFreeze();break;case x.POWER_HIT:(e==="left"&&this.yourSide==="left"||e==="right"&&this.yourSide==="right")&&this.activatePowerHit();break}}}class U extends g.Scene{leftScoreText=null;rightScoreText=null;comboText=null;comboTween=null;pauseButton=null;muteButton=null;muteIcon=null;speedMeter=null;speedFill=null;speedText=null;speedWarning=null;currentSpeed=6;stakesText=null;ultimateButtons=new Map;ultimateUsed=new Set;opponent=null;yourSide="left";myAvatarUrl=null;opponentAvatarUrl=null;myAvatarIsAnimated=!1;opponentAvatarIsAnimated=!1;myEquippedRing=null;opponentEquippedRing=null;canvasClickHandler=null;constructor(){super({key:"PongUIScene"})}init(t){this.opponent=t.opponent,this.yourSide=t.yourSide,this.myAvatarUrl=E.getAvatarUrl(),this.myAvatarIsAnimated=localStorage.getItem("avatar_is_animated")==="true",this.opponentAvatarUrl=this.opponent?.avatarUrl||null,this.opponentAvatarIsAnimated=this.opponent?.avatarIsAnimated||!1,this.opponentEquippedRing=this.opponent?.equippedCosmetics?.ring||null,console.log("‚úÖ Opponent equipped ring (from server data):",this.opponentEquippedRing)}async waitForCosmetics(){await this.fetchMyEquippedCosmetics()}async fetchMyEquippedCosmetics(){const t=window.location.hostname==="localhost"?"http://localhost:3000":window.location.origin,e=localStorage.getItem("xaman_wallet_address");if(e)try{const o=await(await fetch(`${t}/api/cosmetics/equipped/${e}`)).json();o.success&&o.equipped.ring&&(this.myEquippedRing=o.equipped.ring,console.log("‚úÖ My equipped ring:",this.myEquippedRing))}catch(s){console.error("Failed to fetch my equipped cosmetics:",s)}}async create(){const{width:t,height:e}=this.cameras.main;this.ultimateUsed.clear(),this.ultimateButtons.clear(),await this.waitForCosmetics(),this.leftScoreText=this.add.text(t/4,80,"0",{fontSize:"96px",color:"#4a90e2",fontStyle:"bold"}),this.leftScoreText.setOrigin(.5),this.leftScoreText.setAlpha(.6),this.rightScoreText=this.add.text(t*3/4,80,"0",{fontSize:"96px",color:"#ff6b6b",fontStyle:"bold"}),this.rightScoreText.setOrigin(.5),this.rightScoreText.setAlpha(.6),this.createPauseButton(),this.createMuteButton(),this.createSpeedMeter(),this.createStakesDisplay(),this.createUltimateButton(),this.createAvatarDisplays(),this.input.keyboard?.on("keydown-ESC",()=>{this.pauseGame()}),this.input.keyboard?.on("keydown-LEFT",()=>{console.log("‚å®Ô∏è LEFT arrow key pressed - activating TIME_FREEZE");const o=this.ultimateButtons.get(x.TIME_FREEZE);o&&this.useUltimate(x.TIME_FREEZE,o)}),this.input.keyboard?.on("keydown-RIGHT",()=>{console.log("‚å®Ô∏è RIGHT arrow key pressed - activating POWER_HIT");const o=this.ultimateButtons.get(x.POWER_HIT);o&&this.useUltimate(x.POWER_HIT,o)});const s=this.scene.get("PongGameScene");s&&s.game.canvas&&(this.canvasClickHandler=o=>{const n=s.game.canvas.getBoundingClientRect(),i=1280/n.width,a=720/n.height,r=(o.clientX-n.left)*i,l=(o.clientY-n.top)*a,c=180,d=t/2-c/2,h=t/2+c/2,p=e-70,u=160,m=50;if(r>=d-u/2&&r<=d+u/2&&l>=p-m/2&&l<=p+m/2){const M=this.ultimateButtons.get(x.TIME_FREEZE);M&&this.useUltimate(x.TIME_FREEZE,M);return}if(r>=h-u/2&&r<=h+u/2&&l>=p-m/2&&l<=p+m/2){const M=this.ultimateButtons.get(x.POWER_HIT);M&&this.useUltimate(x.POWER_HIT,M);return}const w=t/2+80+t*.1;if(Math.sqrt((r-w)**2+(l-60)**2)<=30){this.pauseGame();return}const b=t/2-80-t*.1;if(Math.sqrt((r-b)**2+(l-60)**2)<=30){this.toggleMute();return}},s.game.canvas.addEventListener("pointerdown",this.canvasClickHandler))}shutdown(){const t=this.scene.get("PongGameScene");this.canvasClickHandler&&t&&t.game.canvas&&(t.game.canvas.removeEventListener("pointerdown",this.canvasClickHandler),this.canvasClickHandler=null)}createTriColorRing(t,e,s,o,n){const i=[6819033,16756224,503304],a=3,r=Math.PI*2/a;for(let l=0;l<a;l++){const c=l*r-Math.PI/2,d=(l+1)*r-Math.PI/2;t.lineStyle(n,i[l]),t.beginPath(),t.arc(e,s,o,c,d,!1),t.strokePath()}}createPauseButton(){const{width:t}=this.cameras.main;this.pauseButton=this.add.container(t/2+80+t*.1,60);const e=this.add.circle(0,0,30,6819033);e.setInteractive({useHandCursor:!0}),this.pauseButton.add(e);const s=this.add.graphics();this.createTriColorRing(s,0,0,30,4),this.pauseButton.add(s);const o=this.add.rectangle(-6,0,6,20,16692481),n=this.add.rectangle(6,0,6,20,16692481);this.pauseButton.add(o),this.pauseButton.add(n),e.on("pointerdown",()=>{this.pauseGame()}),e.on("pointerover",()=>{this.pauseButton?.setScale(1.1)}),e.on("pointerout",()=>{this.pauseButton?.setScale(1)})}createMuteButton(){const{width:t}=this.cameras.main;this.muteButton=this.add.container(t/2-80-t*.1,60);const e=this.add.circle(0,0,30,6819033);e.setInteractive({useHandCursor:!0}),this.muteButton.add(e);const s=this.add.graphics();this.createTriColorRing(s,0,0,30,4),this.muteButton.add(s),this.muteIcon=this.add.graphics();const n=this.scene.get("PongGameScene")?.audioManager?.isMutedState()||!1;this.updateMuteIcon(n),this.muteButton.add(this.muteIcon),e.on("pointerdown",()=>{this.toggleMute()}),e.on("pointerover",()=>{this.muteButton?.setScale(1.1)}),e.on("pointerout",()=>{this.muteButton?.setScale(1)})}updateMuteIcon(t){this.muteIcon&&(this.muteIcon.clear(),this.muteIcon.fillStyle(16692481),this.muteIcon.fillRect(-12,-6,6,12),this.muteIcon.beginPath(),this.muteIcon.moveTo(-6,-6),this.muteIcon.lineTo(0,-10),this.muteIcon.lineTo(0,10),this.muteIcon.lineTo(-6,6),this.muteIcon.closePath(),this.muteIcon.fillPath(),t?(this.muteIcon.lineStyle(3,16711680),this.muteIcon.beginPath(),this.muteIcon.moveTo(4,-10),this.muteIcon.lineTo(14,0),this.muteIcon.moveTo(14,-10),this.muteIcon.lineTo(4,0),this.muteIcon.strokePath()):(this.muteIcon.lineStyle(2,16692481),this.muteIcon.beginPath(),this.muteIcon.arc(0,0,8,-Math.PI/4,Math.PI/4),this.muteIcon.strokePath(),this.muteIcon.beginPath(),this.muteIcon.arc(0,0,12,-Math.PI/4,Math.PI/4),this.muteIcon.strokePath()))}toggleMute(){const e=this.scene.get("PongGameScene")?.audioManager;if(e){e.toggleMute();const s=e.isMutedState();this.updateMuteIcon(s)}}pauseGame(){const t=this.scene.get("PongGameScene"),e=t?.audioManager;this.scene.pause("PongGameScene"),this.scene.pause(),this.scene.launch("PongPauseScene",{audioManager:e,gameScene:t})}createSpeedMeter(){const{width:t}=this.cameras.main;this.speedMeter=this.add.container(t/2,45);const e=200,s=10,o=this.add.rectangle(0,0,e,s,0,.5);this.speedMeter.add(o),this.speedFill=this.add.rectangle(-e/2,0,0,s,16692481),this.speedFill.setOrigin(0,.5),this.speedMeter.add(this.speedFill),this.speedText=this.add.text(0,-20,"SPEED",{fontSize:"12px",color:"#888888",fontFamily:"Luckiest Guy"}),this.speedText.setOrigin(.5),this.speedMeter.add(this.speedText),this.speedWarning=this.add.text(0,25,"",{fontSize:"18px",color:"#ff4500",fontFamily:"Luckiest Guy",fontStyle:"bold"}),this.speedWarning.setOrigin(.5),this.speedWarning.setAlpha(0),this.speedMeter.add(this.speedWarning)}updateSpeedMeter(t){if(!this.speedFill||!this.speedText||!this.speedWarning)return;this.currentSpeed=t;const e=8,o=Math.min(1,(t-e)/(35-e)),n=200;this.speedFill.width=n*o;let i=16692481,a="";t>=30?(i=16711680,a="üêª BEAR SPEED! üêª",this.speedWarning.setColor("#ff0000")):t>=25?(i=16716947,a="üíé XRP SPEED! üíé",this.speedWarning.setColor("#ff1493")):t>=20?(i=16729344,a="‚ö° OVERDRIVE! ‚ö°",this.speedWarning.setColor("#ff4500")):t>=16?(i=16737792,a="üî• DANGER ZONE! üî•",this.speedWarning.setColor("#ff6600")):t>=12?(i=16747520,a="‚ö†Ô∏è HEATING UP! ‚ö†Ô∏è",this.speedWarning.setColor("#ff8c00")):t>=10&&(i=16753920,a="üå°Ô∏è WARMING UP! üå°Ô∏è",this.speedWarning.setColor("#ffa500")),this.speedFill.setFillStyle(i),a?(this.speedWarning.setText(a),this.tweens.add({targets:this.speedWarning,alpha:1,scale:{from:1,to:1.2},duration:500,yoyo:!0,repeat:-1})):(this.speedWarning.setAlpha(0),this.tweens.killTweensOf(this.speedWarning)),t>=30?this.speedText.setColor("#ff0000"):t>=25?this.speedText.setColor("#ff1493"):t>=20?this.speedText.setColor("#ff4500"):t>=16?this.speedText.setColor("#ff6600"):t>=12?this.speedText.setColor("#ff8c00"):t>=10?this.speedText.setColor("#ffa500"):this.speedText.setColor("#feb501")}createStakesDisplay(){const{width:t}=this.cameras.main,s=parseInt(localStorage.getItem("bearPongCurrentBet")||"10")*2;this.stakesText=this.add.text(t/2,95,`üí∞ POT: ${s} HONEY üí∞`,{fontSize:"20px",color:"#ffae00",fontFamily:"Luckiest Guy",fontStyle:"bold",stroke:"#000000",strokeThickness:3}),this.stakesText.setOrigin(.5),this.tweens.add({targets:this.stakesText,scale:{from:1,to:1.1},duration:1e3,yoyo:!0,repeat:-1})}createUltimateButton(){const{width:t,height:e}=this.cameras.main,s=[x.TIME_FREEZE,x.POWER_HIT],o=180,n=t/2-o/2;s.forEach((i,a)=>{const r=G[i],l=n+a*o,c=e-70,d=this.add.container(l,c),h=160,u=this.add.rectangle(0,0,h,50,6819033);u.setStrokeStyle(4,16756224),u.setInteractive({useHandCursor:!0}),d.add(u);const m=this.add.graphics();this.createTriColorRing(m,0,0,h/2+5,6),d.add(m);const w=this.add.text(0,0,`${r.icon} ${r.name}`,{fontSize:"18px",color:"#ffffff",fontFamily:"Luckiest Guy",fontStyle:"bold"});w.setOrigin(.5),d.add(w);const S=i===x.TIME_FREEZE?"‚Üê":"‚Üí",y=this.add.text(0,35,S,{fontSize:"24px",color:"#ffae00",fontFamily:"Arial",fontStyle:"bold"});y.setOrigin(.5),d.add(y),u.on("pointerdown",()=>{console.log(`üéØ ${r.name} button clicked!`),this.useUltimate(i,d)}),u.on("pointerover",()=>{this.ultimateUsed.has(i)||d.setScale(1.1)}),u.on("pointerout",()=>{d.setScale(1)}),this.tweens.add({targets:d,scale:{from:1,to:1.05},duration:1e3,yoyo:!0,repeat:-1}),this.ultimateButtons.set(i,d)})}useUltimate(t,e){if(console.log(`üöÄ useUltimate(${t}) called, used:`,this.ultimateUsed.has(t)),this.ultimateUsed.has(t)){console.log("‚ö†Ô∏è Ultimate already used, ignoring");return}this.ultimateUsed.add(t);const s=e.list[0];s&&(s.setFillStyle(4473924),s.setStrokeStyle(4,6710886)),this.tweens.killTweensOf(e);const o=this.add.text(0,35,"USED",{fontSize:"16px",color:"#888888",fontFamily:"Luckiest Guy"});o.setOrigin(.5),e.add(o);const n=this.scene.get("PongGameScene");console.log("üéÆ Game scene:",n),console.log("üéÆ Has activateUltimate?",n?.activateUltimate),console.log("üéÆ Ultimate type:",t),n&&n.activateUltimate?(console.log("‚úÖ Calling gameScene.activateUltimate()"),n.activateUltimate(t)):console.error("‚ùå Game scene not found or missing activateUltimate method!"),this.showUltimateActivation(t)}refreshPowerups(){console.log("üîÑ Refreshing power-ups!"),this.ultimateUsed.clear(),this.ultimateButtons.forEach((t,e)=>{const s=t.list[0];s&&(s.setFillStyle(6819033),s.setStrokeStyle(4,16756224));const o=t.list[t.list.length-1];if(o&&o.type==="Text"){const n=o;n.text==="USED"&&(t.remove(n),n.destroy())}this.tweens.add({targets:t,scale:{from:1,to:1.05},duration:1e3,yoyo:!0,repeat:-1})})}showUltimateActivation(t){const{width:e,height:s}=this.cameras.main,o=G[t],n=this.add.text(e/2,s/2,`${o.icon} ${o.name.toUpperCase()}! ${o.icon}`,{fontSize:"72px",color:"#ffae00",fontFamily:"Luckiest Guy",fontStyle:"bold",stroke:"#000000",strokeThickness:8});n.setOrigin(.5),n.setAlpha(0),this.tweens.add({targets:n,alpha:1,scale:{from:0,to:1.5},duration:300,ease:"Back.out",onComplete:()=>{this.time.delayedCall(800,()=>{this.tweens.add({targets:n,alpha:0,scale:2,duration:400,ease:"Power2",onComplete:()=>n.destroy()})})}});const i=this.add.rectangle(0,0,e,s,16777215,.5);i.setOrigin(0),this.tweens.add({targets:i,alpha:0,duration:500,onComplete:()=>i.destroy()})}updateScore(t,e){const{width:s,height:o}=this.cameras.main;if(this.leftScoreText){const n=parseInt(this.leftScoreText.text)||0;if(this.leftScoreText.setText(t.toString()),n!==t&&t>n){const i=this.add.text(s/4,o/2,t.toString(),{fontSize:"256px",color:"#4a90e2",fontStyle:"bold"});i.setOrigin(.5),i.setAlpha(1),this.tweens.add({targets:i,scale:{from:1,to:.375},x:s/4,y:80,alpha:0,duration:800,ease:"Back.in",onComplete:()=>{i.destroy(),this.tweens.add({targets:this.leftScoreText,scale:{from:1.5,to:1},duration:400,ease:"Elastic.out"})}})}}if(this.rightScoreText){const n=parseInt(this.rightScoreText.text)||0;if(this.rightScoreText.setText(e.toString()),n!==e&&e>n){const i=this.add.text(s*3/4,o/2,e.toString(),{fontSize:"256px",color:"#ff6b6b",fontStyle:"bold"});i.setOrigin(.5),i.setAlpha(1),this.tweens.add({targets:i,scale:{from:1,to:.375},x:s*3/4,y:80,alpha:0,duration:800,ease:"Back.in",onComplete:()=>{i.destroy(),this.tweens.add({targets:this.rightScoreText,scale:{from:1.5,to:1},duration:400,ease:"Elastic.out"})}})}}}showCombo(t,e){if(t<2)return;const{width:s,height:o}=this.cameras.main;this.comboTween&&(this.comboTween.stop(),this.comboText?.destroy());const n=e==="left"?s/4:s*3/4,i=e==="left"?"#4a90e2":"#ff6b6b";this.comboText=this.add.text(n,o/2+100,`${t} HIT COMBO!`,{fontSize:"48px",color:i,fontStyle:"bold"}),this.comboText.setOrigin(.5),this.comboText.setAlpha(0),this.comboTween=this.tweens.add({targets:this.comboText,alpha:1,scale:{from:0,to:1.2},duration:200,ease:"Back.out",onComplete:()=>{this.time.delayedCall(500,()=>{this.tweens.add({targets:this.comboText,alpha:0,scale:.8,duration:300,ease:"Power2",onComplete:()=>{this.comboText?.destroy(),this.comboText=null}})})}})}createAvatarDisplays(){const{width:t}=this.cameras.main,e=60,s=35,o=this.yourSide==="left",n=o?this.myAvatarUrl:this.opponentAvatarUrl,i=o?this.myAvatarIsAnimated:this.opponentAvatarIsAnimated,a=o?this.myEquippedRing:this.opponentEquippedRing,r=o?this.opponentAvatarUrl:this.myAvatarUrl,l=o?this.opponentAvatarIsAnimated:this.myAvatarIsAnimated,c=o?this.opponentEquippedRing:this.myEquippedRing;this.createAvatar(150,e,s,n,i,4886754,a);const h=t-150;this.createAvatar(h,e,s,r,l,16739179,c)}createAvatar(t,e,s,o,n,i,a=null){if(o)this.createHTMLAvatar(t,e,s,o,i,a);else{const r=this.add.graphics();r.lineStyle(4,i,1),r.strokeCircle(t,e,s+2),this.add.circle(t,e,s,3355443);const l=t<this.cameras.main.width/2;let c;l?c=this.yourSide==="left"?E.getCurrentUserDisplayName():this.opponent?.displayName||"O":c=this.yourSide==="right"?E.getCurrentUserDisplayName():this.opponent?.displayName||"O";const d=c.charAt(0).toUpperCase();this.add.text(t,e,d,{fontSize:"32px",color:"#ffffff",fontFamily:"Luckiest Guy"}).setOrigin(.5)}}createHTMLAvatar(t,e,s,o,n,i=null){const a=this.game.canvas,r=a.getBoundingClientRect(),l=r.width/a.width,c=r.height/a.height,d=t*l,h=e*c,p=s*Math.min(l,c),u=document.createElement("div");if(u.className="pong-ui-avatar-wrapper",u.style.position="absolute",u.style.width=`${p*2}px`,u.style.height=`${p*2}px`,u.style.left=`${r.left+d-p}px`,u.style.top=`${r.top+h-p}px`,u.style.pointerEvents="none",u.style.zIndex="10000",i){let S;if(i.image_url&&(i.image_url.startsWith("http://")||i.image_url.startsWith("https://")))S=i.image_url;else{const T=window.location.hostname==="localhost"?"http://localhost:3000":window.location.origin,b=i.image_url||i.name.toLowerCase().replace(/ /g,"-")+".svg";S=`${T}/cosmetics/${b}`}const y=document.createElement("div");y.className="cosmetic-ring",y.style.position="absolute",y.style.inset="-6px",y.style.borderRadius="50%",y.style.backgroundImage=`url('${S}')`,y.style.backgroundSize="cover",y.style.backgroundPosition="center",y.style.zIndex="2",y.style.pointerEvents="none",i.is_animated&&(y.style.animation="spin 3s linear infinite"),u.appendChild(y),console.log("üíç Rendered cosmetic ring:",i.name,"from",S)}const m=document.createElement("div");m.className="pong-ui-avatar",m.style.position="relative",m.style.width="100%",m.style.height="100%",m.style.borderRadius="50%",m.style.overflow="hidden",m.style.zIndex="1",m.style.border=i?"none":`4px solid ${this.colorToHex(n)}`;const w=document.createElement("img");if(w.src=o,w.style.width="100%",w.style.height="100%",w.style.objectFit="cover",w.style.display="block",m.appendChild(w),u.appendChild(m),document.body.appendChild(u),!document.getElementById("pong-ring-animations")){const S=document.createElement("style");S.id="pong-ring-animations",S.textContent=`
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
      `,document.head.appendChild(S)}this.events.once("shutdown",()=>{u&&u.parentNode&&u.parentNode.removeChild(u)})}colorToHex(t){return"#"+t.toString(16).padStart(6,"0")}}const B={PURPLE:6819033,GREEN:503304,YELLOW:16692481,CHARCOAL:1316377,WHITE:16777215};class V extends g.Scene{audioManager=null;gameScene=null;overlay=null;container=null;masterHandle=null;musicHandle=null;sfxHandle=null;masterTrack=null;musicTrack=null;sfxTrack=null;canvasClickHandler=null;constructor(){super({key:"PongPauseScene"})}init(t){this.audioManager=t.audioManager,this.gameScene=t.gameScene}create(){const{width:t,height:e}=this.cameras.main;this.overlay=this.add.rectangle(0,0,t,e,0,.85),this.overlay.setOrigin(0),this.overlay.setInteractive(),this.container=this.add.container(t/2,e/2);const n=this.add.rectangle(0,0,500,300,B.CHARCOAL);n.setStrokeStyle(6,B.YELLOW),this.container.add(n);const i=this.add.text(0,-50,"PAUSED",{fontFamily:"Luckiest Guy, Arial Black, Impact",fontSize:"56px",color:"#feb501"});i.setOrigin(.5),this.container.add(i),this.createButton("RESUME",30,B.GREEN,()=>{this.resumeGame()}),this.createButton("QUIT",110,B.PURPLE,()=>{this.quitGame()}),this.input.keyboard?.on("keydown-ESC",()=>{this.resumeGame()}),this.canvasClickHandler=a=>{const r=this.game.canvas.getBoundingClientRect(),l=1280/r.width,c=720/r.height,d=(a.clientX-r.left)*l,h=(a.clientY-r.top)*c,p=t/2,u=e/2,m=300,w=50,S=u+30;if(d>=p-m/2&&d<=p+m/2&&h>=S-w/2&&h<=S+w/2){this.resumeGame();return}const y=u+110;if(d>=p-m/2&&d<=p+m/2&&h>=y-w/2&&h<=y+w/2){this.quitGame();return}},this.game.canvas.addEventListener("pointerdown",this.canvasClickHandler)}shutdown(){this.canvasClickHandler&&(this.game.canvas.removeEventListener("pointerdown",this.canvasClickHandler),this.canvasClickHandler=null)}createVolumeSlider(t,e,s,o){if(!this.container)return;const n=this.add.text(-70,e,t,{fontFamily:"Luckiest Guy, Arial Black, Impact",fontSize:"24px",color:"#feb501"});n.setOrigin(1,.5),this.container.add(n);const i=200,a=8,r=this.add.rectangle(50,e,i,a,B.WHITE,.3);this.container.add(r);const l=i*s,c=this.add.rectangle(50-i/2+l/2,e,l,a);c.setOrigin(.5),o==="master"?c.setFillStyle(B.YELLOW):o==="music"?c.setFillStyle(B.PURPLE):c.setFillStyle(B.GREEN),this.container.add(c);const d=50-i/2+i*s,h=this.add.circle(d,e,12,B.WHITE);h.setStrokeStyle(3,B.YELLOW),h.setInteractive({draggable:!0,useHandCursor:!0}),this.container.add(h),o==="master"?(this.masterHandle=h,this.masterTrack=r):o==="music"?(this.musicHandle=h,this.musicTrack=r):(this.sfxHandle=h,this.sfxTrack=r);const p=this.add.text(160,e,`${Math.round(s*100)}%`,{fontFamily:"Luckiest Guy, Arial Black, Impact",fontSize:"20px",color:"#ffffff"});p.setOrigin(0,.5),this.container.add(p),h.on("drag",(u,m)=>{const w=r.x-i/2,S=r.x+i/2,y=g.Math.Clamp(u.x-(this.container?.x||0),w,S);h.x=y;const T=(y-w)/i,b=i*T;c.width=b,c.x=r.x-i/2+b/2,p.setText(`${Math.round(T*100)}%`),o==="master"?this.audioManager?.setMasterVolume(T):o==="music"?this.audioManager?.setMusicVolume(T):this.audioManager?.setSFXVolume(T)})}createButton(t,e,s,o){if(!this.container)return;const a=this.add.rectangle(0,e,300,50,s);a.setStrokeStyle(4,B.YELLOW),a.setInteractive({useHandCursor:!0}),this.container.add(a);const r=this.add.text(0,e,t,{fontFamily:"Luckiest Guy, Arial Black, Impact",fontSize:"28px",color:"#feb501"});r.setOrigin(.5),this.container.add(r),a.on("pointerover",()=>{a.setScale(1.05),r.setScale(1.05)}),a.on("pointerout",()=>{a.setScale(1),r.setScale(1)}),a.on("pointerdown",o)}resumeGame(){this.scene.resume("PongGameScene"),this.scene.resume("PongUIScene"),this.scene.stop()}quitGame(){const t=this.add.rectangle(0,0,this.cameras.main.width,this.cameras.main.height,0,.5);t.setOrigin(0);const e=this.add.rectangle(this.cameras.main.width/2,this.cameras.main.height/2,400,250,B.CHARCOAL);e.setStrokeStyle(6,B.YELLOW);const s=this.add.text(this.cameras.main.width/2,this.cameras.main.height/2-40,`QUIT GAME?

You will return to
BEAR Park`,{fontFamily:"Luckiest Guy, Arial Black, Impact",fontSize:"24px",color:"#feb501",align:"center"});s.setOrigin(.5);const o=this.add.rectangle(this.cameras.main.width/2-80,this.cameras.main.height/2+70,120,45,B.GREEN);o.setStrokeStyle(3,B.YELLOW),o.setInteractive({useHandCursor:!0});const n=this.add.text(this.cameras.main.width/2-80,this.cameras.main.height/2+70,"YES",{fontFamily:"Luckiest Guy, Arial Black, Impact",fontSize:"24px",color:"#feb501"});n.setOrigin(.5),o.on("pointerdown",()=>{this.audioManager?.stopBackgroundMusic(),this.scene.stop("PongGameScene"),this.scene.stop("PongUIScene"),this.scene.stop(),window.location.href="/"});const i=this.add.rectangle(this.cameras.main.width/2+80,this.cameras.main.height/2+70,120,45,B.PURPLE);i.setStrokeStyle(3,B.YELLOW),i.setInteractive({useHandCursor:!0});const a=this.add.text(this.cameras.main.width/2+80,this.cameras.main.height/2+70,"NO",{fontFamily:"Luckiest Guy, Arial Black, Impact",fontSize:"24px",color:"#feb501"});a.setOrigin(.5);const r=l=>{const c=this.game.canvas.getBoundingClientRect(),d=1280/c.width,h=720/c.height,p=(l.clientX-c.left)*d,u=(l.clientY-c.top)*h,m=this.cameras.main.width/2,S=this.cameras.main.height/2+70,y=120,T=45,b=m-80;if(p>=b-y/2&&p<=b+y/2&&u>=S-T/2&&u<=S+T/2){this.audioManager?.stopBackgroundMusic(),this.scene.stop("PongGameScene"),this.scene.stop("PongUIScene"),this.scene.stop(),window.location.href="/";return}const A=m+80;if(p>=A-y/2&&p<=A+y/2&&u>=S-T/2&&u<=S+T/2){this.game.canvas.removeEventListener("pointerdown",r),t.destroy(),e.destroy(),s.destroy(),o.destroy(),n.destroy(),i.destroy(),a.destroy();return}};this.game.canvas.addEventListener("pointerdown",r),i.on("pointerdown",()=>{this.game.canvas.removeEventListener("pointerdown",r),t.destroy(),e.destroy(),s.destroy(),o.destroy(),n.destroy(),i.destroy(),a.destroy()})}}class z extends g.Scene{didWin=!1;yourScore=0;opponentScore=0;opponent=null;pongClient=null;leaderboard=[];gameStartTime=0;betAmount=0;canvasClickHandler=null;constructor(){super({key:"PongGameOverScene"})}init(t){this.didWin=t.didWin,this.yourScore=t.yourScore,this.opponentScore=t.opponentScore,this.opponent=t.opponent,this.pongClient=t.pongClient,this.gameStartTime=t.gameStartTime||0,this.betAmount=t.betAmount||0}async create(){const{width:t,height:e}=this.cameras.main;this.add.rectangle(0,0,t,e,1710618,1).setOrigin(0);const s=this.add.text(t/2,100,this.didWin?"VICTORY!":"GAME OVER",{fontSize:"64px",color:this.didWin?"#07ae08":"#ffae00",fontStyle:"bold",fontFamily:"Luckiest Guy"});s.setOrigin(.5),s.setStroke("#000000",6),this.displayStarRating(t/2,160),this.displayWinnings(t/2,200),await this.submitResult(),console.log("‚è≥ Waiting 2 seconds for database to update..."),await new Promise(o=>setTimeout(o,2e3)),this.displayScoreBox(t/2,280),await this.awardHoneyPoints(),console.log("‚è≥ Waiting 6 seconds for honey overlay to fully dismiss..."),await new Promise(o=>setTimeout(o,6e3)),await this.processBetting(),this.betAmount>0&&(await this.showBettingResultsScreen(),await new Promise(o=>setTimeout(o,3e3))),await this.loadAndDisplayLeaderboard(t/2,400),this.time.delayedCall(100,()=>{const o=e-100,n=t*.28,i=45,a=15,r=t/2-n/2-a/2-t*.15,l=t/2+n/2+a/2+t*.15;this.canvasClickHandler=c=>{const d=this.game.canvas.getBoundingClientRect(),h=1280/d.width,p=720/d.height,u=(c.clientX-d.left)*h,m=(c.clientY-d.top)*p;if(u>=r-n/2&&u<=r+n/2&&m>=o-i/2&&m<=o+i/2){this.playAgain();return}if(u>=l-n/2&&u<=l+n/2&&m>=o-i/2&&m<=o+i/2){this.returnToMenu();return}},this.game.canvas.addEventListener("pointerdown",this.canvasClickHandler),this.createStyledButtons(t/2,e-100)})}shutdown(){console.log("üõëüõëüõë [GAME OVER] SHUTDOWN CALLED!"),console.log("üõë [GAME OVER] Scene active:",this.scene.isActive()),this.canvasClickHandler?(this.game.canvas.removeEventListener("pointerdown",this.canvasClickHandler),this.canvasClickHandler=null,console.log("‚úÖ [GAME OVER] Removed canvas click handler")):console.log("‚ö†Ô∏è [GAME OVER] No canvas click handler to remove!"),console.log("üõë [GAME OVER] SHUTDOWN COMPLETE!")}async submitResult(){try{this.didWin?(await E.submitWin({opponent:this.opponent?.displayName,your_score:this.yourScore,opponent_score:this.opponentScore}),console.log("‚úÖ Win submitted to BEARpark")):(await E.submitLoss({opponent:this.opponent?.displayName,your_score:this.yourScore,opponent_score:this.opponentScore}),console.log("‚úÖ Loss submitted to BEARpark"))}catch(t){console.error("‚ùå Error submitting result:",t)}}async processBetting(){console.log(`üí∞ [BETTING] Processing bet transaction: ${this.didWin?"WIN":"LOSS"}, bet amount: ${this.betAmount}`);try{if(await E.processBettingTransaction(this.didWin,this.betAmount)){console.log("‚úÖ [BETTING] Betting transaction successful!");const e=await E.getUpdatedBalance();if(e!==null){console.log(`üíæ [BETTING] Updating localStorage with new balance: ${e.total}`);const s=E.getWalletAddress();if(s){const o=`honey_points_${s}`;localStorage.setItem(o,JSON.stringify(e)),console.log(`üíæ [BETTING] Updated localStorage key: ${o}`)}}}else console.log("‚ö†Ô∏è [BETTING] Betting transaction failed")}catch(t){console.error("‚ùå [BETTING] Error processing betting transaction:",t)}}displayStats(t,e){const s=E.getLocalStats(),o=this.add.container(t,e),n=this.add.text(0,0,"Your Stats",{fontSize:"24px",color:"#4a90e2",fontStyle:"bold",fontFamily:"Luckiest Guy"});n.setOrigin(.5),n.setStroke("#000000",3),o.add(n);const i=this.add.text(0,40,`Wins: ${s.wins}  |  Losses: ${s.losses}  |  Win Rate: ${(s.winRate*100).toFixed(1)}%`,{fontSize:"18px",color:"#ffffff"});i.setOrigin(.5),o.add(i),o.setAlpha(0),this.tweens.add({targets:o,alpha:1,duration:500,delay:300})}async loadAndDisplayLeaderboard(t,e){const s=this.add.container(t,e),o=this.add.text(0,0,"üèÜ TOP 10 PLAYERS üèÜ",{fontSize:"32px",color:"#ffae00",fontStyle:"bold",fontFamily:"Luckiest Guy"});o.setOrigin(.5),o.setStroke("#000000",3),s.add(o);const n=this.add.text(0,40,"Loading...",{fontSize:"16px",color:"#888888"});n.setOrigin(.5),s.add(n);try{if(this.leaderboard=await E.getLeaderboard(10),n.destroy(),this.leaderboard.length>0)this.leaderboard.forEach((i,a)=>{const r=E.formatDisplayName(i),l=i.wins||i.score||i.metadata?.wins||0,c=i.losses||i.metadata?.losses||0,d=this.add.text(0,40+a*30,`${a+1}. ${r} - ${l}W ${c}L`,{fontSize:"18px",color:"#ffffff",fontFamily:"Luckiest Guy"});d.setOrigin(.5),s.add(d)});else{const i=this.add.text(0,40,"No leaderboard data yet",{fontSize:"16px",color:"#888888"});i.setOrigin(.5),s.add(i)}}catch(i){n.setText("Failed to load leaderboard"),console.error("Error loading leaderboard:",i)}s.setAlpha(0),this.tweens.add({targets:s,alpha:1,duration:500,delay:600})}createButtons(t,e){const s=this.add.text(t,e,"[ Play Again ]",{fontSize:"24px",color:"#4ade80"});s.setOrigin(.5),s.setInteractive({useHandCursor:!0}),s.on("pointerover",()=>{s.setScale(1.1)}),s.on("pointerout",()=>{s.setScale(1)}),s.on("pointerdown",()=>{this.playAgain()});const o=this.add.text(t,e+60,"[ Main Menu ]",{fontSize:"20px",color:"#888888"});o.setOrigin(.5),o.setInteractive({useHandCursor:!0}),o.on("pointerover",()=>{o.setScale(1.1),o.setColor("#ffffff")}),o.on("pointerout",()=>{o.setScale(1),o.setColor("#888888")}),o.on("pointerdown",()=>{this.returnToMenu()}),s.setAlpha(0),o.setAlpha(0),this.tweens.add({targets:[s,o],alpha:1,duration:500,delay:900})}playAgain(){console.log("üîÑ [GAME OVER] playAgain() called - transitioning to lobby"),this.canvasClickHandler?(console.log("üßπ [GAME OVER] Manually removing canvas click handler before scene stop"),this.game.canvas.removeEventListener("pointerdown",this.canvasClickHandler),this.canvasClickHandler=null,console.log("‚úÖ [GAME OVER] Canvas click handler removed!")):console.log("‚ö†Ô∏è [GAME OVER] No canvas click handler to remove in playAgain()"),this.pongClient&&(console.log("üö™ Sending leave message to server..."),this.pongClient.leave(),setTimeout(()=>{this.pongClient&&this.pongClient.disconnect()},100)),console.log("üéØ [GAME OVER] Starting PongLobbyScene..."),this.scene.start("PongLobbyScene"),console.log("üõë [GAME OVER] Stopping Game Over scene..."),this.scene.stop(),console.log("‚úÖ [GAME OVER] Scene stopped!")}returnToMenu(){console.error("üö®üö®üö® [GAME OVER] returnToMenu() CALLED!!!"),console.error("üö® Scene active:",this.scene.isActive()),console.error("üö® Stack trace:",new Error().stack);const t=this.game.registry.get("globalAudioManager");t&&(t.stopBackgroundMusic(),console.log("üîá Stopped music - leaving BEAR PONG")),this.pongClient?(console.log("üö™ Sending leave message to server..."),this.pongClient.leave(),setTimeout(()=>{this.pongClient&&this.pongClient.disconnect(),window.location.href=`/?refresh=${Date.now()}`},100)):window.location.href=`/?refresh=${Date.now()}`}async awardHoneyPoints(){if(!E.getWalletAddress()){console.log("‚ö†Ô∏è [REWARD] No wallet connected - skipping HONEY reward");return}if(!this.gameStartTime){console.log("‚ö†Ô∏è [REWARD] No game start time - skipping HONEY reward");return}const o=(Date.now()-this.gameStartTime)/6e4;if(console.log(`‚è±Ô∏è [REWARD] Game duration: ${o.toFixed(2)} minutes`),o<.166){console.log("‚ö†Ô∏è [REWARD] Game too short (< 10 seconds) - no rewards");return}try{const n=window.awardGamePoints;if(typeof n=="function"){console.log(`üçØ [REWARD] Calling awardGamePoints with ${o.toFixed(2)} minutes...`);const i=await n("bear-pong",o);i&&i.success?console.log(`‚úÖ [REWARD] Successfully awarded ${i.points_awarded} HONEY!`):console.log(`‚ö†Ô∏è [REWARD] ${i?.message||"Failed to award points"}`)}else console.error("‚ùå [REWARD] awardGamePoints function not found - game-points-helper.js may not be loaded")}catch(n){console.error("‚ùå [REWARD] Error awarding HONEY points:",n)}}displayWinnings(t,e){if(this.betAmount===0)return;let s="",o="";this.didWin?(s=`+${this.betAmount} HONEY WON! üéâ`,o="#07ae08"):(s=`-${this.betAmount} HONEY LOST üò¢`,o="#ff4500");const n=this.add.text(t,e,s,{fontSize:"32px",color:o,fontFamily:"Luckiest Guy",fontStyle:"bold",stroke:"#000000",strokeThickness:4});n.setOrigin(.5),this.tweens.add({targets:n,scale:{from:1,to:1.2},duration:800,yoyo:!0,repeat:-1})}async showBettingResultsScreen(){return new Promise(t=>{const{width:e,height:s}=this.cameras.main,o=this.add.rectangle(0,0,e,s,0,.85);o.setOrigin(0),o.setDepth(1e3),o.setAlpha(0);const n=this.didWin,i=this.betAmount,a=n?`+${i} HONEY POINTS`:`-${this.betAmount} HONEY POINTS`,r=n?"#07ae08":"#ff4500",l=this.add.text(e/2,s/2,a,{fontSize:"72px",color:r,fontFamily:"Luckiest Guy",fontStyle:"bold",stroke:"#000000",strokeThickness:8});l.setOrigin(.5),l.setDepth(1001),l.setAlpha(0),l.setScale(.5),this.tweens.add({targets:o,alpha:1,duration:300,ease:"Power2"}),this.tweens.add({targets:l,alpha:1,scale:1,duration:500,ease:"Back.easeOut",onComplete:()=>{this.tweens.add({targets:l,scale:{from:1,to:1.1},duration:600,yoyo:!0,repeat:2}),this.time.delayedCall(2500,()=>{this.tweens.add({targets:[o,l],alpha:0,duration:400,ease:"Power2",onComplete:()=>{o.destroy(),l.destroy(),t()}})})}})})}displayStarRating(t,e){const s=this.didWin?this.yourScore>=3?5:3:1,o=48,n=45,i=t-n*2;for(let a=0;a<5;a++)this.add.text(i+a*n,e,"‚òÖ",{fontSize:o+"px",color:a<s?"#FFD700":"#404040"}).setOrigin(.5)}async displayScoreBox(t,e){let s=0,o=0,n=0;const i=await E.getMyStats();if(i)s=i.wins||i.score||0,o=i.losses||0,n=i.win_rate||0,console.log(`üìä [GAME OVER] Displaying stats from DATABASE: ${s}W ${o}L (${(n*100).toFixed(0)}%)`);else{const u=E.getLocalStats();s=u.wins,o=u.losses,n=u.winRate,console.log(`üìä [GAME OVER] Database failed - displaying stats from LOCALSTORAGE: ${s}W ${o}L (${(n*100).toFixed(0)}%)`)}const{width:a}=this.cameras.main,r=a*.85,l=120,c=this.add.graphics();c.lineStyle(5,6819033,1),c.strokeRoundedRect(t-r/2,e-l/2,r,l,15),c.fillStyle(2763306,.95),c.fillRoundedRect(t-r/2+5,e-l/2+5,r-10,l-10,12);const d=this.add.text(t,e-30,"YOUR SCORE",{fontSize:"26px",color:"#ffae00",fontStyle:"bold",fontFamily:"Luckiest Guy"});d.setOrigin(.5),d.setStroke("#000000",3),this.add.text(t,e+10,s.toString(),{fontSize:"60px",color:"#ffffff",fontStyle:"bold",fontFamily:"Luckiest Guy"}).setOrigin(.5),this.add.text(t,e+40,`üèÜ ${s} WIN${s!==1?"S":""}`,{fontSize:"20px",color:"#FFD700",fontFamily:"Luckiest Guy"}).setOrigin(.5)}createStyledButtons(t,e){const{width:s}=this.cameras.main,o=s*.28,n=45,i=15,a=t-o/2-i/2-s*.15,r=t+o/2+i/2+s*.15,l=this.add.graphics();l.fillStyle(503304,1),l.fillRoundedRect(a-o/2,e-n/2,o,n,10),l.setDepth(2e3);const c=this.add.text(a,e,"TAP TO RETRY",{fontSize:"18px",color:"#ffffff",fontStyle:"bold",fontFamily:"Luckiest Guy"});c.setOrigin(.5),c.setDepth(2001);const d=this.add.graphics();d.fillStyle(16756224,1),d.fillRoundedRect(r-o/2,e-n/2,o,n,10),d.setDepth(2e3);const h=this.add.text(r,e,"BACK TO BEARPARK",{fontSize:"17px",color:"#ffffff",fontStyle:"bold",fontFamily:"Luckiest Guy"});return h.setOrigin(.5),h.setDepth(2001),this.input.on("pointerdown",p=>{console.log(`üñ±Ô∏è Click at: ${p.x}, ${p.y}`);const u=a-o/2,m=a+o/2,w=e-n/2,S=e+n/2;if(p.x>=u&&p.x<=m&&p.y>=w&&p.y<=S){console.log("üéÆ RETRY BUTTON HIT!"),this.playAgain();return}const y=r-o/2,T=r+o/2,b=e-n/2,A=e+n/2;if(p.x>=y&&p.x<=T&&p.y>=b&&p.y<=A){console.log("üè† MENU BUTTON HIT!"),this.returnToMenu();return}}),this.input.on("pointermove",p=>{const u=a-o/2,m=a+o/2,w=e-n/2,S=e+n/2,y=r-o/2,T=r+o/2,b=e-n/2,A=e+n/2,P=p.x>=u&&p.x<=m&&p.y>=w&&p.y<=S,R=p.x>=y&&p.x<=T&&p.y>=b&&p.y<=A;P?(l.clear(),l.fillStyle(643082,1),l.fillRoundedRect(a-o/2,e-n/2,o,n,10),c.setScale(1.05)):(l.clear(),l.fillStyle(503304,1),l.fillRoundedRect(a-o/2,e-n/2,o,n,10),c.setScale(1)),R?(h.setColor("#ffae00"),h.setScale(1.05)):(h.setColor("#ffffff"),h.setScale(1))}),{retryText:c,menuText:h}}}const X={type:g.AUTO,width:1280,height:720,parent:"game-container",backgroundColor:"#000000",scale:{mode:g.Scale.FIT,autoCenter:g.Scale.CENTER_BOTH},scene:[Y,$,F,U,V,z],physics:{default:"arcade",arcade:{debug:!1,fps:60}}},q=new g.Game(X);q.scene.start("PongLobbyScene");console.log("üéÆ BEAR PONG initialized");console.log("üîå Server URL:","wss://bear-pong-production.up.railway.app");
