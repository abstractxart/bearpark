<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BEAR Merch Admin</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 50%, #0a0a1a 100%);
      min-height: 100vh;
      color: #fff;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: linear-gradient(135deg, #680cd9, #00ff88);
      padding: 20px 30px;
      border-radius: 16px;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 800;
    }

    .wallet-info {
      background: rgba(0,0,0,0.3);
      padding: 10px 20px;
      border-radius: 10px;
      font-family: monospace;
      font-size: 14px;
    }

    .wallet-info.connected { border: 2px solid #00ff88; }
    .wallet-info.not-connected { border: 2px solid #ef4444; }

    /* Auth Screen */
    .auth-screen {
      text-align: center;
      padding: 60px 20px;
      max-width: 500px;
      margin: 0 auto;
    }

    .auth-screen h2 {
      font-size: 28px;
      margin-bottom: 20px;
      color: #00ff88;
    }

    .auth-screen p {
      color: #888;
      margin-bottom: 30px;
      line-height: 1.6;
    }

    .auth-btn {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 16px 32px;
      background: linear-gradient(135deg, #680cd9, #00ff88);
      border: none;
      border-radius: 12px;
      color: #fff;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
    }

    .auth-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(104,12,217,0.4);
    }

    .auth-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .qr-container {
      margin: 30px auto;
      padding: 20px;
      background: #fff;
      border-radius: 16px;
      display: inline-block;
    }

    .qr-container img {
      width: 200px;
      height: 200px;
    }

    .auth-status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 10px;
      font-size: 14px;
    }

    .auth-status.waiting {
      background: rgba(254,181,1,0.2);
      border: 2px solid #feb501;
      color: #feb501;
    }

    .auth-status.success {
      background: rgba(34,197,94,0.2);
      border: 2px solid #22c55e;
      color: #22c55e;
    }

    .auth-status.error {
      background: rgba(239,68,68,0.2);
      border: 2px solid #ef4444;
      color: #ef4444;
    }

    .access-denied {
      text-align: center;
      padding: 100px 20px;
    }

    .access-denied h2 {
      color: #ef4444;
      font-size: 32px;
      margin-bottom: 20px;
    }

    .access-denied p {
      color: #888;
      font-size: 18px;
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(30,30,50,0.8);
      border: 2px solid rgba(104,12,217,0.3);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .stat-card .number {
      font-size: 36px;
      font-weight: 800;
      color: #00ff88;
    }

    .stat-card .label {
      color: #888;
      font-size: 14px;
      margin-top: 5px;
    }

    .stat-card.pending .number { color: #feb501; }
    .stat-card.shipped .number { color: #00ff88; }
    .stat-card.revenue .number { color: #680cd9; }

    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 10px 20px;
      background: rgba(30,30,50,0.8);
      border: 2px solid rgba(104,12,217,0.3);
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-btn:hover, .filter-btn.active {
      border-color: #680cd9;
      background: rgba(104,12,217,0.2);
    }

    .orders-table {
      width: 100%;
      background: rgba(30,30,50,0.8);
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid rgba(104,12,217,0.3);
    }

    .orders-table th {
      background: rgba(104,12,217,0.3);
      padding: 15px 12px;
      text-align: left;
      font-weight: 700;
      font-size: 13px;
      text-transform: uppercase;
      color: #ccc;
    }

    .orders-table td {
      padding: 15px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 14px;
    }

    .orders-table tr:hover {
      background: rgba(104,12,217,0.1);
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .status-badge.pending { background: rgba(254,181,1,0.2); color: #feb501; }
    .status-badge.paid { background: rgba(59,130,246,0.2); color: #3b82f6; }
    .status-badge.shipped { background: rgba(34,197,94,0.2); color: #22c55e; }
    .status-badge.cancelled { background: rgba(239,68,68,0.2); color: #ef4444; }

    .address-cell {
      max-width: 250px;
      font-size: 12px;
      line-height: 1.4;
    }

    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s;
      margin: 2px;
    }

    .action-btn.ship { background: #22c55e; color: #fff; }
    .action-btn.ship:hover { background: #16a34a; }
    .action-btn.details { background: #3b82f6; color: #fff; }
    .action-btn.details:hover { background: #2563eb; }
    .action-btn.cancel { background: #ef4444; color: #fff; }
    .action-btn.cancel:hover { background: #dc2626; }

    .loading {
      text-align: center;
      padding: 60px;
      color: #888;
    }

    .loading .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(104,12,217,0.2);
      border-top-color: #680cd9;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active { display: flex; }

    .modal-content {
      background: linear-gradient(135deg, #1a1a3a, #0a0a1a);
      border: 2px solid rgba(104,12,217,0.5);
      border-radius: 16px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h3 {
      font-size: 20px;
      color: #00ff88;
    }

    .modal-close {
      background: none;
      border: none;
      color: #fff;
      font-size: 28px;
      cursor: pointer;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .detail-row .label { color: #888; }
    .detail-row .value { font-weight: 600; }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      color: #888;
      font-size: 13px;
      margin-bottom: 6px;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px;
      background: rgba(0,0,0,0.3);
      border: 2px solid rgba(104,12,217,0.3);
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
    }

    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #680cd9;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .modal-actions button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-actions .save { background: #22c55e; color: #fff; }
    .modal-actions .save:hover { background: #16a34a; }
    .modal-actions .cancel-btn { background: rgba(255,255,255,0.1); color: #fff; }

    .no-orders {
      text-align: center;
      padding: 60px;
      color: #666;
    }

    .session-timer {
      font-size: 12px;
      color: #888;
      margin-top: 5px;
    }

    /* Tab Navigation */
    .tab-nav {
      display: flex;
      gap: 0;
      margin-bottom: 30px;
      background: rgba(30,30,50,0.8);
      border-radius: 12px;
      padding: 6px;
      border: 2px solid rgba(104,12,217,0.3);
    }

    .tab-btn {
      flex: 1;
      padding: 14px 24px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: #888;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .tab-btn:hover {
      color: #fff;
      background: rgba(104,12,217,0.2);
    }

    .tab-btn.active {
      background: linear-gradient(135deg, #680cd9, #00ff88);
      color: #fff;
    }

    .tab-btn .tab-icon {
      font-size: 20px;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Inventory Styles */
    .inventory-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .inventory-card {
      background: rgba(30,30,50,0.8);
      border: 2px solid rgba(104,12,217,0.3);
      border-radius: 16px;
      padding: 20px;
      transition: all 0.3s;
    }

    .inventory-card:hover {
      border-color: #680cd9;
      transform: translateY(-2px);
    }

    .inventory-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .inventory-card-title {
      font-size: 18px;
      font-weight: 700;
      color: #00ff88;
    }

    .inventory-card-sku {
      font-size: 12px;
      color: #666;
      font-family: monospace;
    }

    .inventory-status {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .inventory-status.in-stock { background: rgba(34,197,94,0.2); color: #22c55e; }
    .inventory-status.low-stock { background: rgba(254,181,1,0.2); color: #feb501; }
    .inventory-status.out-of-stock { background: rgba(239,68,68,0.2); color: #ef4444; }

    .size-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
      gap: 8px;
      margin-top: 15px;
    }

    .size-item {
      background: rgba(0,0,0,0.3);
      border: 2px solid rgba(104,12,217,0.2);
      border-radius: 8px;
      padding: 10px 8px;
      text-align: center;
      transition: all 0.2s;
    }

    .size-item:hover {
      border-color: #680cd9;
    }

    .size-item .size-label {
      font-size: 14px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 4px;
    }

    .size-item .size-qty {
      font-size: 20px;
      font-weight: 800;
      color: #00ff88;
    }

    .size-item.low .size-qty { color: #feb501; }
    .size-item.out .size-qty { color: #ef4444; }

    .size-item input {
      width: 100%;
      padding: 6px;
      background: rgba(0,0,0,0.5);
      border: 1px solid rgba(104,12,217,0.3);
      border-radius: 4px;
      color: #fff;
      font-size: 16px;
      font-weight: 700;
      text-align: center;
    }

    .size-item input:focus {
      outline: none;
      border-color: #00ff88;
    }

    .inventory-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .inventory-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .inventory-btn.edit {
      background: rgba(104,12,217,0.3);
      color: #fff;
    }

    .inventory-btn.edit:hover {
      background: rgba(104,12,217,0.5);
    }

    .inventory-btn.save {
      background: #22c55e;
      color: #fff;
    }

    .inventory-btn.save:hover {
      background: #16a34a;
    }

    .inventory-btn.cancel {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }

    .add-product-btn {
      background: linear-gradient(135deg, #680cd9, #00ff88);
      border: none;
      border-radius: 12px;
      padding: 16px 24px;
      color: #fff;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      transition: all 0.3s;
    }

    .add-product-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(104,12,217,0.4);
    }

    .inventory-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    .inventory-summary .stat-card {
      padding: 15px;
    }

    .inventory-summary .stat-card .number {
      font-size: 28px;
    }

    @media (max-width: 768px) {
      .orders-table { display: block; overflow-x: auto; }
      .header { flex-direction: column; gap: 15px; text-align: center; }
      .tab-btn { padding: 12px 16px; font-size: 14px; }
      .tab-btn .tab-icon { display: none; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>BEAR Merch Admin</h1>
      <div>
        <div id="walletStatus" class="wallet-info not-connected">Not Authenticated</div>
        <div id="sessionTimer" class="session-timer"></div>
      </div>
    </div>

    <!-- Auth Screen -->
    <div id="authScreen" class="auth-screen">
      <h2>Admin Authentication Required</h2>
      <p>Sign with your XAMAN wallet to prove ownership and access the merch admin panel. Only authorized wallets can access this area.</p>

      <button id="authBtn" class="auth-btn" onclick="startAuth()">
        Sign in with XAMAN
      </button>

      <div id="qrContainer" class="qr-container" style="display:none;">
        <img id="qrImage" src="" alt="Scan with XAMAN">
      </div>

      <div id="authStatus" class="auth-status" style="display:none;"></div>
    </div>

    <!-- Access Denied -->
    <div id="accessDenied" class="access-denied" style="display:none;">
      <h2>ACCESS DENIED</h2>
      <p>Your wallet is not authorized to access this admin panel.</p>
      <p style="margin-top:20px; font-family:monospace; color:#666;">Only whitelisted admin wallets can access.</p>
    </div>

    <!-- Admin Content -->
    <div id="adminContent" style="display:none;">

      <!-- Tab Navigation -->
      <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('orders')">
          <span class="tab-icon">ðŸ“¦</span> Orders
        </button>
        <button class="tab-btn" onclick="switchTab('inventory')">
          <span class="tab-icon">ðŸ“Š</span> Inventory
        </button>
      </div>

      <!-- ORDERS TAB -->
      <div id="ordersTab" class="tab-content active">
        <div class="stats-row">
          <div class="stat-card">
            <div class="number" id="totalOrders">0</div>
            <div class="label">Total Orders</div>
          </div>
          <div class="stat-card pending">
            <div class="number" id="pendingOrders">0</div>
            <div class="label">Pending Payment</div>
          </div>
          <div class="stat-card">
            <div class="number" id="paidOrders">0</div>
            <div class="label">Paid (Awaiting Ship)</div>
          </div>
          <div class="stat-card shipped">
            <div class="number" id="shippedOrders">0</div>
            <div class="label">Shipped</div>
          </div>
          <div class="stat-card revenue">
            <div class="number" id="totalRevenue">$0</div>
            <div class="label">Total Revenue</div>
          </div>
        </div>

        <div class="filters">
          <button class="filter-btn active" onclick="filterOrders('all')">All Orders</button>
          <button class="filter-btn" onclick="filterOrders('pending')">Pending</button>
          <button class="filter-btn" onclick="filterOrders('paid')">Paid</button>
          <button class="filter-btn" onclick="filterOrders('shipped')">Shipped</button>
          <button class="filter-btn" onclick="filterOrders('cancelled')">Cancelled</button>
        </div>

        <div id="loadingOrders" class="loading">
          <div class="spinner"></div>
          <div>Loading orders...</div>
        </div>

        <table class="orders-table" id="ordersTable" style="display:none;">
          <thead>
            <tr>
              <th>Order #</th>
              <th>Date</th>
              <th>Customer</th>
              <th>Items</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Shipping Address</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="ordersBody"></tbody>
        </table>

        <div id="noOrders" class="no-orders" style="display:none;">
          No orders found.
        </div>
      </div>

      <!-- INVENTORY TAB -->
      <div id="inventoryTab" class="tab-content">
        <div class="inventory-summary">
          <div class="stat-card">
            <div class="number" id="totalProducts">0</div>
            <div class="label">Products</div>
          </div>
          <div class="stat-card shipped">
            <div class="number" id="totalStock">0</div>
            <div class="label">Total Stock</div>
          </div>
          <div class="stat-card pending">
            <div class="number" id="lowStockCount">0</div>
            <div class="label">Low Stock</div>
          </div>
          <div class="stat-card" style="border-color: rgba(239,68,68,0.5);">
            <div class="number" id="outOfStockCount" style="color:#ef4444;">0</div>
            <div class="label">Out of Stock</div>
          </div>
        </div>

        <button class="add-product-btn" onclick="showAddProductModal()">
          <span>âž•</span> Add New Product
        </button>

        <div id="loadingInventory" class="loading" style="display:none;">
          <div class="spinner"></div>
          <div>Loading inventory...</div>
        </div>

        <div id="inventoryGrid" class="inventory-grid"></div>

        <div id="noInventory" class="no-orders" style="display:none;">
          No products in inventory. Add your first product!
        </div>
      </div>

    </div>
  </div>

  <!-- Order Detail Modal -->
  <div id="orderModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Order Details</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- Inventory Modal -->
  <div id="inventoryModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="inventoryModalTitle">Add New Product</h3>
        <button class="modal-close" onclick="closeInventoryModal()">&times;</button>
      </div>
      <div id="inventoryModalBody" style="max-height: 70vh; overflow-y: auto;">
        <div class="form-group">
          <label>Product ID / SKU</label>
          <input type="text" id="productId" placeholder="e.g., bear-hoodie-black">
        </div>
        <div class="form-group">
          <label>Product Name</label>
          <input type="text" id="productName" placeholder="e.g., BEAR Hoodie - Black">
        </div>
        <div class="form-group">
          <label>Price (USD)</label>
          <input type="number" id="productPrice" placeholder="30.00" step="0.01">
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="productDescription" rows="4" placeholder="Enter product description..." style="width:100%; padding:12px; background:rgba(0,0,0,0.3); border:2px solid rgba(104,12,217,0.3); border-radius:8px; color:#fff; font-size:14px; resize:vertical;"></textarea>
        </div>

        <h4 style="margin: 20px 0 15px; color: #00ff88;">Product Images</h4>
        <div id="imageUrlsContainer">
          <div class="image-url-row" style="display:flex; gap:10px; margin-bottom:10px;">
            <input type="text" class="image-url-input" placeholder="https://example.com/image.jpg" style="flex:1; padding:10px; background:rgba(0,0,0,0.3); border:2px solid rgba(104,12,217,0.3); border-radius:8px; color:#fff;">
            <button type="button" onclick="removeImageUrl(this)" style="padding:10px 15px; background:#ef4444; border:none; border-radius:8px; color:#fff; cursor:pointer;">X</button>
          </div>
        </div>
        <button type="button" onclick="addImageUrl()" style="padding:10px 20px; background:rgba(104,12,217,0.3); border:none; border-radius:8px; color:#fff; cursor:pointer; margin-bottom:15px;">+ Add Image URL</button>

        <div id="imagePreviewContainer" style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:15px;"></div>

        <div class="form-group">
          <label>Low Stock Threshold</label>
          <input type="number" id="lowStockThreshold" placeholder="5" value="5">
        </div>
        <h4 style="margin: 20px 0 15px; color: #00ff88;">Stock by Size</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;">
          <div class="form-group" style="margin:0;">
            <label>XS</label>
            <input type="number" id="stock_xs" placeholder="0" value="0">
          </div>
          <div class="form-group" style="margin:0;">
            <label>S</label>
            <input type="number" id="stock_s" placeholder="0" value="0">
          </div>
          <div class="form-group" style="margin:0;">
            <label>M</label>
            <input type="number" id="stock_m" placeholder="0" value="0">
          </div>
          <div class="form-group" style="margin:0;">
            <label>L</label>
            <input type="number" id="stock_l" placeholder="0" value="0">
          </div>
          <div class="form-group" style="margin:0;">
            <label>XL</label>
            <input type="number" id="stock_xl" placeholder="0" value="0">
          </div>
          <div class="form-group" style="margin:0;">
            <label>2XL</label>
            <input type="number" id="stock_2xl" placeholder="0" value="0">
          </div>
        </div>
        <div class="modal-actions">
          <button class="cancel-btn" onclick="closeInventoryModal()">Cancel</button>
          <button class="save" id="saveProductBtn" onclick="saveProduct()">Save Product</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://bearpark-api-production.up.railway.app';
    let sessionToken = null;
    let connectedWallet = null;
    let allOrders = [];
    let currentFilter = 'all';
    let sessionExpiry = null;

    // Check for existing wallet from main site login and auto-authenticate
    async function checkExistingAuth() {
      const statusEl = document.getElementById('authStatus');
      const btn = document.getElementById('authBtn');

      // Check localStorage for wallet from main site XAMAN login
      const wallet = localStorage.getItem('bearpark_wallet');

      if (!wallet) {
        // No wallet - show login prompt
        statusEl.className = 'auth-status';
        statusEl.innerHTML = 'Please <a href="/" style="color:#00ff88;">login on the main site</a> first with your XAMAN wallet.';
        statusEl.style.display = 'block';
        btn.textContent = 'Check Login Status';
        btn.onclick = checkExistingAuth;
        return;
      }

      // Have wallet - verify with server
      btn.disabled = true;
      btn.textContent = 'Verifying...';
      statusEl.className = 'auth-status waiting';
      statusEl.textContent = 'Checking admin access for ' + wallet.slice(0,8) + '...';
      statusEl.style.display = 'block';

      try {
        const res = await fetch(`${API_BASE}/api/merch/admin/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ wallet })
        });

        const data = await res.json();

        if (data.success) {
          onAuthSuccess(data);
        } else if (res.status === 403) {
          onAuthDenied(wallet);
        } else {
          throw new Error(data.error || 'Login failed');
        }

      } catch (error) {
        console.error('Auth error:', error);
        statusEl.className = 'auth-status error';
        statusEl.textContent = 'Error: ' + error.message;
        btn.disabled = false;
        btn.textContent = 'Retry';
      }
    }

    // Start authentication - just check existing login
    function startAuth() {
      checkExistingAuth();
    }

    // Auto-check on page load
    window.addEventListener('DOMContentLoaded', () => {
      checkExistingAuth();
    });

    // Auth successful
    function onAuthSuccess(data) {
      sessionToken = data.session_token;
      connectedWallet = data.wallet;
      sessionExpiry = Date.now() + (data.expires_in * 1000);

      document.getElementById('authScreen').style.display = 'none';
      document.getElementById('adminContent').style.display = 'block';

      const walletEl = document.getElementById('walletStatus');
      walletEl.textContent = connectedWallet.slice(0,8) + '...' + connectedWallet.slice(-6);
      walletEl.classList.remove('not-connected');
      walletEl.classList.add('connected');

      // Start session timer
      updateSessionTimer();
      setInterval(updateSessionTimer, 1000);

      // Load orders
      loadOrders();

      // Auto-refresh orders every 30 seconds to catch payment updates
      setInterval(loadOrders, 30000);
    }

    // Auth denied (not admin wallet)
    function onAuthDenied(wallet) {
      document.getElementById('authScreen').style.display = 'none';
      const deniedEl = document.getElementById('accessDenied');
      deniedEl.style.display = 'block';
      if (wallet) {
        deniedEl.innerHTML = `
          <h2>ACCESS DENIED</h2>
          <p>Your wallet <code style="background:rgba(0,0,0,0.3);padding:5px 10px;border-radius:5px;">${wallet}</code> is not authorized to access this admin panel.</p>
          <p style="margin-top:20px; color:#666;">Only whitelisted admin wallets can access.</p>
        `;
      }
    }

    // Update session timer display
    function updateSessionTimer() {
      if (!sessionExpiry) return;

      const remaining = Math.max(0, sessionExpiry - Date.now());
      const mins = Math.floor(remaining / 60000);
      const secs = Math.floor((remaining % 60000) / 1000);

      document.getElementById('sessionTimer').textContent =
        `Session expires in ${mins}:${secs.toString().padStart(2, '0')}`;

      if (remaining <= 0) {
        sessionToken = null;
        alert('Session expired. Please sign in again.');
        location.reload();
      }
    }

    // Load orders from API
    async function loadOrders() {
      try {
        const res = await fetch(`${API_BASE}/api/merch/admin/orders`, {
          headers: { 'X-Admin-Token': sessionToken }
        });

        if (res.status === 401) {
          alert('Session expired. Please sign in again.');
          location.reload();
          return;
        }

        const data = await res.json();

        if (data.success) {
          allOrders = data.orders || [];
          updateStats();
          renderOrders();
        }
      } catch (error) {
        console.error('Error loading orders:', error);
      }
    }

    function updateStats() {
      const pending = allOrders.filter(o => o.status === 'pending').length;
      const paid = allOrders.filter(o => o.status === 'paid').length;
      const shipped = allOrders.filter(o => o.status === 'shipped').length;
      const revenue = allOrders
        .filter(o => ['paid', 'shipped'].includes(o.status))
        .reduce((sum, o) => sum + parseFloat(o.amount_usd || 0), 0);

      document.getElementById('totalOrders').textContent = allOrders.length;
      document.getElementById('pendingOrders').textContent = pending;
      document.getElementById('paidOrders').textContent = paid;
      document.getElementById('shippedOrders').textContent = shipped;
      document.getElementById('totalRevenue').textContent = '$' + revenue.toFixed(2);
    }

    function filterOrders(status) {
      currentFilter = status;
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      renderOrders();
    }

    function renderOrders() {
      document.getElementById('loadingOrders').style.display = 'none';

      let filtered = allOrders;
      if (currentFilter !== 'all') {
        filtered = allOrders.filter(o => o.status === currentFilter);
      }

      if (filtered.length === 0) {
        document.getElementById('ordersTable').style.display = 'none';
        document.getElementById('noOrders').style.display = 'block';
        return;
      }

      document.getElementById('ordersTable').style.display = 'table';
      document.getElementById('noOrders').style.display = 'none';

      const tbody = document.getElementById('ordersBody');
      tbody.innerHTML = filtered.map(order => {
        const shipping = order.shipping || {};
        const address = [
          shipping.name,
          shipping.street,
          shipping.apt,
          `${shipping.city}, ${shipping.state} ${shipping.zip}`,
          shipping.country
        ].filter(Boolean).join('<br>');

        const date = new Date(order.created_at).toLocaleDateString();

        // Format customer display: username or "No Username", plus short wallet
        const username = order.username || 'No Username';
        const shortWallet = order.wallet_address ? order.wallet_address.slice(0,8) + '...' : 'N/A';
        const destTag = order.destination_tag ? `<br><small style="color:#888;">Tag: ${order.destination_tag}</small>` : '';

        // Parse items for multi-item orders
        let itemsDisplay = '';
        let orderItems = [];
        try {
          if (order.items) {
            orderItems = typeof order.items === 'string' ? JSON.parse(order.items) : order.items;
          }
        } catch (e) {}

        if (orderItems && orderItems.length > 0) {
          // Multi-item order
          const itemCount = orderItems.reduce((sum, item) => sum + (item.quantity || 1), 0);
          const itemsList = orderItems.map(item =>
            `${item.quantity || 1}x ${item.name || 'Product'} (${item.size || 'N/A'})`
          ).join('<br>');
          itemsDisplay = `<div style="font-size:12px;line-height:1.5;">${itemsList}</div><div style="font-size:10px;color:#888;margin-top:4px;">${itemCount} item(s) total</div>`;
        } else if (order.items_summary) {
          // Has summary string
          itemsDisplay = `<div style="font-size:12px;">${order.items_summary}</div>`;
        } else {
          // Legacy single item
          itemsDisplay = `<div style="font-size:12px;">${order.product_name || order.product_id || 'Product'} (${order.size || 'N/A'})</div>`;
        }

        return `
          <tr>
            <td><strong>${order.order_number || order.id.slice(0,8)}</strong></td>
            <td>${date}</td>
            <td>
              <strong style="color:#00ff88;">${username}</strong><br>
              <small style="color:#888;font-family:monospace;">${shortWallet}</small>
              ${destTag}
            </td>
            <td>${itemsDisplay}</td>
            <td>$${order.amount_usd}</td>
            <td><span class="status-badge ${order.status}">${order.status}</span></td>
            <td class="address-cell">${address}</td>
            <td>
              <button class="action-btn details" onclick="showDetails('${order.id}')">Details</button>
              ${order.status === 'paid' ? `<button class="action-btn ship" onclick="markShipped('${order.id}')">Ship</button>` : ''}
              <button class="action-btn delete" onclick="deleteOrder('${order.id}')" style="background:#ef4444;">Delete</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function showDetails(orderId) {
      const order = allOrders.find(o => o.id === orderId);
      if (!order) return;

      const shipping = order.shipping || {};
      const address = [
        shipping.name,
        shipping.street,
        shipping.apt,
        `${shipping.city}, ${shipping.state} ${shipping.zip}`,
        shipping.country
      ].filter(Boolean).join('\n');

      const usernameDisplay = order.username || 'No Username';

      // Parse items for multi-item orders
      let orderItems = [];
      try {
        if (order.items) {
          orderItems = typeof order.items === 'string' ? JSON.parse(order.items) : order.items;
        }
      } catch (e) {}

      const isMultiItem = orderItems && orderItems.length > 0;

      // Build items HTML
      let itemsHtml = '';
      if (isMultiItem) {
        itemsHtml = `
          <h4 style="margin-top:20px;margin-bottom:10px;color:#00ff88;">Order Items (${orderItems.reduce((sum, i) => sum + (i.quantity || 1), 0)} total)</h4>
          <div style="background:rgba(0,0,0,0.3);border-radius:12px;padding:15px;">
            ${orderItems.map(item => `
              <div style="display:flex;gap:12px;align-items:center;padding:10px;background:rgba(104,12,217,0.1);border-radius:8px;margin-bottom:8px;border:1px solid rgba(104,12,217,0.3);">
                ${item.image ? `<img src="${item.image}" style="width:50px;height:50px;object-fit:cover;border-radius:6px;">` : '<div style="width:50px;height:50px;background:#333;border-radius:6px;display:flex;align-items:center;justify-content:center;">ðŸ‘•</div>'}
                <div style="flex:1;">
                  <div style="font-weight:700;color:#fff;">${item.name || 'Product'}</div>
                  <div style="font-size:12px;color:#888;">Size: ${item.size || 'N/A'} | Qty: ${item.quantity || 1}</div>
                </div>
                <div style="font-weight:700;color:#00ff88;">$${((item.price || 0) * (item.quantity || 1)).toFixed(2)}</div>
              </div>
            `).join('')}
          </div>
        `;
      } else {
        // Legacy single item display
        itemsHtml = `
          <div class="detail-row"><span class="label">Product</span><span class="value">${order.product_name || order.product_id || 'Product'}</span></div>
          <div class="detail-row"><span class="label">Size</span><span class="value">${order.size || 'N/A'}</span></div>
        `;
      }

      document.getElementById('modalBody').innerHTML = `
        <div class="detail-row"><span class="label">Order Number</span><span class="value">${order.order_number || order.id}</span></div>
        <div class="detail-row"><span class="label">Status</span><span class="value"><span class="status-badge ${order.status}">${order.status}</span></span></div>
        <div class="detail-row"><span class="label">Customer</span><span class="value" style="color:#00ff88;font-weight:bold;">${usernameDisplay}</span></div>
        <div class="detail-row"><span class="label">Wallet</span><span class="value" style="font-family:monospace;font-size:12px;">${order.wallet_address}</span></div>
        ${order.destination_tag ? `<div class="detail-row"><span class="label">Destination Tag</span><span class="value" style="font-family:monospace;">${order.destination_tag}</span></div>` : ''}

        ${itemsHtml}

        <div class="detail-row"><span class="label">Total Amount</span><span class="value" style="color:#00ff88;font-size:18px;font-weight:bold;">$${order.amount_usd} USD</span></div>
        <div class="detail-row"><span class="label">Payment Method</span><span class="value">${order.payment_method || 'RLUSD'}</span></div>
        <div class="detail-row"><span class="label">Created</span><span class="value">${new Date(order.created_at).toLocaleString()}</span></div>
        ${order.payment_tx_hash ? `<div class="detail-row"><span class="label">TX Hash</span><span class="value" style="font-family:monospace;font-size:11px;">${order.payment_tx_hash}</span></div>` : ''}
        ${order.tracking_number ? `<div class="detail-row"><span class="label">Tracking</span><span class="value">${order.tracking_number}</span></div>` : ''}

        <h4 style="margin-top:20px;margin-bottom:10px;color:#00ff88;">Shipping Address</h4>
        <pre style="background:rgba(0,0,0,0.3);padding:15px;border-radius:8px;white-space:pre-wrap;">${address}</pre>

        ${order.status === 'paid' ? `
          <div class="form-group" style="margin-top:20px;">
            <label>Tracking Number</label>
            <input type="text" id="trackingInput" placeholder="Enter tracking number">
          </div>
          <div class="form-group">
            <label>Notes</label>
            <textarea id="notesInput" rows="3" placeholder="Internal notes...">${order.notes || ''}</textarea>
          </div>
          <div class="modal-actions">
            <button class="cancel-btn" onclick="closeModal()">Cancel</button>
            <button class="save" onclick="updateOrder('${order.id}')">Mark as Shipped</button>
          </div>
        ` : `
          <div class="modal-actions">
            <button class="cancel-btn" onclick="closeModal()">Close</button>
            <button style="background:#ef4444;" onclick="closeModal(); deleteOrder('${order.id}')">Delete Order</button>
          </div>
        `}
      `;

      document.getElementById('orderModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('orderModal').classList.remove('active');
    }

    async function markShipped(orderId) {
      if (!confirm('Mark this order as shipped?')) return;

      try {
        const res = await fetch(`${API_BASE}/api/merch/admin/orders/${orderId}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Token': sessionToken
          },
          body: JSON.stringify({ status: 'shipped' })
        });

        if (res.ok) {
          alert('Order marked as shipped!');
          loadOrders();
        } else if (res.status === 401) {
          alert('Session expired. Please sign in again.');
          location.reload();
        }
      } catch (error) {
        alert('Error updating order');
      }
    }

    async function deleteOrder(orderId) {
      const order = allOrders.find(o => o.id === orderId);
      const orderNum = order ? order.order_number : orderId.slice(0,8);

      if (!confirm(`Are you sure you want to DELETE order ${orderNum}?\n\nThis cannot be undone!`)) return;

      try {
        const res = await fetch(`${API_BASE}/api/merch/admin/orders/${orderId}`, {
          method: 'DELETE',
          headers: {
            'X-Admin-Token': sessionToken
          }
        });

        if (res.ok) {
          alert('Order deleted!');
          loadOrders();
        } else if (res.status === 401) {
          alert('Session expired. Please sign in again.');
          location.reload();
        } else {
          const data = await res.json();
          alert('Error: ' + (data.error || 'Failed to delete'));
        }
      } catch (error) {
        alert('Error deleting order');
      }
    }

    async function updateOrder(orderId) {
      const tracking = document.getElementById('trackingInput').value;
      const notes = document.getElementById('notesInput').value;

      try {
        const res = await fetch(`${API_BASE}/api/merch/admin/orders/${orderId}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Token': sessionToken
          },
          body: JSON.stringify({
            status: 'shipped',
            tracking_number: tracking,
            notes: notes
          })
        });

        if (res.ok) {
          alert('Order updated and marked as shipped!');
          closeModal();
          loadOrders();
        } else if (res.status === 401) {
          alert('Session expired. Please sign in again.');
          location.reload();
        }
      } catch (error) {
        alert('Error updating order');
      }
    }

    // ============================================
    // INVENTORY MANAGEMENT
    // ============================================

    let inventory = [];
    let editingProductId = null;
    const SIZES = ['XS', 'S', 'M', 'L', 'XL', '2XL'];

    // Switch between tabs
    function switchTab(tab) {
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.closest('.tab-btn').classList.add('active');

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

      if (tab === 'orders') {
        document.getElementById('ordersTab').classList.add('active');
      } else if (tab === 'inventory') {
        document.getElementById('inventoryTab').classList.add('active');
        loadInventory();
      }
    }

    // Load inventory from API
    async function loadInventory() {
      document.getElementById('loadingInventory').style.display = 'block';
      document.getElementById('inventoryGrid').innerHTML = '';

      try {
        const res = await fetch(`${API_BASE}/api/merch/admin/inventory`, {
          headers: { 'X-Admin-Token': sessionToken }
        });

        if (res.status === 401) {
          alert('Session expired. Please sign in again.');
          location.reload();
          return;
        }

        if (res.ok) {
          const data = await res.json();
          if (data.success) {
            // Normalize field names from API (snake_case to camelCase)
            inventory = (data.inventory || []).map(item => ({
              id: item.id,
              name: item.name,
              description: item.description || '',
              price: item.price,
              lowStockThreshold: item.low_stock_threshold || 5,
              stock: item.stock || { S: 0, M: 0, L: 0, XL: 0, '2XL': 0 },
              images: item.images || []
            }));
            console.log(`ðŸ“¦ Loaded ${inventory.length} products from database`);
          }
        } else {
          console.error('Failed to load inventory from API');
          inventory = [];
        }
      } catch (error) {
        console.error('Error loading inventory:', error);
        inventory = [];
      }

      document.getElementById('loadingInventory').style.display = 'none';
      updateInventoryStats();
      renderInventory();
    }

    // Save product to API
    async function saveProductToAPI(product, isNew = false) {
      try {
        const method = isNew ? 'POST' : 'PUT';
        const url = isNew
          ? `${API_BASE}/api/merch/admin/inventory`
          : `${API_BASE}/api/merch/admin/inventory/${product.id}`;

        const res = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Token': sessionToken
          },
          body: JSON.stringify({
            id: product.id,
            name: product.name,
            description: product.description,
            price: product.price,
            low_stock_threshold: product.lowStockThreshold,
            stock: product.stock,
            images: product.images
          })
        });

        if (res.status === 401) {
          alert('Session expired. Please sign in again.');
          location.reload();
          return false;
        }

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'Failed to save product');
        }

        console.log(`ðŸ“¦ Product ${product.id} saved to database`);
        return true;
      } catch (error) {
        console.error('Error saving product:', error);
        alert('Error saving product: ' + error.message);
        return false;
      }
    }

    // Delete product from API
    async function deleteProductFromAPI(productId) {
      try {
        const res = await fetch(`${API_BASE}/api/merch/admin/inventory/${productId}`, {
          method: 'DELETE',
          headers: { 'X-Admin-Token': sessionToken }
        });

        if (res.status === 401) {
          alert('Session expired. Please sign in again.');
          location.reload();
          return false;
        }

        if (!res.ok) {
          throw new Error('Failed to delete product');
        }

        console.log(`ðŸ—‘ï¸ Product ${productId} deleted from database`);
        return true;
      } catch (error) {
        console.error('Error deleting product:', error);
        alert('Error deleting product: ' + error.message);
        return false;
      }
    }

    // Update inventory stats
    function updateInventoryStats() {
      let totalStock = 0;
      let lowStock = 0;
      let outOfStock = 0;

      inventory.forEach(product => {
        const productTotal = Object.values(product.stock).reduce((a, b) => a + b, 0);
        totalStock += productTotal;

        // Check each size for low/out of stock
        Object.entries(product.stock).forEach(([size, qty]) => {
          if (qty === 0) outOfStock++;
          else if (qty <= product.lowStockThreshold) lowStock++;
        });
      });

      document.getElementById('totalProducts').textContent = inventory.length;
      document.getElementById('totalStock').textContent = totalStock;
      document.getElementById('lowStockCount').textContent = lowStock;
      document.getElementById('outOfStockCount').textContent = outOfStock;
    }

    // Render inventory grid
    function renderInventory() {
      const grid = document.getElementById('inventoryGrid');

      if (inventory.length === 0) {
        grid.innerHTML = '';
        document.getElementById('noInventory').style.display = 'block';
        return;
      }

      document.getElementById('noInventory').style.display = 'none';

      grid.innerHTML = inventory.map(product => {
        const totalStock = Object.values(product.stock).reduce((a, b) => a + b, 0);
        const hasLowStock = Object.entries(product.stock).some(([s, q]) => q > 0 && q <= product.lowStockThreshold);
        const hasOutOfStock = Object.values(product.stock).some(q => q === 0);

        let statusClass = 'in-stock';
        let statusText = 'In Stock';
        if (totalStock === 0) {
          statusClass = 'out-of-stock';
          statusText = 'Out of Stock';
        } else if (hasOutOfStock || hasLowStock) {
          statusClass = 'low-stock';
          statusText = 'Low Stock';
        }

        const sizeItems = SIZES.map(size => {
          const qty = product.stock[size] || 0;
          let sizeClass = '';
          if (qty === 0) sizeClass = 'out';
          else if (qty <= product.lowStockThreshold) sizeClass = 'low';

          return `
            <div class="size-item ${sizeClass}">
              <div class="size-label">${size}</div>
              <div class="size-qty">${qty}</div>
            </div>
          `;
        }).join('');

        // Image thumbnail
        const imageThumb = product.images && product.images.length > 0
          ? `<img src="${product.images[0]}" style="width:60px; height:60px; object-fit:cover; border-radius:8px; margin-right:15px;">`
          : `<div style="width:60px; height:60px; background:linear-gradient(135deg,#680cd9,#00ff88); border-radius:8px; margin-right:15px; display:flex; align-items:center; justify-content:center; font-size:24px;">ðŸ‘•</div>`;

        return `
          <div class="inventory-card" data-product-id="${product.id}">
            <div class="inventory-card-header">
              <div style="display:flex; align-items:flex-start;">
                ${imageThumb}
                <div>
                  <div class="inventory-card-title">${product.name}</div>
                  <div class="inventory-card-sku">SKU: ${product.id}</div>
                  <div style="color:#00ff88; font-weight:700; margin-top:5px;">$${product.price.toFixed(2)}</div>
                  ${product.images && product.images.length > 1 ? `<div style="font-size:11px; color:#888; margin-top:3px;">${product.images.length} images</div>` : ''}
                </div>
              </div>
              <span class="inventory-status ${statusClass}">${statusText}</span>
            </div>
            ${product.description ? `<div style="font-size:12px; color:#999; margin-bottom:10px; line-height:1.4; max-height:40px; overflow:hidden;">${product.description.substring(0,100)}${product.description.length > 100 ? '...' : ''}</div>` : ''}
            <div class="size-grid">${sizeItems}</div>
            <div class="inventory-actions">
              <button class="inventory-btn edit" onclick="editProduct('${product.id}')">Edit Product</button>
              <button class="inventory-btn" style="background:#ef4444;" onclick="deleteProduct('${product.id}')">Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Show add product modal
    function showAddProductModal() {
      editingProductId = null;
      document.getElementById('inventoryModalTitle').textContent = 'Add New Product';
      document.getElementById('productId').value = '';
      document.getElementById('productId').disabled = false;
      document.getElementById('productName').value = '';
      document.getElementById('productPrice').value = '';
      document.getElementById('productDescription').value = '';
      document.getElementById('lowStockThreshold').value = '5';

      // Reset image URLs
      resetImageUrls([]);

      SIZES.forEach(size => {
        const sizeKey = size.toLowerCase().replace('2xl', '2xl');
        document.getElementById('stock_' + sizeKey).value = '0';
      });

      document.getElementById('inventoryModal').classList.add('active');
    }

    // Edit product
    function editProduct(productId) {
      const product = inventory.find(p => p.id === productId);
      if (!product) return;

      editingProductId = productId;
      document.getElementById('inventoryModalTitle').textContent = 'Edit Product';
      document.getElementById('productId').value = product.id;
      document.getElementById('productId').disabled = true;
      document.getElementById('productName').value = product.name;
      document.getElementById('productPrice').value = product.price;
      document.getElementById('productDescription').value = product.description || '';
      document.getElementById('lowStockThreshold').value = product.lowStockThreshold;

      // Set image URLs
      resetImageUrls(product.images || []);

      document.getElementById('stock_xs').value = product.stock.XS || 0;
      document.getElementById('stock_s').value = product.stock.S || 0;
      document.getElementById('stock_m').value = product.stock.M || 0;
      document.getElementById('stock_l').value = product.stock.L || 0;
      document.getElementById('stock_xl').value = product.stock.XL || 0;
      document.getElementById('stock_2xl').value = product.stock['2XL'] || 0;

      document.getElementById('inventoryModal').classList.add('active');
    }

    // Reset image URL inputs
    function resetImageUrls(images) {
      const container = document.getElementById('imageUrlsContainer');
      container.innerHTML = '';

      if (images.length === 0) {
        // Add one empty input
        addImageUrl();
      } else {
        images.forEach(url => {
          addImageUrl(url);
        });
      }
      updateImagePreviews();
    }

    // Add image URL input
    function addImageUrl(value = '') {
      const container = document.getElementById('imageUrlsContainer');
      const row = document.createElement('div');
      row.className = 'image-url-row';
      row.style.cssText = 'display:flex; gap:10px; margin-bottom:10px;';
      row.innerHTML = `
        <input type="text" class="image-url-input" value="${value}" placeholder="https://example.com/image.jpg" style="flex:1; padding:10px; background:rgba(0,0,0,0.3); border:2px solid rgba(104,12,217,0.3); border-radius:8px; color:#fff;" onchange="updateImagePreviews()">
        <button type="button" onclick="removeImageUrl(this)" style="padding:10px 15px; background:#ef4444; border:none; border-radius:8px; color:#fff; cursor:pointer;">X</button>
      `;
      container.appendChild(row);
    }

    // Remove image URL input
    function removeImageUrl(btn) {
      const row = btn.closest('.image-url-row');
      row.remove();
      // Ensure at least one input exists
      const container = document.getElementById('imageUrlsContainer');
      if (container.children.length === 0) {
        addImageUrl();
      }
      updateImagePreviews();
    }

    // Update image previews
    function updateImagePreviews() {
      const previewContainer = document.getElementById('imagePreviewContainer');
      const inputs = document.querySelectorAll('.image-url-input');
      let html = '';

      inputs.forEach((input, idx) => {
        const url = input.value.trim();
        if (url) {
          html += `<div style="position:relative;">
            <img src="${url}" style="width:80px; height:80px; object-fit:cover; border-radius:8px; border:2px solid rgba(104,12,217,0.5);" onerror="this.style.display='none'">
            <span style="position:absolute; top:-5px; left:-5px; background:#680cd9; color:#fff; width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:bold;">${idx + 1}</span>
          </div>`;
        }
      });

      previewContainer.innerHTML = html || '<span style="color:#666; font-size:13px;">No images added yet</span>';
    }

    // Get all image URLs
    function getImageUrls() {
      const inputs = document.querySelectorAll('.image-url-input');
      return Array.from(inputs)
        .map(input => input.value.trim())
        .filter(url => url.length > 0);
    }

    // Save product
    async function saveProduct() {
      const productId = document.getElementById('productId').value.trim().toLowerCase().replace(/\s+/g, '-');
      const productName = document.getElementById('productName').value.trim();
      const productPrice = parseFloat(document.getElementById('productPrice').value) || 0;
      const productDescription = document.getElementById('productDescription').value.trim();
      const lowStockThreshold = parseInt(document.getElementById('lowStockThreshold').value) || 5;
      const images = getImageUrls();

      if (!productId || !productName) {
        alert('Please enter product ID and name');
        return;
      }

      const stock = {
        XS: parseInt(document.getElementById('stock_xs').value) || 0,
        S: parseInt(document.getElementById('stock_s').value) || 0,
        M: parseInt(document.getElementById('stock_m').value) || 0,
        L: parseInt(document.getElementById('stock_l').value) || 0,
        XL: parseInt(document.getElementById('stock_xl').value) || 0,
        '2XL': parseInt(document.getElementById('stock_2xl').value) || 0
      };

      const product = {
        id: productId,
        name: productName.toUpperCase(),
        description: productDescription,
        price: productPrice,
        lowStockThreshold,
        stock,
        images
      };
      const isNew = !editingProductId;

      // Check if product ID already exists when adding new
      if (isNew && inventory.some(p => p.id === productId)) {
        alert('A product with this ID already exists!');
        return;
      }

      // Save to API
      const success = await saveProductToAPI(product, isNew);
      if (!success) return;

      // Update local inventory array
      if (editingProductId) {
        const idx = inventory.findIndex(p => p.id === editingProductId);
        if (idx !== -1) {
          inventory[idx] = product;
        }
      } else {
        inventory.push(product);
      }

      closeInventoryModal();
      updateInventoryStats();
      renderInventory();
    }

    // Delete product
    async function deleteProduct(productId) {
      const product = inventory.find(p => p.id === productId);
      if (!product) return;

      if (!confirm(`Delete "${product.name}"?\n\nThis cannot be undone!`)) return;

      // Delete from API
      const success = await deleteProductFromAPI(productId);
      if (!success) return;

      // Update local inventory array
      inventory = inventory.filter(p => p.id !== productId);
      updateInventoryStats();
      renderInventory();
    }

    // Close inventory modal
    function closeInventoryModal() {
      document.getElementById('inventoryModal').classList.remove('active');
      editingProductId = null;
    }
  </script>
</body>
</html>
