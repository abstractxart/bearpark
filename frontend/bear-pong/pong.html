<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>BEAR PONG - Multiplayer</title>

    <!-- BEAR Park Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet" />

    <!-- BEAR Park Authentication - Read URL params and store to localStorage -->
    <script>
      (function() {
        try {
          // Read URL parameters
          const urlParams = new URLSearchParams(window.location.search);
          const wallet = urlParams.get('wallet');
          const displayName = urlParams.get('display_name');
          const twitterUsername = urlParams.get('twitter_username');
          const avatarUrl = urlParams.get('avatar_url');

          // Store to localStorage if provided
          if (wallet) {
            localStorage.setItem('xaman_wallet_address', wallet);
            console.log('‚úÖ Wallet address synced from BEAR Park:', wallet);
          }

          if (displayName) {
            localStorage.setItem('display_name', displayName);
            console.log('‚úÖ Display name synced from BEAR Park:', displayName);
          }

          if (twitterUsername) {
            localStorage.setItem('twitter_username', twitterUsername);
            console.log('‚úÖ Twitter username synced from BEAR Park:', twitterUsername);
          }

          if (avatarUrl) {
            localStorage.setItem('avatar_url', avatarUrl);
            console.log('‚úÖ Avatar URL synced from BEAR Park:', avatarUrl);
          }

          // Clean URL after reading params (optional - removes params from address bar)
          if (wallet || displayName || twitterUsername || avatarUrl) {
            const cleanUrl = window.location.origin + window.location.pathname;
            window.history.replaceState({}, document.title, cleanUrl);
          }
        } catch (error) {
          console.error('Error reading BEAR Park authentication data:', error);
        }
      })();
    </script>


    <style>
      html, body {
        background: black;
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        overscroll-behavior: none;
      }

      #game-container {
        width: 100%;
        height: 100%;
      }

      /* Let Phaser handle canvas positioning */
      #game-container canvas {
        display: block;
      }
    </style>
    <script type="module" crossorigin src="./assets/pong-CXiKi2nA.js"></script>
    <link rel="modulepreload" crossorigin href="./assets/phaser-skL0-YrO.js">
  </head>
  <body>
    <div id="game-container"></div>

    <!-- BEAR Park Game Points Integration -->
    <script src="/frontend/game-points-helper.js" onerror="console.error('Failed to load game-points-helper.js')"></script>
    <script>
      // Verify helper loaded
      if (typeof awardGamePoints === 'undefined') {
        console.error('‚ö†Ô∏è game-points-helper.js did not load correctly!');
      } else {
        console.log('‚úÖ game-points-helper.js loaded successfully');
      }
    </script>
    <script>
      // HONEY POINTS TIMER - Only awards points for time with active tapping (every 2.5-3 seconds)
      let gameRoundStartTime = null;
      let interactionTimestamps = []; // Store all interaction times
      let waitingForGameStart = true;
      let readyToStart = false;
      let gameCompletionHandled = false;
      const MIN_TAP_INTERVAL = 2500; // 2.5 seconds
      const MAX_TAP_INTERVAL = 3000; // 3 seconds
      const MAX_ROUND_TIME_MS = 300000; // 5 minutes max per round

      // Track user interaction timestamps
      function handleUserInteraction() {
        const now = Date.now();

        // Start timer logic (two-interaction system)
        if (waitingForGameStart && !gameRoundStartTime) {
          if (!readyToStart) {
            readyToStart = true;
            console.log('‚è±Ô∏è Ready... (next interaction will start timer)');
          } else {
            // Start the timer
            gameRoundStartTime = now;
            interactionTimestamps = [now];
            waitingForGameStart = false;
            readyToStart = false;
            console.log('‚è±Ô∏è Gameplay started - tracking interactions for honey points');
          }
        } else if (gameRoundStartTime) {
          // Record interaction timestamp during gameplay
          interactionTimestamps.push(now);
        }
      }

      // Listen for ALL user interactions
      document.addEventListener('click', handleUserInteraction);
      document.addEventListener('keydown', handleUserInteraction);
      document.addEventListener('touchstart', handleUserInteraction);
      document.addEventListener('mousedown', handleUserInteraction);
      document.addEventListener('touchmove', handleUserInteraction);
      document.addEventListener('pointermove', handleUserInteraction);

      // Calculate active gameplay time based on tap frequency
      function calculateActiveGameplayMinutes(timestamps, gameStart, gameEnd) {
        if (timestamps.length === 0) return 0;

        // Sort timestamps just in case
        timestamps.sort((a, b) => a - b);

        let activeSeconds = 0;
        let lastActiveTimestamp = gameStart;

        // Go through each timestamp and count active periods
        for (let i = 0; i < timestamps.length; i++) {
          const currentTimestamp = timestamps[i];
          const timeSinceLastActive = currentTimestamp - lastActiveTimestamp;

          // If this tap is within 2.5-3 seconds of the last active period
          if (timeSinceLastActive <= MAX_TAP_INTERVAL) {
            // Count the time between last active and this tap as active
            activeSeconds += timeSinceLastActive / 1000;
            lastActiveTimestamp = currentTimestamp;
          } else {
            // Gap too large, reset active tracking from this tap
            lastActiveTimestamp = currentTimestamp;
          }
        }

        // Convert to minutes and round to 0.1 precision
        const activeMinutes = Math.round((activeSeconds / 60) * 10) / 10;
        return activeMinutes;
      }

      // Function to handle game completion and award points
      window.handlePongGameCompletion = async function() {
        if (gameCompletionHandled) return;
        gameCompletionHandled = true;

        console.log('üéÆ BEAR PONG game completed!');

        let minutesPlayed = 0;

        if (gameRoundStartTime) {
          const roundEndTime = Date.now();
          const totalElapsed = roundEndTime - gameRoundStartTime;
          const totalSeconds = totalElapsed / 1000;

          // Calculate active gameplay based on interaction pattern
          minutesPlayed = calculateActiveGameplayMinutes(interactionTimestamps, gameRoundStartTime, roundEndTime);

          // Cap at max round time (5 minutes)
          const maxMinutes = MAX_ROUND_TIME_MS / 60000;
          if (minutesPlayed > maxMinutes) {
            console.log(`‚ö†Ô∏è Round time capped at ${maxMinutes} minutes (was ${minutesPlayed.toFixed(1)})`);
            minutesPlayed = maxMinutes;
          }

          console.log(`‚è±Ô∏è Round ended - Total time: ${totalSeconds.toFixed(1)}s`);
          console.log(`‚è±Ô∏è Total interactions: ${interactionTimestamps.length}`);
          console.log(`‚è±Ô∏è Active gameplay (with tapping): ${minutesPlayed.toFixed(1)} minutes`);

          // Reset timer state BEFORE awarding points
          gameRoundStartTime = null;
          interactionTimestamps = [];
          waitingForGameStart = true;
          readyToStart = false;
        }

        // Award points AFTER timer is stopped and reset
        if (minutesPlayed > 0) {
          console.log('üçØ Awarding honey points for active gameplay time...');
          setTimeout(async () => {
            await awardGamePoints('bear-pong', minutesPlayed);
            console.log('‚è±Ô∏è Click/tap twice to start next round timer.');

            // Reset flag after awarding
            setTimeout(() => {
              gameCompletionHandled = false;
            }, 2000);
          }, 100);
        } else {
          console.log('‚ö†Ô∏è No active gameplay detected (need tapping every 2.5-3 seconds)');
          setTimeout(() => {
            gameCompletionHandled = false;
          }, 2000);
        }
      };

      console.log('üéÆ BEAR PONG honey points integration active!');
      console.log('üéØ Earn points by tapping/playing every 2.5-3 seconds');
      console.log('üîí Only active gameplay with consistent tapping counts!');
    </script>
  </body>
</html>
