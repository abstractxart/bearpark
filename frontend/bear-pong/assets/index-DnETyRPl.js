import{r as x,g as A}from"./phaser-0YPJO2g1.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))e(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&e(a)}).observe(document,{childList:!0,subtree:!0});function s(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function e(n){if(n.ep)return;n.ep=!0;const i=s(n);fetch(n.href,i)}})();var b=x();const r=A(b);class T{ws=null;serverUrl;messageHandlers=new Map;reconnectAttempts=0;maxReconnectAttempts=5;reconnectDelay=2e3;playerData=null;constructor(t){this.serverUrl=t}connect(){return new Promise((t,s)=>{console.log(`üîå Connecting to Pong server: ${this.serverUrl}`);try{this.ws=new WebSocket(this.serverUrl),this.ws.onopen=()=>{console.log("‚úÖ Connected to Pong server"),this.reconnectAttempts=0,t()},this.ws.onmessage=e=>{try{const n=JSON.parse(e.data);this.handleServerMessage(n)}catch(n){console.error("‚ùå Error parsing server message:",n)}},this.ws.onclose=()=>{console.log("üîå Disconnected from Pong server"),this.attemptReconnect()},this.ws.onerror=e=>{console.error("‚ùå WebSocket error:",e),s(e)}}catch(e){console.error("‚ùå Failed to create WebSocket:",e),s(e)}})}attemptReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){console.log("‚ùå Max reconnect attempts reached"),this.emit("connection_failed",null);return}this.reconnectAttempts++,console.log(`üîÑ Reconnecting... (attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts})`),setTimeout(()=>{this.connect().catch(()=>{})},this.reconnectDelay*this.reconnectAttempts)}handleServerMessage(t){switch(console.log("üì® Received:",t.type,t),t.type){case"queue_joined":this.emit("queue_joined",t.position);break;case"match_found":this.emit("match_found",{opponent:t.opponent,yourSide:t.yourSide});break;case"countdown":this.emit("countdown",t.count);break;case"game_state":this.emit("game_state",t.state);break;case"game_over":this.emit("game_over",{winner:t.winner,finalScore:t.finalScore});break;case"opponent_disconnected":this.emit("opponent_disconnected",null);break;case"rematch_requested":this.emit("rematch_requested",null);break;case"rematch_accepted":this.emit("rematch_accepted",null);break;case"error":this.emit("error",t.message);break;default:console.log("‚ö†Ô∏è Unknown message type:",t.type)}}on(t,s){this.messageHandlers.set(t,s)}emit(t,s){const e=this.messageHandlers.get(t);e&&e(s)}send(t){this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify(t)):console.error("‚ùå Cannot send message - WebSocket not connected")}joinQueue(t){console.log("üéØ Joining matchmaking queue..."),this.playerData=t,this.send({type:"join_queue",data:t})}getPlayerData(){return this.playerData}movePaddle(t){this.send({type:"paddle_move",y:t,timestamp:Date.now()})}ready(){this.send({type:"ready"})}requestRematch(){this.send({type:"rematch"})}leave(){this.send({type:"leave"})}disconnect(){this.ws&&(this.ws.close(),this.ws=null)}isConnected(){return this.ws!==null&&this.ws.readyState===WebSocket.OPEN}}const f="https://www.bearpark.xyz/api",m="pong";class c{static getWalletAddress(){return localStorage.getItem("xaman_wallet_address")}static getDisplayName(){return localStorage.getItem("display_name")||"Anonymous"}static getAvatarUrl(){return localStorage.getItem("avatar_url")}static getCurrentUserDisplayName(){const t=localStorage.getItem("display_name");if(t&&t.trim()!=="")return t;const s=localStorage.getItem("twitter_username");if(s&&s.trim()!=="")return s;const e=this.getWalletAddress();return e?this.formatWalletAddress(e):"Anonymous"}static isAuthenticated(){return!!this.getWalletAddress()}static async submitWin(t={}){const s=this.getWalletAddress();if(!s)return console.log("‚ÑπÔ∏è Win not submitted - user not authenticated"),{success:!1,error:"Not authenticated",message:"Connect your wallet at bearpark.xyz to save stats!"};const e=this.getLocalStats();e.wins++,this.saveLocalStats(e);try{const n={wallet_address:s,game_id:m,score:e.wins,metadata:{...t,wins:e.wins,losses:e.losses,total_games:e.wins+e.losses,win_rate:e.wins/(e.wins+e.losses),timestamp:new Date().toISOString(),display_name:this.getDisplayName(),result:"win"}};console.log("üì§ Submitting win to BEAR Park API...");const a=await(await fetch(`${f}/leaderboard`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})).json();return a.success&&console.log("‚úÖ Win submitted to BEAR Park"),a}catch(n){return console.error("‚ùå Error submitting win to BEAR Park:",n),{success:!1,error:n instanceof Error?n.message:"Unknown error"}}}static async submitLoss(t={}){const s=this.getWalletAddress();if(!s)return console.log("‚ÑπÔ∏è Loss not submitted - user not authenticated"),{success:!1,error:"Not authenticated",message:"Connect your wallet at bearpark.xyz to save stats!"};const e=this.getLocalStats();e.losses++,this.saveLocalStats(e);try{const n={wallet_address:s,game_id:m,score:e.wins,metadata:{...t,wins:e.wins,losses:e.losses,total_games:e.wins+e.losses,win_rate:e.wins/(e.wins+e.losses),timestamp:new Date().toISOString(),display_name:this.getDisplayName(),result:"loss"}};console.log("üì§ Submitting loss to BEAR Park API...");const a=await(await fetch(`${f}/leaderboard`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})).json();return a.success&&console.log("‚úÖ Loss submitted to BEAR Park"),a}catch(n){return console.error("‚ùå Error submitting loss to BEAR Park:",n),{success:!1,error:n instanceof Error?n.message:"Unknown error"}}}static getLocalStats(){const t=parseInt(localStorage.getItem("pongWins")||"0"),s=parseInt(localStorage.getItem("pongLosses")||"0"),e=t+s,n=e>0?t/e:0;return{wins:t,losses:s,totalGames:e,winRate:n}}static saveLocalStats(t){localStorage.setItem("pongWins",t.wins.toString()),localStorage.setItem("pongLosses",t.losses.toString())}static async getLeaderboard(t=10){try{const s=`${f}/leaderboard/${m}?limit=${t}`;return console.log("üîç Fetching Pong leaderboard from:",s),(await(await fetch(s)).json()).leaderboard||[]}catch(s){return console.error("‚ùå Error fetching Pong leaderboard:",s),[]}}static async getMyStats(){const t=this.getWalletAddress();if(!t)return null;try{return(await(await fetch(`${f}/leaderboard/${m}/${t}`)).json()).entry||null}catch(s){return console.error("‚ùå Error fetching user stats from BEAR Park:",s),null}}static formatWalletAddress(t){return!t||t.length<8?t:`${t.substring(0,4)}...${t.substring(t.length-4)}`}static formatDisplayName(t){return t.display_name?t.display_name:t.twitter_username?t.twitter_username:t.wallet_address?this.formatWalletAddress(t.wallet_address):"Anonymous"}}class v extends r.Scene{pongClient=null;statusText=null;queuePositionText=null;loadingDots="";loadingTimer=null;statsText=null;constructor(){super({key:"PongLobbyScene"})}create(){const{width:t,height:s}=this.cameras.main;this.add.rectangle(0,0,t,s,0).setOrigin(0),this.add.text(t/2,100,"BEAR PONG",{fontSize:"64px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),this.add.text(t/2,180,"Multiplayer Mode",{fontSize:"24px",color:"#4a90e2"}).setOrigin(.5),this.displayPlayerStats(),this.statusText=this.add.text(t/2,400,"Searching for opponent",{fontSize:"32px",color:"#ffffff"}),this.statusText.setOrigin(.5),this.queuePositionText=this.add.text(t/2,460,"",{fontSize:"20px",color:"#aaaaaa"}),this.queuePositionText.setOrigin(.5),this.loadingTimer=this.time.addEvent({delay:500,callback:()=>{this.loadingDots=this.loadingDots.length>=3?"":this.loadingDots+".",this.statusText&&this.statusText.setText(`Searching for opponent${this.loadingDots}`)},loop:!0}),this.add.text(t/2,s-150,"Waiting for another player to join...",{fontSize:"18px",color:"#888888",align:"center"}).setOrigin(.5);const a=this.add.text(t/2,s-80,"[ ESC to Cancel ]",{fontSize:"16px",color:"#ff6b6b"});a.setOrigin(.5),a.setInteractive({useHandCursor:!0}),a.on("pointerdown",()=>{this.cancelMatchmaking()}),this.input.keyboard?.on("keydown-ESC",()=>{this.cancelMatchmaking()}),this.connectToServer()}displayPlayerStats(){const t=c.getLocalStats(),s=c.getCurrentUserDisplayName(),e=this.add.container(this.cameras.main.width/2,280),n=this.add.text(0,0,`Player: ${s}`,{fontSize:"20px",color:"#ffffff"});n.setOrigin(.5),e.add(n),this.statsText=this.add.text(0,40,`Wins: ${t.wins}  |  Losses: ${t.losses}  |  Win Rate: ${(t.winRate*100).toFixed(1)}%`,{fontSize:"16px",color:"#4a90e2"}),this.statsText.setOrigin(.5),e.add(this.statsText)}async fetchPlayerAvatar(t){try{const e=await(await fetch(`/api/profile/${t}`)).json();if(e.success&&e.profile&&e.profile.avatar_nft)try{const n=JSON.parse(e.profile.avatar_nft);return n.imageUrl||n.fallbackImageUrl||null}catch{return`https://nft.xrpl-labs.com/${e.profile.avatar_nft}`}return null}catch(s){return console.error("Failed to fetch avatar:",s),null}}async connectToServer(){const t="ws://localhost:8080";this.pongClient=new T(t);try{await this.pongClient.connect(),this.setupEventHandlers();const s=c.getWalletAddress()||"guest_"+Date.now(),e=await this.fetchPlayerAvatar(s);console.log("üñºÔ∏è Fetched avatar URL:",e);const n={wallet:s,displayName:c.getCurrentUserDisplayName(),avatarUrl:e||void 0};this.pongClient.joinQueue(n)}catch(s){console.error("Failed to connect to server:",s),this.showConnectionError()}}setupEventHandlers(){this.pongClient&&(this.pongClient.on("queue_joined",t=>{this.queuePositionText&&this.queuePositionText.setText(`Queue position: ${t}`)}),this.pongClient.on("match_found",t=>{console.log("Match found!",t),console.log("üéÆ Opponent data:",t.opponent),console.log("üñºÔ∏è Opponent avatar URL:",t.opponent?.avatarUrl),this.statusText&&this.statusText.setText("Match Found!"),this.loadingTimer&&(this.loadingTimer.destroy(),this.loadingTimer=null),this.time.delayedCall(1e3,()=>{this.startGame(t.opponent,t.yourSide)})}),this.pongClient.on("connection_failed",()=>{this.showConnectionError()}),this.pongClient.on("error",t=>{console.error("Server error:",t),this.showError(t)}))}startGame(t,s){this.scene.start("PongGameScene",{pongClient:this.pongClient,opponent:t,yourSide:s})}cancelMatchmaking(){this.pongClient&&(this.pongClient.leave(),this.pongClient.disconnect()),this.loadingTimer&&this.loadingTimer.destroy(),this.add.text(this.cameras.main.width/2,this.cameras.main.height/2,"Matchmaking Cancelled",{fontSize:"32px",color:"#ffffff"}).setOrigin(.5),this.time.delayedCall(2e3,()=>{window.location.href="/"})}showConnectionError(){this.statusText&&(this.statusText.setText("Failed to connect to server"),this.statusText.setColor("#ff6b6b")),this.queuePositionText&&this.queuePositionText.setText("Please try again later"),this.loadingTimer&&(this.loadingTimer.destroy(),this.loadingTimer=null)}showError(t){this.queuePositionText&&(this.queuePositionText.setText(`Error: ${t}`),this.queuePositionText.setColor("#ff6b6b"))}}const o={CANVAS_WIDTH:1280,CANVAS_HEIGHT:720,PADDLE_WIDTH:20,PADDLE_HEIGHT:120,BALL_SIZE:20,PADDLE_SPEED:10,WINNING_SCORE:3};class y extends r.GameObjects.Container{paddleRect;avatarCircle=null;avatarImage=null;htmlAvatar=null;ringImage=null;constructor(t,s,e,n=16777215,i,a,l){super(t,s,e),this.paddleRect=t.add.rectangle(0,0,o.PADDLE_WIDTH,o.PADDLE_HEIGHT,n),this.add(this.paddleRect),i&&this.createAvatar(i,a,l),t.add.existing(this)}createAvatar(t,s,e){const n=o.PADDLE_HEIGHT/2*.5;this.avatarCircle=this.scene.add.arc(0,0,n,0,360,!1,4886754,.3),this.add(this.avatarCircle),s&&s.trim()!==""?this.loadAvatar(s,n):this.showPlaceholder(t),e?.ring&&e.ring.image_url&&this.loadCosmeticRing(e.ring.image_url,e.ring.is_animated),this.avatarCircle&&this.avatarCircle.setAlpha(.6)}loadAvatar(t,s){const e=t.toLowerCase().includes("ipfs.io")||t.toLowerCase().includes("ipfs://"),n=t.toLowerCase().includes(".gif"),i=t.toLowerCase().includes("giphy");if(e||n||i)this.loadAnimatedAvatar(t);else{const a=`avatar_${Date.now()}_${Math.random()}`;this.scene.load.image(a,t),this.scene.load.once("complete",()=>{this.displayAvatar(a,s)}),this.scene.load.start()}}loadAnimatedAvatar(t){const s=o.PADDLE_HEIGHT*.5;this.htmlAvatar=document.createElement("img"),this.htmlAvatar.src=t,this.htmlAvatar.style.position="absolute",this.htmlAvatar.style.width=`${s}px`,this.htmlAvatar.style.height=`${s}px`,this.htmlAvatar.style.borderRadius="50%",this.htmlAvatar.style.objectFit="cover",this.htmlAvatar.style.pointerEvents="none",this.htmlAvatar.style.zIndex="10",this.htmlAvatar.style.opacity="0.6",document.body.appendChild(this.htmlAvatar),this.updateHtmlAvatarPosition()}displayAvatar(t,s){if(this.scene.textures.exists(t)){this.avatarImage=this.scene.add.image(0,0,t);const n=o.PADDLE_HEIGHT*.5/Math.max(this.avatarImage.width,this.avatarImage.height);this.avatarImage.setScale(n);const i=this.scene.make.graphics({});i.fillStyle(16777215);const a=new r.Geom.Circle(0,0,s);i.fillCircleShape(a),i.setPosition(this.x,this.y),this.avatarImage.setMask(i.createGeometryMask()),this.avatarImage.setAlpha(.6),this.add(this.avatarImage)}}showPlaceholder(t){const s=t.trim().split(" ");let e=s[0]?.charAt(0).toUpperCase()||"?";s.length>1&&(e+=s[1].charAt(0).toUpperCase());const n=this.scene.add.text(0,0,e,{fontSize:"20px",color:"#ffffff",fontStyle:"bold"});n.setOrigin(.5),n.setAlpha(.6),this.add(n)}loadCosmeticRing(t,s){const e=t.startsWith("http")?t:`/cosmetics/${t}`,n=`ring_${Date.now()}_${Math.random()}`;this.scene.load.svg(n,e),this.scene.load.once("complete",()=>{if(this.scene.textures.exists(n)){this.ringImage=this.scene.add.image(0,0,n);const a=o.PADDLE_HEIGHT*.5*1.3/Math.max(this.ringImage.width,this.ringImage.height);this.ringImage.setScale(a),this.ringImage.setAlpha(.6),this.add(this.ringImage),s&&this.scene.tweens.add({targets:this.ringImage,angle:360,duration:3e3,repeat:-1,ease:"Linear"})}}),this.scene.load.start()}updateHtmlAvatarPosition(){if(!this.htmlAvatar)return;const s=this.scene.game.canvas.getBoundingClientRect(),e=o.PADDLE_HEIGHT*.5,n=s.left+window.scrollX+this.x-e/2,i=s.top+window.scrollY+this.y-e/2;this.htmlAvatar.style.left=`${n}px`,this.htmlAvatar.style.top=`${i}px`}updatePosition(t){this.y=r.Math.Clamp(t,o.PADDLE_HEIGHT/2,o.CANVAS_HEIGHT-o.PADDLE_HEIGHT/2),this.updateHtmlAvatarPosition()}update(){this.updateHtmlAvatarPosition()}getTop(){return this.y-o.PADDLE_HEIGHT/2}getBottom(){return this.y+o.PADDLE_HEIGHT/2}destroy(t){this.htmlAvatar&&this.htmlAvatar.parentElement&&(this.htmlAvatar.parentElement.removeChild(this.htmlAvatar),this.htmlAvatar=null),super.destroy(t)}}class P extends r.GameObjects.Arc{constructor(t,s,e){super(t,s,e,o.BALL_SIZE/2,0,360,!1,16777215),t.add.existing(this)}updatePosition(t,s){this.setPosition(t,s)}addTrailEffect(){const t=this.scene.add.arc(this.x,this.y,o.BALL_SIZE/2,0,360,!1,16777215,.3);this.scene.tweens.add({targets:t,alpha:0,duration:200,onComplete:()=>{t.destroy()}})}}class S extends r.GameObjects.Container{bannerImage=null;bannerBackground=null;constructor(t,s,e,n,i){const a=s==="left"?o.CANVAS_WIDTH/4:o.CANVAS_WIDTH*3/4;super(t,a,80),t.add.existing(this);const h=300,p=100;if(i?.banner&&i.banner.image_url){let u=0;if(i.banner.css_gradient){const w=i.banner.css_gradient.match(/#([0-9a-f]{6})/i);w&&(u=parseInt(w[1],16))}this.bannerBackground=t.add.rectangle(0,0,h,p,u,.4),this.add(this.bannerBackground),this.loadBannerImage(i.banner.image_url,h,p)}else this.bannerBackground=t.add.rectangle(0,0,h,p,0,.3),this.add(this.bannerBackground);n&&n.trim()!==""?this.loadAvatar(n):this.showPlaceholderAvatar(e);const g=t.add.text(50,0,e,{fontSize:"20px",color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3});g.setOrigin(0,.5),this.add(g),this.setAlpha(.85)}loadBannerImage(t,s,e){const n=t.startsWith("http")?t:`/cosmetics/${t}`,i=`banner_${Date.now()}_${Math.random()}`;this.scene.load.svg(i,n,{width:s,height:e}),this.scene.load.once("complete",()=>{this.scene.textures.exists(i)&&(this.bannerImage=this.scene.add.image(0,0,i),this.bannerImage.setAlpha(.6),this.addAt(this.bannerImage,0),console.log(`‚ú® Loaded banner: ${t}`))}),this.scene.load.start()}loadAvatar(t){const s=`banner_avatar_${Date.now()}_${Math.random()}`,e=60;this.scene.load.image(s,t),this.scene.load.once("complete",()=>{if(this.scene.textures.exists(s)){const n=this.scene.add.image(-120,0,s),i=e/Math.max(n.width,n.height);n.setScale(i);const a=this.scene.make.graphics({});a.fillStyle(16777215),a.fillCircle(this.x-120,this.y,e/2),n.setMask(a.createGeometryMask());const l=this.scene.add.arc(-120,0,e/2,0,360,!1,16692481,1);l.setStrokeStyle(3,16692481),this.add(l),this.add(n)}}),this.scene.load.start()}showPlaceholderAvatar(t){const e=this.scene.add.arc(-120,0,30,0,360,!1,4886754,1),n=t.trim().split(" ");let i=n[0]?.charAt(0).toUpperCase()||"?";n.length>1&&(i+=n[1].charAt(0).toUpperCase());const a=this.scene.add.text(-120,0,i,{fontSize:"24px",color:"#ffffff",fontStyle:"bold"});a.setOrigin(.5);const l=this.scene.add.arc(-120,0,60/2,0,360,!1);l.setStrokeStyle(3,16692481),this.add(e),this.add(a),this.add(l)}show(){this.setAlpha(0),this.scene.tweens.add({targets:this,alpha:.85,duration:500,ease:"Power2"})}hide(){this.scene.tweens.add({targets:this,alpha:0,duration:300,ease:"Power2"})}}class C extends r.Scene{pongClient=null;opponent=null;yourSide="left";leftPaddle=null;rightPaddle=null;ball=null;leftBanner=null;rightBanner=null;countdownText=null;centerLine=null;cursors=null;wasd=null;touchStartY=0;paddleTargetY=o.CANVAS_HEIGHT/2;constructor(){super({key:"PongGameScene"})}init(t){this.pongClient=t.pongClient,this.opponent=t.opponent,this.yourSide=t.yourSide}create(){const{width:t,height:s}=this.cameras.main;this.add.rectangle(0,0,t,s,0).setOrigin(0);const e=8;this.add.rectangle(0,0,t,e,16692481).setOrigin(0),this.add.rectangle(0,s-e,t,e,16692481).setOrigin(0),this.drawCenterLine();const n=50+o.PADDLE_WIDTH/2,i=t-50-o.PADDLE_WIDTH/2,a=this.pongClient?.getPlayerData(),l=c.getCurrentUserDisplayName(),h=a?.avatarUrl,p=a?.equippedCosmetics;this.yourSide==="left"?(this.leftPaddle=new y(this,n,s/2,6819033,l,h,p),this.rightPaddle=new y(this,i,s/2,503304,this.opponent?.displayName,this.opponent?.avatarUrl,this.opponent?.equippedCosmetics)):(this.leftPaddle=new y(this,n,s/2,6819033,this.opponent?.displayName,this.opponent?.avatarUrl,this.opponent?.equippedCosmetics),this.rightPaddle=new y(this,i,s/2,503304,l,h,p)),this.ball=new P(this,t/2,s/2),this.createPlayerBanners(),this.countdownText=this.add.text(t/2,s/2-100,"",{fontSize:"128px",color:"#ffffff",fontStyle:"bold"}),this.countdownText.setOrigin(.5),this.setupInput(),this.setupServerHandlers(),this.scene.launch("PongUIScene")}drawCenterLine(){this.centerLine=this.add.graphics(),this.centerLine.lineStyle(2,4473924);const t=20,s=15,e=this.cameras.main.width/2;for(let n=0;n<this.cameras.main.height;n+=t+s)this.centerLine.lineBetween(e,n,e,n+t)}createPlayerBanners(){const t=this.pongClient?.getPlayerData(),s=t?.equippedCosmetics,e=t?.avatarUrl;this.yourSide==="left"?(this.leftBanner=new S(this,"left",c.getCurrentUserDisplayName(),e,s),this.rightBanner=new S(this,"right",this.opponent?.displayName||"Opponent",this.opponent?.avatarUrl,this.opponent?.equippedCosmetics)):(this.leftBanner=new S(this,"left",this.opponent?.displayName||"Opponent",this.opponent?.avatarUrl,this.opponent?.equippedCosmetics),this.rightBanner=new S(this,"right",c.getCurrentUserDisplayName(),e,s)),this.leftBanner?.show(),this.rightBanner?.show()}setupInput(){this.cursors=this.input.keyboard?.createCursorKeys()||null,this.wasd=this.input.keyboard?.addKeys({up:r.Input.Keyboard.KeyCodes.W,down:r.Input.Keyboard.KeyCodes.S}),this.input.on("pointerdown",t=>{const s=t.x<this.cameras.main.width/2;(this.yourSide==="left"&&s||this.yourSide==="right"&&!s)&&(this.paddleTargetY=t.y)}),this.input.on("pointermove",t=>{const s=t.x<this.cameras.main.width/2,e=this.yourSide==="left"&&s||this.yourSide==="right"&&!s;t.isDown&&e&&(this.paddleTargetY=t.y)}),this.input.on("pointerup",()=>{})}setupServerHandlers(){this.pongClient&&(this.pongClient.on("countdown",t=>{this.countdownText&&(t>0?(this.countdownText.setText(t.toString()),this.tweens.add({targets:this.countdownText,scale:{from:2,to:1},alpha:{from:1,to:.5},duration:1e3,ease:"Power2"})):(this.countdownText.setText("GO!"),this.tweens.add({targets:this.countdownText,alpha:0,duration:500,delay:500,onComplete:()=>{this.countdownText?.destroy(),this.countdownText=null}})))}),this.pongClient.on("game_state",t=>{this.updateGameState(t);const s=this.scene.get("PongUIScene");s&&s.updateScore&&s.updateScore(t.score1,t.score2)}),this.pongClient.on("game_over",t=>{this.handleGameOver(t.winner,t.finalScore)}),this.pongClient.on("opponent_disconnected",()=>{this.handleOpponentDisconnect()}))}updateGameState(t){this.ball&&(this.ball.updatePosition(t.ballX,t.ballY),Math.random()<.3&&this.ball.addTrailEffect()),this.leftPaddle&&this.leftPaddle.updatePosition(t.paddle1Y),this.rightPaddle&&this.rightPaddle.updatePosition(t.paddle2Y)}update(){this.handlePaddleInput(),this.leftPaddle?.update(),this.rightPaddle?.update()}handlePaddleInput(){if(!this.pongClient)return;let t=this.paddleTargetY;this.cursors?.up.isDown||this.wasd?.up.isDown?t-=o.PADDLE_SPEED:(this.cursors?.down.isDown||this.wasd?.down.isDown)&&(t+=o.PADDLE_SPEED),t=r.Math.Clamp(t,o.PADDLE_HEIGHT/2,o.CANVAS_HEIGHT-o.PADDLE_HEIGHT/2),this.paddleTargetY=t,this.pongClient.movePaddle(t)}handleGameOver(t,s){console.log("Game over!",t,s);const e=t===this.yourSide;this.scene.stop("PongUIScene"),this.scene.start("PongGameOverScene",{didWin:e,yourScore:this.yourSide==="left"?s.left:s.right,opponentScore:this.yourSide==="left"?s.right:s.left,opponent:this.opponent,pongClient:this.pongClient})}handleOpponentDisconnect(){console.log("Opponent disconnected"),this.add.text(this.cameras.main.width/2,this.cameras.main.height/2,`Opponent Disconnected

You Win by Default!`,{fontSize:"32px",color:"#ffffff",align:"center"}).setOrigin(.5),this.time.delayedCall(3e3,()=>{this.yourSide==="left"?this.leftPaddle?.getTop():this.rightPaddle?.getTop(),this.handleGameOver(this.yourSide,{left:this.yourSide==="left"?o.WINNING_SCORE:0,right:this.yourSide==="right"?o.WINNING_SCORE:0})})}}class _ extends r.Scene{leftScoreText=null;rightScoreText=null;winningScoreText=null;constructor(){super({key:"PongUIScene"})}create(){const{width:t,height:s}=this.cameras.main;this.leftScoreText=this.add.text(t/4,80,"0",{fontSize:"96px",color:"#4a90e2",fontStyle:"bold"}),this.leftScoreText.setOrigin(.5),this.leftScoreText.setAlpha(.6),this.rightScoreText=this.add.text(t*3/4,80,"0",{fontSize:"96px",color:"#ff6b6b",fontStyle:"bold"}),this.rightScoreText.setOrigin(.5),this.rightScoreText.setAlpha(.6),this.winningScoreText=this.add.text(t/2,30,`First to ${o.WINNING_SCORE}`,{fontSize:"16px",color:"#888888"}),this.winningScoreText.setOrigin(.5),this.add.text(t/2,s-20,"ESC to quit",{fontSize:"14px",color:"#666666"}).setOrigin(.5),this.input.keyboard?.on("keydown-ESC",()=>{this.quitGame()})}updateScore(t,s){this.leftScoreText&&(this.leftScoreText.setText(t.toString()),parseInt(this.leftScoreText.text)!==t&&this.tweens.add({targets:this.leftScoreText,scale:{from:1.2,to:1},duration:300,ease:"Back.out"})),this.rightScoreText&&(this.rightScoreText.setText(s.toString()),parseInt(this.rightScoreText.text)!==s&&this.tweens.add({targets:this.rightScoreText,scale:{from:1.2,to:1},duration:300,ease:"Back.out"}))}quitGame(){const t=this.add.text(this.cameras.main.width/2,this.cameras.main.height/2,`Are you sure you want to quit?

Press ESC again to confirm`,{fontSize:"24px",color:"#ffffff",align:"center",backgroundColor:"#000000",padding:{x:20,y:20}});t.setOrigin(.5);const s=this.input.keyboard?.addKey(r.Input.Keyboard.KeyCodes.ESC),e=()=>{this.scene.stop("PongGameScene"),this.scene.stop("PongUIScene"),window.location.href="/"};s?.once("down",e),this.time.delayedCall(3e3,()=>{t.destroy(),s?.off("down",e)})}}class E extends r.Scene{didWin=!1;yourScore=0;opponentScore=0;opponent=null;pongClient=null;leaderboard=[];constructor(){super({key:"PongGameOverScene"})}init(t){this.didWin=t.didWin,this.yourScore=t.yourScore,this.opponentScore=t.opponentScore,this.opponent=t.opponent,this.pongClient=t.pongClient}async create(){const{width:t,height:s}=this.cameras.main;this.add.rectangle(0,0,t,s,0,.95).setOrigin(0);const e=this.add.text(t/2,150,this.didWin?"VICTORY!":"DEFEAT",{fontSize:"72px",color:this.didWin?"#4ade80":"#ff6b6b",fontStyle:"bold"});e.setOrigin(.5),this.tweens.add({targets:e,scale:{from:0,to:1},alpha:{from:0,to:1},duration:500,ease:"Back.out"});const n=this.add.container(t/2,280),i=this.add.text(0,0,`You: ${this.yourScore}  -  ${this.opponent?.displayName||"Opponent"}: ${this.opponentScore}`,{fontSize:"32px",color:"#ffffff"});i.setOrigin(.5),n.add(i),await this.submitResult(),this.displayStats(t/2,380),await this.loadAndDisplayLeaderboard(t/2,550),this.createButtons(t/2,s-150)}async submitResult(){try{this.didWin?(await c.submitWin({opponent:this.opponent?.displayName,your_score:this.yourScore,opponent_score:this.opponentScore}),console.log("‚úÖ Win submitted to BEARpark")):(await c.submitLoss({opponent:this.opponent?.displayName,your_score:this.yourScore,opponent_score:this.opponentScore}),console.log("‚úÖ Loss submitted to BEARpark"))}catch(t){console.error("‚ùå Error submitting result:",t)}}displayStats(t,s){const e=c.getLocalStats(),n=this.add.container(t,s),i=this.add.text(0,0,"Your Stats",{fontSize:"24px",color:"#4a90e2",fontStyle:"bold"});i.setOrigin(.5),n.add(i);const a=this.add.text(0,40,`Wins: ${e.wins}  |  Losses: ${e.losses}  |  Win Rate: ${(e.winRate*100).toFixed(1)}%`,{fontSize:"18px",color:"#ffffff"});a.setOrigin(.5),n.add(a),n.setAlpha(0),this.tweens.add({targets:n,alpha:1,duration:500,delay:300})}async loadAndDisplayLeaderboard(t,s){const e=this.add.container(t,s),n=this.add.text(0,0,"Top Players",{fontSize:"24px",color:"#4a90e2",fontStyle:"bold"});n.setOrigin(.5),e.add(n);const i=this.add.text(0,40,"Loading...",{fontSize:"16px",color:"#888888"});i.setOrigin(.5),e.add(i);try{if(this.leaderboard=await c.getLeaderboard(5),i.destroy(),this.leaderboard.length>0)this.leaderboard.forEach((a,l)=>{const h=c.formatDisplayName(a),p=a.score||a.metadata?.wins||0,g=a.metadata?.losses||0,u=this.add.text(0,40+l*30,`${l+1}. ${h} - ${p}W ${g}L`,{fontSize:"16px",color:"#ffffff"});u.setOrigin(.5),e.add(u)});else{const a=this.add.text(0,40,"No leaderboard data yet",{fontSize:"16px",color:"#888888"});a.setOrigin(.5),e.add(a)}}catch(a){i.setText("Failed to load leaderboard"),console.error("Error loading leaderboard:",a)}e.setAlpha(0),this.tweens.add({targets:e,alpha:1,duration:500,delay:600})}createButtons(t,s){const e=this.add.text(t,s,"[ Play Again ]",{fontSize:"24px",color:"#4ade80"});e.setOrigin(.5),e.setInteractive({useHandCursor:!0}),e.on("pointerover",()=>{e.setScale(1.1)}),e.on("pointerout",()=>{e.setScale(1)}),e.on("pointerdown",()=>{this.playAgain()});const n=this.add.text(t,s+60,"[ Main Menu ]",{fontSize:"20px",color:"#888888"});n.setOrigin(.5),n.setInteractive({useHandCursor:!0}),n.on("pointerover",()=>{n.setScale(1.1),n.setColor("#ffffff")}),n.on("pointerout",()=>{n.setScale(1),n.setColor("#888888")}),n.on("pointerdown",()=>{this.returnToMenu()}),e.setAlpha(0),n.setAlpha(0),this.tweens.add({targets:[e,n],alpha:1,duration:500,delay:900})}playAgain(){this.pongClient&&this.pongClient.disconnect(),this.scene.start("PongLobbyScene")}returnToMenu(){this.pongClient&&this.pongClient.disconnect(),window.location.href="/"}}const D={type:r.AUTO,width:1280,height:720,parent:"game-container",backgroundColor:"#000000",scale:{mode:r.Scale.FIT,autoCenter:r.Scale.CENTER_BOTH},scene:[v,C,_,E],physics:{default:"arcade",arcade:{debug:!1,fps:60}}},I=new r.Game(D);I.scene.start("PongLobbyScene");console.log("üéÆ BEAR PONG initialized");console.log("üîå Server URL:","ws://localhost:8080");
