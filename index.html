<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BEAR Park — Wallet Authentication</title>
  <meta name="description" content="Connect your XAMAN wallet to access BEAR Park" />
  <meta name="theme-color" content="#edb723" />
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet" />

  <style>
  :root{
    --gold:#edb723;
    --gold-ink:#231b04;
    --charcoal:#141619;
    --accent:#d75c46;
    --purple:#7a2f8e;
    --green:#2d8e3f;
    --stripe-purple: #680cd9;
    --stripe-yellow: #feb501;
    --stripe-green: #07ae08;
    --tri-gradient: linear-gradient(to right, var(--stripe-purple) 0%, var(--stripe-purple) 33.33%, var(--stripe-yellow) 33.33%, var(--stripe-yellow) 66.66%, var(--stripe-green) 66.66%, var(--stripe-green) 100%);
  }

  *{box-sizing:border-box}
  html,body{margin:0;padding:0;min-height:100vh;background:var(--charcoal);color:#fff}

  body{
    font-family:"Luckiest Guy","Arial Black",Impact,system-ui,sans-serif;
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
    overflow-x:hidden;
  }

  /* Side color bars - purple, green, yellow */
  body::after {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 60px;
    background: linear-gradient(to bottom,
      var(--purple) 0%, var(--purple) 33.33%,
      var(--green) 33.33%, var(--green) 66.66%,
      var(--gold) 66.66%, var(--gold) 100%);
    z-index: 999;
    pointer-events: none;
  }

  body::before {
    content: "";
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    width: 60px;
    background: linear-gradient(to bottom,
      var(--purple) 0%, var(--purple) 33.33%,
      var(--green) 33.33%, var(--green) 66.66%,
      var(--gold) 66.66%, var(--gold) 100%);
    z-index: 999;
    pointer-events: none;
  }

  .gate-container{
    max-width:600px;
    width:90%;
    padding:40px;
    background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    border:4px solid rgba(255,255,255,.08);
    border-radius:20px;
    box-shadow:0 18px 40px rgba(0,0,0,.5);
    text-align:center;
    position:relative;
    z-index:1;
  }

  .logo{
    width:120px;
    height:120px;
    margin:0 auto 20px;
    filter:drop-shadow(0 8px 0 rgba(0,0,0,.4));
  }

  h1{
    font-size:clamp(36px,6vw,64px);
    margin:0 0 10px;
    color:var(--gold);
    text-shadow:0 4px 0 rgba(0,0,0,.35);
    line-height:1.1;
  }

  p{
    font-size:18px;
    line-height:1.4;
    margin:0 0 30px;
    color:rgba(255,255,255,.9);
  }

  .requirements{
    text-align:left;
    background:rgba(0,0,0,.3);
    border:3px solid rgba(237,183,35,.3);
    border-radius:12px;
    padding:20px;
    margin:20px 0;
  }

  .requirements h3{
    margin:0 0 12px;
    color:var(--gold);
    font-size:20px;
  }

  .requirements ul{
    margin:0;
    padding-left:25px;
    font-size:16px;
    line-height:1.8;
  }

  .requirements li{
    color:rgba(255,255,255,.85);
  }

  .btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:.6rem;
    font:900 22px/1 "Luckiest Guy","Arial Black",Impact,system-ui,sans-serif;
    border-radius:22px;
    padding:18px 32px;
    color:#fff;
    background:var(--accent);
  border:4px solid transparent;
  border-image: var(--tri-gradient) 1;
    box-shadow:0 10px 0 #7b2a20, 0 18px 24px rgba(0,0,0,.35);
    cursor:pointer;
    transition:transform .12s ease, filter .2s ease;
    text-decoration:none;
  }

  .btn:hover{
    filter:brightness(1.06);
  }

  .btn:active{
    transform:translateY(4px);
    box-shadow:0 6px 0 #7b2a20, 0 10px 16px rgba(0,0,0,.35);
  }

  .btn:disabled{
    opacity:.5;
    cursor:not-allowed;
  }

  .btn.gold{
    background:var(--gold);
    color:#000;
    box-shadow:0 10px 0 #9b7a0d,0 18px 24px rgba(0,0,0,.35);
  }

  .btn.gold:active{
    box-shadow:0 6px 0 #9b7a0d,0 10px 16px rgba(0,0,0,.35);
  }

  .status{
    margin:20px 0;
    padding:16px;
    border-radius:12px;
    font-size:16px;
    display:none;
  }

  .status.show{
    display:block;
  }

  .status.loading{
    background:rgba(118,174,255,.15);
    border:2px solid rgba(118,174,255,.3);
    color:#76aeff;
  }

  .status.error{
    background:rgba(215,92,70,.15);
    border:2px solid rgba(215,92,70,.3);
    color:#ff8a75;
  }

  .status.success{
    background:rgba(45,142,63,.15);
    border:2px solid rgba(45,142,63,.3);
    color:#4eff6e;
  }

  .spinner{
    display:inline-block;
    width:16px;
    height:16px;
    border:3px solid rgba(255,255,255,.3);
    border-top-color:#fff;
    border-radius:50%;
    animation:spin 1s linear infinite;
    margin-right:8px;
    vertical-align:middle;
  }

  @keyframes spin{
    to{transform:rotate(360deg)}
  }

  .verification-list{
    list-style:none;
    padding:0;
    margin:20px 0;
  }

  .verification-list li{
    padding:12px;
    margin:8px 0;
    background:rgba(0,0,0,.3);
    border-radius:8px;
    border-left:4px solid #555;
    font-size:15px;
  }

  .verification-list li.checking{
    border-left-color:#76aeff;
    color:#76aeff;
  }

  .verification-list li.passed{
    border-left-color:#4eff6e;
    color:#4eff6e;
  }

  .verification-list li.failed{
    border-left-color:#ff8a75;
    color:#ff8a75;
  }

  @media (max-width:640px){
    body::before, body::after{
      width:30px;
    }
    .gate-container{
      padding:30px 20px;
    }
  }
  </style>
</head>
<body>
  <div class="gate-container">
    <img class="logo" src="https://files.catbox.moe/25ekkd.png" alt="BEAR Park logo" width="120" height="120">
    <h1>BEAR PARK</h1>
    <p>Connect your wallet to access BEAR Park</p>

    <div class="requirements">
      <h3>Access Requirements (need at least 1):</h3>
      <ul>
        <li>10,000 $BEAR tokens</li>
        <li>1 Ultra Rare BEAR NFT</li>
        <li>1 Pixel BEAR NFT</li>
      </ul>
    </div>

    <div style="display: flex; flex-direction: column; gap: 16px; margin-bottom: 20px;">
      <button id="connectXamanBtn" class="btn gold">
        Connect XAMAN Wallet
      </button>

      <button id="connectJoeyBtn" class="btn" style="background: #8b5cf6; box-shadow: 0 10px 0 #5b21b6, 0 18px 24px rgba(0,0,0,.35);">
        Connect Joey Wallet
      </button>
    </div>

    <div id="status" class="status"></div>

    <ul id="verificationList" class="verification-list" style="display:none"></ul>
  </div>

  <!-- XRP Ledger JS Library -->
  <script src="https://unpkg.com/xrpl@3.0.0/build/xrpl-latest-min.js"></script>

  <!-- QR Code Generator -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script type="module">
  import SignClient from 'https://esm.sh/@walletconnect/sign-client@2.11.0';

  // Make SignClient available globally
  window.WalletConnectSignClient = SignClient;
  </script>

  <script>
  (async function(){
    // Configuration
    const BEAR_ISSUER = 'rBEARGUAsyu7tUw53rufQzFdWmJHpJEqFW';
    const BEAR_CURRENCY = '4245415200000000000000000000000000000000'; // BEAR in hex
    const MIN_BEAR_BALANCE = 10000;

    // NFT issuer - Both Ultra Rare and Pixel BEAR collections use the same issuer
    const NFT_ISSUER = 'rBEARbo4Prn33894evmvYcAf9yAQjp4VJF'; // BearXRPL2

    // WalletConnect Configuration
    const WC_PROJECT_ID = 'da711418529df39d15cc68772619e270';

    const connectXamanBtn = document.getElementById('connectXamanBtn');
    const connectJoeyBtn = document.getElementById('connectJoeyBtn');
    const statusEl = document.getElementById('status');
    const verificationList = document.getElementById('verificationList');

    // WalletConnect client
    let wcClient = null;
    let wcSession = null;

    // Wait for WalletConnect module to load
    while(!window.WalletConnectSignClient){
      await new Promise(resolve => setTimeout(resolve, 100));
    }

    // Check if already authenticated
    const isAuthenticated = sessionStorage.getItem('bearpark_auth');
    if(isAuthenticated === 'true'){
      window.location.href = 'main.html';
      return;
    }

    function showStatus(message, type){
      statusEl.textContent = message;
      statusEl.className = 'status show ' + type;
    }

    function addVerificationItem(text, status = 'checking'){
      const li = document.createElement('li');
      li.className = status;
      li.textContent = text;
      verificationList.appendChild(li);
      verificationList.style.display = 'block';
      return li;
    }

    function updateVerificationItem(item, text, status){
      item.textContent = text;
      item.className = status;
    }

    async function checkWalletRequirements(walletAddress){
      try{
        showStatus('Verifying wallet holdings...', 'loading');
        verificationList.innerHTML = '';

        // Connect to XRP Ledger with fallback nodes
        const xrplNodes = [
          'wss://xrplcluster.com',
          'wss://s1.ripple.com',
          'wss://s2.ripple.com'
        ];

        let client = null;
        let lastError = null;

        for (const node of xrplNodes) {
          try {
            console.log(`Attempting to connect to ${node}...`);
            client = new xrpl.Client(node);
            await client.connect();
            console.log(`✓ Connected to ${node}`);
            break;
          } catch (err) {
            console.warn(`Failed to connect to ${node}:`, err.message);
            lastError = err;
            if (client) {
              try { await client.disconnect(); } catch(e) {}
            }
            client = null;
          }
        }

        if (!client) {
          throw new Error('Unable to connect to XRPL. Please check your internet connection and try again.');
        }

        // Check 1: $BEAR Token Balance (with pagination support)
        const tokenItem = addVerificationItem('Checking $BEAR token balance...');
        let hasTokens = false;

        try{
          // Collect ALL trustlines from wallet (handle pagination)
          let allLines = [];
          let marker = undefined;
          let pageCount = 0;
          const maxPages = 10;

          do {
            const linesRequest = {
              command: 'account_lines',
              account: walletAddress,
              ledger_index: 'validated',
              limit: 400
            };

            if (marker) {
              linesRequest.marker = marker;
            }

            const accountLines = await client.request(linesRequest);

            if (accountLines.result.lines && accountLines.result.lines.length > 0) {
              allLines = allLines.concat(accountLines.result.lines);
            }

            marker = accountLines.result.marker;
            pageCount++;

          } while (marker && pageCount < maxPages);

          console.log(`Total trustlines found: ${allLines.length}`);

          const bearLine = allLines.find(line =>
            line.account === BEAR_ISSUER &&
            line.currency === BEAR_CURRENCY
          );

          if(bearLine && parseFloat(bearLine.balance) >= MIN_BEAR_BALANCE){
            hasTokens = true;
            updateVerificationItem(tokenItem,
              `✓ $BEAR tokens: ${parseFloat(bearLine.balance).toLocaleString()} (Verified!)`,
              'passed'
            );
          } else {
            const balance = bearLine ? parseFloat(bearLine.balance).toLocaleString() : '0';
            updateVerificationItem(tokenItem,
              `✗ $BEAR tokens: ${balance} (Need 10,000)`,
              'failed'
            );
          }
        }catch(err){
          console.error('Token check error:', err);
          updateVerificationItem(tokenItem, '✗ Error checking $BEAR tokens', 'failed');
        }

        // Check 2: NFTs (with pagination support)
        const nftItem = addVerificationItem('Checking NFT ownership...');
        let hasNFT = false;

        try{
          // Collect ALL NFTs from wallet (handle pagination)
          let allNFTs = [];
          let marker = undefined;
          let pageCount = 0;
          const maxPages = 10; // Safety limit to prevent infinite loops

          console.log('Fetching all NFTs from wallet (with pagination)...');

          do {
            const nftRequest = {
              method: 'account_nfts',
              account: walletAddress,
              ledger_index: 'validated',
              limit: 400 // Request maximum per page
            };

            if (marker) {
              nftRequest.marker = marker;
            }

            const nfts = await client.request(nftRequest);

            if (nfts.result.account_nfts && nfts.result.account_nfts.length > 0) {
              allNFTs = allNFTs.concat(nfts.result.account_nfts);
              console.log(`Page ${pageCount + 1}: Found ${nfts.result.account_nfts.length} NFTs`);
            }

            marker = nfts.result.marker;
            pageCount++;

          } while (marker && pageCount < maxPages);

          console.log(`Total NFTs found across ${pageCount} page(s): ${allNFTs.length}`);

          if(allNFTs.length > 0){
            // Log first NFT structure for debugging
            console.log('Sample NFT structure:', allNFTs[0]);

            // Log all NFT issuers for debugging
            const uniqueIssuers = [...new Set(allNFTs.map(nft => nft.Issuer))];
            console.log('Unique NFT Issuers in wallet:', uniqueIssuers);
            console.log('Looking for issuer:', NFT_ISSUER);

            // Check for BEAR NFTs (Ultra Rare or Pixel BEAR collections)
            const bearNFTs = allNFTs.filter(nft =>
              nft.Issuer === NFT_ISSUER
            );

            console.log('BEAR NFTs found:', bearNFTs.length);

            if(bearNFTs.length > 0){
              hasNFT = true;
              updateVerificationItem(nftItem,
                `✓ BEAR NFT(s) found: ${bearNFTs.length} (Verified!)`,
                'passed'
              );
            } else {
              // Show helpful debug info
              updateVerificationItem(nftItem,
                `✗ No BEAR NFTs found. Found ${allNFTs.length} NFT(s), but none from BEAR collection. Check console (F12) for details.`,
                'failed'
              );
            }
          } else {
            updateVerificationItem(nftItem, '✗ No NFTs found in wallet', 'failed');
          }
        }catch(err){
          console.error('NFT check error:', err);
          updateVerificationItem(nftItem, '✗ Error checking NFTs: ' + err.message, 'failed');
        }

        await client.disconnect();

        // Grant access if any requirement is met
        if(hasTokens || hasNFT){
          showStatus('✓ Access granted! Redirecting...', 'success');
          sessionStorage.setItem('bearpark_auth', 'true');
          sessionStorage.setItem('bearpark_wallet', walletAddress);

          // SYNC TO LOCALSTORAGE FOR GAME INTEGRATION
          localStorage.setItem('xaman_wallet_address', walletAddress);

          // Fetch user profile to get display name and Twitter username
          try {
            const profileResponse = await fetch(`/api/profile/${walletAddress}`);
            if (profileResponse.ok) {
              const profileData = await profileResponse.json();
              if (profileData.display_name) {
                localStorage.setItem('display_name', profileData.display_name);
              }
            }

            // Fetch user points data to get Twitter username
            const pointsResponse = await fetch(`/api/points/${walletAddress}`);
            if (pointsResponse.ok) {
              const pointsData = await pointsResponse.json();
              if (pointsData.user?.twitter_username) {
                localStorage.setItem('twitter_username', pointsData.user.twitter_username);
              }
            }
          } catch (err) {
            console.log('Could not fetch user profile data:', err);
          }

          setTimeout(() => {
            window.location.href = 'main.html';
          }, 2000);
          return true;
        } else {
          showStatus('Access denied: Wallet does not meet requirements', 'error');
          return false;
        }

      }catch(error){
        console.error('Verification error:', error);
        showStatus('Error verifying wallet: ' + error.message, 'error');
        return false;
      }
    }

    // XAMAN API Integration via Production Backend
    const PROXY_API_URL = 'https://api.bearpark.xyz/api/xaman';

    async function createXAMANPayload(){
      const response = await fetch(`${PROXY_API_URL}/payload`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      if(!response.ok){
        const error = await response.json();
        throw new Error(error.error || 'Failed to create XAMAN payload');
      }

      return await response.json();
    }

    async function getPayloadStatus(payloadUuid){
      const response = await fetch(`${PROXY_API_URL}/payload/${payloadUuid}`);

      if(!response.ok){
        const error = await response.json();
        throw new Error(error.error || 'Failed to get payload status');
      }

      return await response.json();
    }

    // Initialize WalletConnect
    async function initWalletConnect(){
      if(wcClient) return wcClient;

      try{
        const SignClient = window.WalletConnectSignClient;
        if(!SignClient){
          throw new Error('WalletConnect SignClient not loaded');
        }

        wcClient = await SignClient.init({
          projectId: WC_PROJECT_ID,
          metadata: {
            name: 'BEAR Park',
            description: 'BEAR Park - XRPL Community Hub',
            url: 'https://bearpark.xyz',
            icons: ['https://files.catbox.moe/25ekkd.png']
          }
        });
        return wcClient;
      }catch(error){
        console.error('WalletConnect init error:', error);
        throw error;
      }
    }

    // Joey Wallet Connection via WalletConnect
    connectJoeyBtn.addEventListener('click', async () => {
      try{
        connectJoeyBtn.disabled = true;
        showStatus('Initializing WalletConnect...', 'loading');

        const client = await initWalletConnect();

        const { uri, approval } = await client.connect({
          requiredNamespaces: {
            xrpl: {
              methods: ['xrpl_signTransaction'],
              chains: ['xrpl:0'],  // Mainnet
              events: []
            }
          }
        });

        if(uri){
          showStatus('Scan QR code with Joey Wallet', 'loading');

          // Generate QR code
          const qrContainer = document.createElement('div');

          qrContainer.innerHTML = `<p style="font-size: 16px; margin: 10px 0;">Connect with Joey Wallet:</p>
                             <div style="margin: 20px auto; padding: 20px; background: white; border-radius: 12px; max-width: 300px; display: inline-block;">
                               <div id="joeyQR"></div>
                             </div>
                             <a id="openJoeyBtn" href="${uri}" style="display: inline-block; margin: 15px auto; padding: 12px 24px; background: #8b5cf6; color: white; border: 3px solid transparent; border-image: var(--tri-gradient) 1; border-radius: 12px; font-family: 'Luckiest Guy', Arial; font-size: 16px; cursor: pointer; box-shadow: 0 6px 0 #5b21b6; text-decoration: none;">Open Joey Wallet</a>
                             <p style="font-size: 14px; margin: 15px 0; color: #999; font-family: Arial, sans-serif;">Scan the QR code OR click "Open Joey Wallet" to connect automatically</p>
                             <p style="font-size: 13px; margin: 20px 0; color: #999; font-family: Arial, sans-serif;">Note: If Joey Wallet isn't opening or scanning properly, please try XAMAN wallet instead for a more reliable connection.</p>`;

          statusEl.innerHTML = '';
          statusEl.appendChild(qrContainer);
          statusEl.className = 'status show loading';

          // Generate QR code using QRCode.js
          setTimeout(() => {
            new QRCode(document.getElementById('joeyQR'), {
              text: uri,
              width: 250,
              height: 250
            });
          }, 100);

          // Wait for approval
          const session = await approval();
          wcSession = session;

          // Get wallet address from session
          const accounts = session.namespaces.xrpl?.accounts || [];
          if(accounts.length > 0){
            // Format: "xrpl:0:rXXXXXXXX"
            const walletAddress = accounts[0].split(':')[2];
            showStatus('Joey Wallet connected! Verifying requirements...', 'success');
            await checkWalletRequirements(walletAddress);
          } else {
            throw new Error('No accounts found in session');
          }
        } else {
          throw new Error('Failed to generate WalletConnect URI');
        }

      }catch(error){
        console.error('Joey wallet connection error:', error);
        showStatus('Error connecting Joey wallet: ' + error.message, 'error');
        connectJoeyBtn.disabled = false;
      }
    });

    // Wallet Connection via XAMAN
    connectXamanBtn.addEventListener('click', async () => {
      try{
        connectXamanBtn.disabled = true;
        showStatus('Creating XAMAN sign request...', 'loading');

        // Create sign-in payload
        const payload = await createXAMANPayload();

        if(payload && payload.refs){
          // Update status with QR code
          showStatus('Open XAMAN app to sign in', 'loading');

          // Create clickable link and show QR
          const qrImg = document.createElement('img');
          qrImg.src = payload.refs.qr_png;
          qrImg.style.maxWidth = '250px';
          qrImg.style.margin = '10px auto';
          qrImg.style.display = 'block';
          qrImg.style.border = '4px solid #edb723';
          qrImg.style.borderRadius = '12px';

          statusEl.innerHTML = '';
          statusEl.appendChild(qrImg);

          const linkText = document.createElement('p');
          linkText.innerHTML = `<a href="${payload.next.always}" target="_blank" style="color: #edb723; text-decoration: underline;">Or click here to open XAMAN</a>`;
          statusEl.appendChild(linkText);
          statusEl.className = 'status show loading';

          // Poll for result
          let attempts = 0;
          const maxAttempts = 60; // 5 minutes max

          const pollInterval = setInterval(async () => {
            attempts++;

            if(attempts > maxAttempts){
              clearInterval(pollInterval);
              showStatus('Sign request timed out', 'error');
              connectXamanBtn.disabled = false;
              return;
            }

            try{
              const status = await getPayloadStatus(payload.uuid);

              if(status.meta && status.meta.resolved){
                clearInterval(pollInterval);

                if(status.meta.signed){
                  const walletAddress = status.response.account;
                  showStatus('Wallet connected! Verifying requirements...', 'success');
                  await checkWalletRequirements(walletAddress);
                } else {
                  showStatus('Sign request was rejected', 'error');
                  connectXamanBtn.disabled = false;
                }
              }
            }catch(err){
              console.error('Polling error:', err);
            }
          }, 5000); // Poll every 5 seconds

        } else {
          throw new Error('Invalid payload response');
        }

      }catch(error){
        console.error('XAMAN connection error:', error);
        console.error('Error details:', {
          message: error.message,
          stack: error.stack,
          type: error.constructor.name
        });
        showStatus('Error: ' + error.message + ' - Check console (F12) for details', 'error');
        connectXamanBtn.disabled = false;

        // Fallback for testing
        setTimeout(() => {
          const address = prompt('XAMAN unavailable. Enter wallet address for testing:');
          if(address && address.startsWith('r')){
            checkWalletRequirements(address);
          } else {
            connectXamanBtn.disabled = false;
          }
        }, 1000);
      }
    });

  })();
  </script>
</body>
</html>
